<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loading...</title>
  <script>
    // Load app configuration from server
    document.title = 'Loading...';
    fetch('/api/config')
      .then(res => res.json())
      .then(config => {
        document.title = `${config.appName} Dashboard - Webaloka`;
        // Store config globally for other scripts to use
        window.appConfig = config;
      })
      .catch(err => {
        console.error('Failed to load app config:', err);
        document.title = 'CRM Dashboard - Webaloka';
      });
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script>
    window.tailwind = {
      config: {
        theme: {
          extend: {
            fontFamily: {
              sans: ['"Space Grotesk"', 'ui-sans-serif', 'system-ui']
            }
          }
        }
      }
    };
  </script>
  <link rel="stylesheet" href="css/output.css">

</head>
<body>
  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    ☰
  </button>

  <!-- Theme Toggle -->
  <button class="theme-toggle" id="themeToggle" title="Toggle theme">
    <span class="moon-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>
    </span>
    <span class="sun-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>
    </span>
    <span class="theme-text">Dark Mode</span>
  </button>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <!-- Sidebar Collapse Button -->
    <button class="sidebar-collapse" id="sidebarCollapse" title="Toggle sidebar">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </button>

    <div class="sidebar-header">
      <h1>
        <div class="logo-icon">W</div>
        Alhikmah CRM
      </h1>
    </div>

    <nav class="nav-menu">
      <div class="nav-section">
        <div class="nav-section-title">Main</div>
        <a href="#dashboard" class="nav-item active" data-view="dashboard">
          <span class="icon">📊</span>
          <span>Dashboard</span>
        </a>
        <a href="#sessions" class="nav-item" data-view="sessions">
          <span class="icon">📱</span>
          <span>Sessions</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Messaging</div>
        <a href="#chat" class="nav-item" data-view="chat">
          <span class="icon">💬</span>
          <span>Chat</span>
        </a>
        <a href="#groups" class="nav-item" data-view="groups">
          <span class="icon">👥</span>
          <span>Groups</span>
          <span class="badge" id="groupsUnreadBadge" style="display: none;">0</span>
        </a>
        <a href="#send-message" class="nav-item" data-view="send-message">
          <span class="icon">📤</span>
          <span>Send Message</span>
        </a>
        <a href="#broadcast" class="nav-item" data-view="broadcast">
          <span class="icon">📢</span>
          <span>Broadcast</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">CRM</div>
        <a href="#contacts" class="nav-item" data-view="contacts">
          <span class="icon">👥</span>
          <span>Contacts</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Monitoring</div>
        <a href="#jobs" class="nav-item" data-view="jobs">
          <span class="icon">📋</span>
          <span>Broadcast Jobs</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Account</div>
        <div id="userInfoDisplay" style="padding: 8px 12px; font-size: 12px; color: var(--muted); display: none;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="font-size: 16px;">👤</span>
            <div style="flex: 1; min-width: 0;">
              <div style="font-weight: 600; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="sidebarUserName">User</div>
              <div style="font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" id="sidebarUserEmail">user@example.com</div>
            </div>
          </div>
        </div>
        <a href="#" class="nav-item" id="logoutBtn">
          <span class="icon">🚪</span>
          <span>Logout</span>
        </a>
      </div>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Dashboard View -->
    <div id="view-dashboard" class="view active">
      <div class="page-header">
        <h2 class="page-title">Dashboard</h2>
        <p class="page-subtitle">Overview of your WhatsApp sessions and activities</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">📱</div>
          <div class="stat-content">
            <div class="stat-label">Total Sessions</div>
            <div class="stat-value" id="stat-total-sessions">0</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">✅</div>
          <div class="stat-content">
            <div class="stat-label">Connected</div>
            <div class="stat-value" id="stat-connected">0</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">📋</div>
          <div class="stat-content">
            <div class="stat-label">Active Jobs</div>
            <div class="stat-value" id="stat-active-jobs">0</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">✉️</div>
          <div class="stat-content">
            <div class="stat-label">Messages Sent</div>
            <div class="stat-value" id="stat-messages-sent">0</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 class="card-title">📊 Session Status Overview</h3>
        <div id="dashboard-sessions">Loading...</div>
      </div>
    </div>

    <!-- Sessions View -->
    <div id="view-sessions" class="view">
      <div class="page-header">
        <h2 class="page-title">Sessions</h2>
        <p class="page-subtitle">Manage your WhatsApp sessions</p>
      </div>

      <!-- Create Session Card -->
      <div class="card">
        <h3 class="card-title">➕ Create New Session</h3>
        <div class="btn-group" style="margin-bottom: 16px;">
          <input id="newSessionId" placeholder="Enter session ID (e.g., personal, work)" style="flex: 1; max-width: 300px;">
          <button id="createSessionBtn">Create Session</button>
        </div>
        <div class="log" id="sessionCreateLog"></div>
      </div>

      <!-- Sessions List -->
      <div class="card">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
          <h3 class="card-title" style="margin: 0;">📱 All Sessions</h3>
          <div style="display: flex; gap: 8px;">
            <input id="sessionSearch" placeholder="Search sessions..." style="padding: 8px 12px; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); color: var(--text);">
            <button id="refreshSessionsBtn" class="btn-ghost" style="padding: 8px 16px;">🔄 Refresh</button>
          </div>
        </div>
        <div id="sessions-list">Loading sessions...</div>
      </div>
    </div>

    <!-- Session Detail View -->
    <div id="view-session-detail" class="view">
      <div class="page-header">
        <h2 class="page-title">Session: <span id="session-detail-name">-</span></h2>
        <p class="page-subtitle">Manage this WhatsApp session</p>
      </div>

      <div class="card">
        <h3 class="card-title">📊 Connection Status</h3>
        <div style="margin-bottom: 16px;">
          <span class="status-badge" id="session-status-badge">
            <span class="status-dot" id="session-status-dot"></span>
            <span id="session-status-text">Loading...</span>
          </span>
          <span class="status-badge" style="margin-left: 8px;" id="session-user-badge">User: -</span>
        </div>

        <div class="qr-box">
          <canvas id="qrCanvas"></canvas>
          <div id="qrPlaceholder" style="color: var(--muted);">QR code will appear here when needed</div>
        </div>

        <div class="btn-group">
          <button id="logoutSessionBtn" class="btn-danger">Logout Whatsapp Session</button>
          <button id="deleteSessionBtn" class="btn-ghost">Remove Session</button>
        </div>

        <div class="log" id="sessionActionLog" style="margin-top: 16px;"></div>
      </div>
    </div>

    <!-- Send Message View -->
    <div id="view-send-message" class="view">
      <div class="page-header">
        <h2 class="page-title">Send Message</h2>
        <p class="page-subtitle">Send a message to a single WhatsApp number</p>
      </div>

      <div class="session-selector">
        <label>Active Session:</label>
        <div class="session-selector-row">
          <select id="sendSessionSelect"></select>
        </div>
      </div>

      <div class="card">
        <form id="sendForm">
          <div class="form-group">
            <label for="sendNumber">Phone Number</label>
            <input type="text" id="sendNumber" placeholder="62812xxxxxxx (include country code, digits only)" required>
            <small style="color: var(--muted); display: block; margin-top: 4px;">Format: Country code + number (e.g., 628123456789)</small>
          </div>

          <div class="form-group">
            <label for="sendMessage">Message</label>
            <textarea id="sendMessage" placeholder="Type your message here..." required></textarea>
          </div>

          <button type="submit">Send Message</button>
        </form>

        <div class="log" id="sendResult" style="margin-top: 16px;"></div>
      </div>
    </div>

    <!-- Broadcast View -->
    <div id="view-broadcast" class="view">
      <div class="page-header">
        <h2 class="page-title">Broadcast Message</h2>
        <p class="page-subtitle">Send messages to multiple numbers</p>
      </div>

      <div class="session-selector mb-6">
        <label class="block text-sm font-medium text-slate-300 mb-2">Active Session</label>
        <div class="session-selector-row">
          <select id="broadcastSessionSelect"></select>
        </div>
      </div>

      <div class="grid gap-6 lg:grid-cols-3">
        <!-- Left Column: Main Form -->
        <div class="lg:col-span-2 space-y-6">
          <!-- Recipients Card -->
          <div class="card">
            <div class="flex items-center justify-between mb-4">
              <h3 class="card-title flex items-center gap-2">
                <span class="text-xl">👥</span>
                <span>Recipients</span>
              </h3>
              <div class="text-sm text-slate-400">
                <span id="recipientCount">0</span> contacts
              </div>
            </div>

            <!-- Input Method Toggle -->
            <div class="mb-4">
              <label class="block text-xs font-medium text-slate-300 mb-2">Input Method</label>
              <div class="flex gap-2 p-1 bg-slate-800/30 rounded-lg">
                <button type="button" id="methodManual" class="flex-1 rounded-md px-4 py-2 text-sm font-medium transition bg-cyan-500/20 text-cyan-200">
                  📝 Manual
                </button>
                <button type="button" id="methodCsv" class="flex-1 rounded-md px-4 py-2 text-sm font-medium text-slate-400 hover:text-slate-200 transition">
                  📁 CSV Upload
                </button>
              </div>
            </div>

            <!-- Manual Input -->
            <div id="manualInput">
              <div class="form-group mb-0">
                <label for="broadcastNumbers" class="flex items-center justify-between">
                  <span>Phone Numbers</span>
                  <span class="text-xs text-slate-500">One number per line</span>
                </label>
                <textarea id="broadcastNumbers" rows="8" placeholder="6281234567890&#10;6289876543210&#10;6285555555555" class="resize-none font-mono text-sm"></textarea>
              </div>
            </div>

            <!-- CSV Input -->
            <div id="csvInput" style="display: none;">
              <div class="border-2 border-dashed border-slate-700 rounded-xl p-6 text-center hover:border-slate-600 transition">
                <input type="file" id="csvFile" accept=".csv" class="hidden">
                <div class="mb-4">
                  <span class="text-4xl">📁</span>
                </div>
                <p class="text-sm text-slate-300 mb-2">Drag & drop CSV file or click to browse</p>
                <p class="text-xs text-slate-500 mb-4">Required: <strong>phone</strong> column (with country code)</p>
                <div class="flex gap-2 justify-center">
                  <button type="button" id="downloadTemplate" class="btn-ghost text-sm">📥 Template</button>
                  <button type="button" id="browseCsv" class="btn-primary text-sm">Browse File</button>
                </div>
              </div>
              <div id="csvFileInfo" class="mt-3 hidden p-3 rounded-lg bg-emerald-500/10 border border-emerald-500/20">
                <div class="flex items-center gap-2 text-sm text-emerald-200">
                  <span>✓</span>
                  <span id="csvFileName">file.csv</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Message Card -->
          <div class="card">
            <h3 class="card-title flex items-center gap-2">
              <span class="text-xl">💬</span>
              <span>Message</span>
            </h3>
            <div class="form-group mb-4">
              <textarea id="broadcastMessage" rows="6" placeholder="Type your broadcast message here...&#10;&#10;Tip: Use {name} to personalize messages"></textarea>
            </div>
            <div id="personalizationHelper" class="p-3 rounded-lg bg-cyan-500/10 border border-cyan-500/20">
              <div class="flex items-start gap-2 text-sm">
                <span>💡</span>
                <div>
                  <strong class="text-cyan-200">Personalization Available</strong>
                  <p class="text-cyan-200/70 text-xs mt-1">Use <code class="px-1 py-0.5 rounded bg-black/20">{name}</code> in your message to mention recipient's name</p>
                </div>
              </div>
            </div>
          </div>

          <!-- CSV Preview (when uploaded) -->
          <div id="csvPreview" class="card hidden">
            <div class="flex items-center justify-between mb-4">
              <h3 class="card-title flex items-center gap-2">
                <span class="text-xl">👁️</span>
                <span>Preview Data</span>
              </h3>
              <span class="text-sm text-slate-400"><span id="previewCount">0</span> contacts</span>
            </div>
            <div class="table-wrap max-h-64">
              <table class="table-basic">
                <thead>
                  <tr class="table-head-row">
                    <th class="table-cell w-12">#</th>
                    <th class="table-cell">Phone</th>
                    <th class="table-cell">Name</th>
                  </tr>
                </thead>
                <tbody id="previewBody"></tbody>
              </table>
            </div>
            <div id="csvStats" class="mt-3 text-xs text-slate-400"></div>
          </div>
        </div>

        <!-- Right Column: Settings -->
        <div class="space-y-6">
          <!-- Speed Settings -->
          <div class="card">
            <h3 class="card-title flex items-center gap-2 mb-4">
              <span class="text-xl">⚡</span>
              <span>Speed Settings</span>
            </h3>

            <div class="form-group mb-4">
              <label for="broadcastPreset" class="block text-xs font-medium text-slate-300 mb-2">Preset</label>
              <select id="broadcastPreset">
                <option value="moderate">🟡 Moderate</option>
                <option value="conservative">🟢 Conservative</option>
                <option value="very-conservative">🔒 Very Conservative</option>
                <option value="custom">⚙️ Custom</option>
              </select>
            </div>

            <div id="presetDescription" class="p-3 rounded-lg bg-amber-500/10 border border-amber-500/20 text-sm mb-4">
              <p class="font-medium text-amber-200 mb-1">🟡 Moderate Mode</p>
              <ul class="text-xs text-amber-200/70 space-y-1">
                <li>• Speed: 3-8 seconds/message</li>
                <li>• Cooldown every 30 messages</li>
                <li>• Best for: 50-200 numbers</li>
              </ul>
            </div>

            <!-- Advanced Toggle -->
            <button type="button" id="toggleAdvanced" class="w-full flex items-center justify-between px-3 py-2 rounded-lg bg-slate-800/50 hover:bg-slate-800 transition text-sm text-slate-300">
              <span>Advanced Settings</span>
              <svg class="w-4 h-4 transition-transform" id="advancedArrow" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </button>

            <!-- Advanced Settings (collapsible) -->
            <div id="advancedSettings" class="hidden mt-4 space-y-3 pt-4 border-t border-slate-800">
              <div>
                <label class="block text-xs text-slate-400 mb-1">Min Delay</label>
                <div class="flex items-center gap-2">
                  <input type="number" id="delayMin" value="3000" min="0" class="flex-1">
                  <span class="text-xs text-slate-500">ms</span>
                </div>
              </div>
              <div>
                <label class="block text-xs text-slate-400 mb-1">Max Delay</label>
                <div class="flex items-center gap-2">
                  <input type="number" id="delayMax" value="8000" min="0" class="flex-1">
                  <span class="text-xs text-slate-500">ms</span>
                </div>
              </div>
              <div>
                <label class="block text-xs text-slate-400 mb-1">Cooldown After</label>
                <div class="flex items-center gap-2">
                  <input type="number" id="cooldownAfter" value="30" min="0" class="flex-1">
                  <span class="text-xs text-slate-500">msgs</span>
                </div>
              </div>
              <div>
                <label class="block text-xs text-slate-400 mb-1">Cooldown Min</label>
                <div class="flex items-center gap-2">
                  <input type="number" id="cooldownMin" value="120000" min="0" disabled class="flex-1 opacity-50">
                  <span class="text-xs text-slate-500">ms</span>
                </div>
              </div>
              <div>
                <label class="block text-xs text-slate-400 mb-1">Cooldown Max</label>
                <div class="flex items-center gap-2">
                  <input type="number" id="cooldownMax" value="300000" min="0" disabled class="flex-1 opacity-50">
                  <span class="text-xs text-slate-500">ms</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Estimation Card -->
          <div class="card">
            <h3 class="card-title flex items-center gap-2">
              <span class="text-xl">⏱️</span>
              <span>Estimation</span>
            </h3>
            <div id="estimatedTime" class="p-4 rounded-lg bg-cyan-500/10 border border-cyan-500/20 text-center">
              <p class="text-xs text-slate-400 mb-1">Estimated Duration</p>
              <p class="text-lg font-semibold text-cyan-200" id="estimatedTimeValue">--</p>
              <p class="text-xs text-slate-500 mt-2" id="estimatedTimeSub">Add recipients to see estimate</p>
            </div>
            <div id="warningBanner" class="hidden mt-3 p-3 rounded-lg bg-amber-500/10 border border-amber-500/20">
              <p class="text-xs text-amber-200">⚠️ Large broadcasts may take time. Consider splitting into smaller batches.</p>
            </div>
          </div>

          <!-- Submit Button -->
          <form id="broadcastForm">
            <button type="submit" class="w-full btn-primary text-base font-semibold py-3 flex items-center justify-center gap-2">
              <span>🚀</span>
              <span>Start Broadcast</span>
            </button>
          </form>
        </div>
      </div>

      <!-- Result Log -->
      <div class="card mt-6">
        <h3 class="card-title">📋 Broadcast Log</h3>
        <div class="log" id="broadcastResult">
          <p class="text-slate-500 text-sm">Broadcast results will appear here...</p>
        </div>
      </div>
    </div>

    <!-- Broadcast Jobs View -->
    <div id="view-jobs" class="view">
      <div class="page-header">
        <h2 class="page-title">Broadcast Jobs</h2>
        <p class="page-subtitle">Monitor your broadcast jobs</p>
      </div>

      <div class="card">
        <h3 class="card-title">🔍 Filter Jobs</h3>
        <div class="auto-grid-200-tight mb-3">
          <div>
            <label>Filter Type</label>
            <select id="jobFilterType">
              <option value="all">All Jobs (All Sessions)</option>
              <option value="session">Specific Session</option>
            </select>
          </div>
          <div id="jobSessionFilter" style="display: none;">
            <label>Session</label>
            <select id="jobsSessionSelect"></select>
          </div>
          <div>
            <label>Start Date</label>
            <input type="date" id="jobStartDate">
          </div>
          <div>
            <label>End Date</label>
            <input type="date" id="jobEndDate">
          </div>
          <div>
            <label>Limit</label>
            <select id="jobLimit">
              <option value="50">Last 50</option>
              <option value="100" selected>Last 100</option>
              <option value="500">Last 500</option>
              <option value="">All</option>
            </select>
          </div>
        </div>
        <div class="btn-group">
          <button type="button" id="applyJobFilter" class="btn-ghost w-auto">Apply Filter</button>
          <button type="button" id="resetJobFilter" class="btn-ghost w-auto">Reset</button>
          <button type="button" id="refreshJobs" class="btn-ghost w-auto">🔄 Refresh</button>
        </div>
      </div>

      <div class="card">
        <h3 class="card-title">📋 Jobs (<span id="jobCount">0</span>)</h3>
        <div class="job-list" id="jobList">No jobs yet.</div>
      </div>
    </div>

    <!-- Job Detail View -->
    <div id="view-job-detail" class="view">
      <div class="page-header">
        <h2 class="page-title">Job Detail: <span id="jobDetailId">-</span></h2>
        <p class="page-subtitle">
          Status: <span id="jobDetailStatus" class="status-badge">-</span> |
          Phase: <span id="jobDetailPhase">-</span>
        </p>
      </div>

      <div class="card">
        <h3 class="card-title">📊 Job Statistics</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">✅</div>
            <div class="stat-content">
              <div class="stat-label">Sent</div>
              <div class="stat-value" id="jobDetailSent">0</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">⏭️</div>
            <div class="stat-content">
              <div class="stat-label">Skipped</div>
              <div class="stat-value" id="jobDetailSkipped">0</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">❌</div>
            <div class="stat-content">
              <div class="stat-label">Failed</div>
              <div class="stat-value" id="jobDetailFailed">0</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">📊</div>
            <div class="stat-content">
              <div class="stat-label">Total</div>
              <div class="stat-value" id="jobDetailTotal">0</div>
            </div>
          </div>
        </div>

        <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
          <button type="button" id="exportJobResults" class="btn-ghost">📥 Export Results (CSV)</button>
          <button type="button" id="backToJobs" class="btn-ghost">← Back to Jobs</button>
        </div>
      </div>

      <div class="card">
        <h3 class="card-title">📝 Detailed Results</h3>
        <div style="margin-bottom: 12px;">
          <input type="text" id="jobResultsFilter" placeholder="Filter by phone number..." style="max-width: 300px;">
        </div>
        <div class="job-list" id="jobResultsList" style="max-height: 500px;">
          Loading job details...
        </div>
      </div>
    </div>

    <!-- Chat View -->
    <div id="view-chat" class="view view-flex">
      <div class="chat-container">
        <!-- Contacts Sidebar -->
        <div class="chat-contacts-sidebar">
          <div class="chat-header">
            <div class="session-selector">
              <select id="chatSessionSelect">
                <option value="">Select Session...</option>
              </select>
            </div>
            <div class="search-box">
              <input type="text" id="chatSearchInput" placeholder="Search contacts...">
            </div>
            <div class="chat-filters">
              <div class="filter-row">
                <select id="chatStatusFilter" class="filter-select">
                  <option value="">All Statuses</option>
                </select>
              </div>
              <div class="filter-tags" id="chatTagsFilter">
                <!-- Tags will be rendered here -->
                <div class="filter-tags-placeholder">Loading tags...</div>
              </div>
              <button type="button" id="clearChatFilters" class="btn-sm" style="margin-top: 8px; width: 100%; display: none;">Clear Filters</button>
            </div>
          </div>
          <div class="contacts-list" id="chatContactsList">
            <div class="loading-contacts">Loading contacts...</div>
          </div>
        </div>

        <!-- Chat Window -->
        <div class="chat-window">
          <div id="chatWelcome" class="chat-welcome">
            <div class="welcome-icon">💬</div>
            <h3>Welcome to Chat</h3>
            <p>Select a contact to start messaging</p>
          </div>

          <div id="chatConversation" class="chat-conversation" style="display: none;">
            <!-- Chat Header -->
            <div class="chat-window-header">
              <div class="contact-info">
                <div class="contact-avatar" id="chatContactAvatar">?</div>
                <div class="contact-details">
                  <div class="contact-name" id="chatContactName">-</div>
                  <div class="contact-phone" id="chatContactPhone">-</div>
                </div>
              </div>
              <div class="chat-actions">
                <button class="btn-icon" id="viewContactBtn" title="View Contact Details">👤</button>
                <button class="btn-icon" id="refreshChatBtn" title="Sync Chat History">🔄</button>
              </div>
            </div>

            <!-- Messages Container -->
            <div class="messages-container" id="messagesContainer">
              <!-- Messages will be rendered here -->
            </div>

            <!-- Message Input -->
            <div class="message-input-area">
              <div class="crm-quick-actions" id="crmQuickActions">
                <button id="updateStatusBtn" class="btn-sm">📊 Status</button>
                <button id="addTagBtn" class="btn-sm">🏷️ Tag</button>
                <button id="addNoteBtn" class="btn-sm">📝 Note</button>
              </div>
              <div id="replyPreviewContainer"></div>
              <div class="message-input-wrapper">
                <button type="button" id="attachMediaBtn" class="btn-icon attach-media-btn" title="Attach image or video">📎</button>
                <textarea id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                <button type="button" id="sendMessageBtn" class="btn-send">➤</button>
              </div>
              <div class="selected-media-preview" id="selectedMediaPreview" style="display: none;">
                <div class="selected-media-chip">
                  <span id="selectedMediaLabel">media</span>
                  <button type="button" id="clearMediaBtn" class="btn-icon" title="Remove media">✕</button>
                </div>
              </div>
              <input type="file" id="mediaInput" accept="image/*,video/*" hidden>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Groups View -->
    <div id="view-groups" class="view view-flex">
      <div class="chat-container">
        <!-- Groups Sidebar -->
        <div class="chat-contacts-sidebar">
          <div class="chat-header">
            <div class="session-selector">
              <select id="groupsSessionSelect">
                <option value="">Select Session...</option>
              </select>
            </div>
            <div class="search-box">
              <input type="text" id="groupsSearchInput" placeholder="Search groups...">
            </div>
            <div class="chat-filters">
              <div class="filter-row">
                <select id="groupsCategoryFilter" class="filter-select">
                  <option value="">All Categories</option>
                  <option value="business">📱 Business</option>
                  <option value="internal">🏢 Internal</option>
                  <option value="personal">👤 Personal</option>
                </select>
              </div>
              <div class="category-tabs">
                <button class="category-tab active" data-category="all">💼 All (<span id="categoryCountAll">0</span>)</button>
                <button class="category-tab" data-category="business">💼 Business (<span id="categoryCountBusiness">0</span>)</button>
                <button class="category-tab" data-category="internal">👔 Internal (<span id="categoryCountInternal">0</span>)</button>
                <button class="category-tab" data-category="personal">🏠 Personal (<span id="categoryCountPersonal">0</span>)</button>
              </div>
            </div>
          </div>
          <div class="contacts-list" id="groupsList">
            <div class="loading-contacts">Loading groups...</div>
          </div>
        </div>

        <div class="chat-window">
          <div id="groupChatWelcome" class="chat-welcome">
            <div class="welcome-icon">👥</div>
            <h3>Welcome to Groups</h3>
            <p>Select a group to start messaging</p>
            <div class="quick-stats">
              <div class="stat-item">
                <span class="stat-value" id="totalGroupsCount">0</span>
                <span class="stat-label">Total Groups</span>
              </div>
              <div class="stat-item">
                <span class="stat-value" id="businessGroupsCount">0</span>
                <span class="stat-label">Business</span>
              </div>
              <div class="stat-item">
                <span class="stat-value" id="unreadGroupsCount">0</span>
                <span class="stat-label">Unread</span>
              </div>
            </div>
          </div>

          <div id="groupConversation" class="chat-conversation" style="display: none;">
            <div class="chat-window-header group-header">
              <div class="group-info">
                <div class="group-avatar" id="groupChatAvatar">👥</div>
                <div class="group-details">
                  <div class="group-name" id="groupChatName">-</div>
                  <div class="group-meta" id="groupChatMeta">Select a group to view info</div>
                </div>
              </div>
              <div class="chat-actions">
                <button class="btn-icon" id="refreshGroupChatBtn" title="Refresh group chat">🔄</button>
                <button class="btn-icon" id="viewParticipantsBtn" title="View Participants">👥</button>
              </div>
            </div>

            <div class="messages-container" id="groupMessagesContainer">
              <div class="loading-contacts">Select a group to load messages</div>
            </div>

            <div class="message-input-area">
              <div class="message-input-wrapper">
                <button type="button" id="attachGroupMediaBtn" class="btn-icon attach-media-btn" title="Attach image or video">📎</button>
                <textarea id="groupMessageInput" placeholder="Type a message to group..." rows="1"></textarea>
                <button type="button" id="sendGroupMessageBtn" class="btn-send">➤</button>
              </div>
              <div class="selected-media-preview" id="selectedGroupMediaPreview" style="display: none;">
                <div class="selected-media-chip">
                  <span id="selectedGroupMediaLabel">media</span>
                  <button type="button" id="clearGroupMediaBtn" class="btn-icon" title="Remove media">✕</button>
                </div>
              </div>
              <input type="file" id="groupMediaInput" accept="image/*,video/*" hidden>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contacts/CRM View -->
    <div id="view-contacts" class="view">
      <div class="page-header">
        <h2 class="page-title">Contacts & Leads</h2>
        <p class="page-subtitle">Manage your contacts and track leads</p>
      </div>

      <div class="crm-container">
        <!-- Filters Sidebar -->
        <div class="crm-filters-sidebar">
          <div class="filter-section">
            <h3>Filters</h3>
            <div class="session-filter">
              <label>Session</label>
              <select id="crmSessionSelect">
                <option value="">Select Session...</option>
              </select>
            </div>
            <div class="search-filter">
              <label>Search</label>
              <input type="text" id="crmSearchInput" placeholder="Name, phone...">
            </div>
            <div class="status-filter">
              <label>Lead Status</label>
              <select id="crmStatusFilter">
                <option value="">All Statuses</option>
              </select>
            </div>
            <div class="tags-filter">
              <label>Tags</label>
              <div id="crmTagsFilter" class="tags-checkboxes">
                <!-- Tag checkboxes will be rendered here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Contacts Grid -->
        <div class="crm-contacts-grid">
          <div class="crm-toolbar">
            <div class="contact-count" id="crmContactCount">0 contacts</div>
            <div class="sync-buttons">
              <button id="syncWhatsAppBtn" class="btn-ghost">📱 Sync WhatsApp</button>
            </div>
          </div>
          <div id="googleStatus" class="google-status" style="display: none;">
            <span id="googleConnectionStatus">✅ Connected to Google</span>
            <div class="sync-actions">
              <button id="syncGoogleBtn" class="btn-ghost btn-sm">📇 Sync</button>
              <button id="disconnectGoogleBtn" class="btn-ghost btn-sm">Disconnect</button>
            </div>
          </div>
          <div id="googleNotConnected" class="google-notice" style="display: none;">
            <span>📇 Google Contacts not connected</span>
            <button id="connectGoogleBtn" class="btn-sm btn-primary">Connect</button>
          </div>
          <div id="outlookStatus" class="google-status" style="display: none;">
            <span id="outlookConnectionStatus">✅ Connected to Outlook</span>
            <div class="sync-actions">
              <button id="syncOutlookBtn" class="btn-ghost btn-sm">📧 Sync</button>
              <button id="disconnectOutlookBtn" class="btn-ghost btn-sm">Disconnect</button>
            </div>
          </div>
          <div id="outlookNotConnected" class="google-notice" style="display: none;">
            <span>📧 Outlook not connected</span>
            <button id="connectOutlookBtn" class="btn-sm btn-primary">Connect</button>
          </div>
          <div class="contacts-cards mt-3" id="crmContactsCards">
            <div style="grid-column: 1/-1; text-align: center; color: var(--muted); padding: 40px;">
              Loading contacts...
            </div>
          </div>
          <div class="pagination" id="crmPagination" style="display: none;"></div>
        </div>
      </div>
    </div>

    <!-- Contact Detail Modal -->
    <div id="contactDetailModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Contact Details</h3>
          <button class="modal-close" id="closeContactModal">✕</button>
        </div>
        <div class="modal-body" id="contactDetailModalBody">
          <!-- Contact details will be rendered here -->
        </div>
      </div>
    </div>
  </main>

  <!-- Load modular JavaScript files -->
  <script src="js/state.js"></script>
  <script src="js/utils.js"></script>

  <!-- Authentication Check Script (Runs before other scripts) -->
  <script>
    (async function() {
      try {
        // Cek auth status
        const response = await fetch('/api/auth/check');
        const authData = await response.json();

        // Jika belum authenticated, redirect ke test login
        if (!authData.authenticated) {
          window.location.href = '/test-login';
          return;
        }

        // Jika sudah authenticated, lanjutkan load aplikasi
        console.log('✓ User authenticated:', authData.user);

        // Tampilkan user info di sidebar
        const userInfoDisplay = document.getElementById('userInfoDisplay');
        const sidebarUserName = document.getElementById('sidebarUserName');
        const sidebarUserEmail = document.getElementById('sidebarUserEmail');

        if (authData.user) {
          userInfoDisplay.style.display = 'block';
          sidebarUserName.textContent = authData.user.name || 'User';
          sidebarUserEmail.textContent = authData.user.email || 'user@example.com';
        }

      } catch (error) {
        console.error('Auth check failed:', error);
        // Jika gagal mengecek, redirect ke login untuk safety
        window.location.href = '/test-login';
      }
    })();

    // Logout handler
    document.getElementById('logoutBtn').addEventListener('click', async (e) => {
      e.preventDefault();

      if (!confirm('Are you sure you want to logout?')) {
        return;
      }

      try {
        // Call logout endpoint
        const response = await fetch('/test-logout');
        const data = await response.json();

        if (data.success) {
          // Redirect ke login page
          window.location.href = '/test-login';
        }
      } catch (error) {
        console.error('Logout failed:', error);
        // Redirect anyway untuk safety
        window.location.href = '/test-login';
      }
    });
  </script>

  <script src="js/navigation.js"></script>
  <script src="js/sessions.js"></script>
  <script src="js/jobs.js"></script>
  <script src="js/broadcast.js"></script>
  <script src="js/chat.js"></script>
  <script src="js/groups.js"></script>
  <script src="js/crm.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/app.js"></script>

  <script>
    const socket = io();
    
    // Update app name in the DOM once the config is loaded
    const updateAppName = setInterval(() => {
      if (window.appConfig && window.appConfig.appName) {
        const brandName = window.appConfig.appName;
        
        // Update sidebar header
        const sidebarHeader = document.querySelector('.sidebar-header h1');
        if (sidebarHeader) {
          sidebarHeader.innerHTML = `<div class="logo-icon">W</div>${brandName}`;
        }
        
        clearInterval(updateAppName);
      }
    }, 100);
  </script>
</body>
</html>
