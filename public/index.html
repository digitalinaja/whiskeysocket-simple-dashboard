<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alhikmah CRM Dashboard - Webaloka by Baileys 7.x.x</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    â˜°
  </button>

  <!-- Theme Toggle -->
  <button class="theme-toggle" id="themeToggle" title="Toggle theme">
    <span class="moon-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>
    </span>
    <span class="sun-icon">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="12" cy="12" r="5"></circle>
        <line x1="12" y1="1" x2="12" y2="3"></line>
        <line x1="12" y1="21" x2="12" y2="23"></line>
        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
        <line x1="1" y1="12" x2="3" y2="12"></line>
        <line x1="21" y1="12" x2="23" y2="12"></line>
        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
      </svg>
    </span>
    <span class="theme-text">Dark Mode</span>
  </button>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <!-- Sidebar Collapse Button -->
    <button class="sidebar-collapse" id="sidebarCollapse" title="Toggle sidebar">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </button>

    <div class="sidebar-header">
      <h1>
        <div class="logo-icon">W</div>
        Alhikmah CRM
      </h1>
    </div>

    <nav class="nav-menu">
      <div class="nav-section">
        <div class="nav-section-title">Main</div>
        <a href="#dashboard" class="nav-item active" data-view="dashboard">
          <span class="icon">ğŸ“Š</span>
          <span>Dashboard</span>
        </a>
        <a href="#sessions" class="nav-item" data-view="sessions">
          <span class="icon">ğŸ“±</span>
          <span>Sessions</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Messaging</div>
        <a href="#chat" class="nav-item" data-view="chat">
          <span class="icon">ğŸ’¬</span>
          <span>Chat</span>
        </a>
        <a href="#send-message" class="nav-item" data-view="send-message">
          <span class="icon">ğŸ“¤</span>
          <span>Send Message</span>
        </a>
        <a href="#broadcast" class="nav-item" data-view="broadcast">
          <span class="icon">ğŸ“¢</span>
          <span>Broadcast</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">CRM</div>
        <a href="#contacts" class="nav-item" data-view="contacts">
          <span class="icon">ğŸ‘¥</span>
          <span>Contacts</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Monitoring</div>
        <a href="#jobs" class="nav-item" data-view="jobs">
          <span class="icon">ğŸ“‹</span>
          <span>Broadcast Jobs</span>
        </a>
      </div>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Dashboard View -->
    <div id="view-dashboard" class="view active">
      <div class="page-header">
        <h2 class="page-title">Dashboard</h2>
        <p class="page-subtitle">Overview of your WhatsApp sessions and activities</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">ğŸ“±</div>
          <div class="stat-content">
            <div class="stat-label">Total Sessions</div>
            <div class="stat-value" id="stat-total-sessions">0</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">âœ…</div>
          <div class="stat-content">
            <div class="stat-label">Connected</div>
            <div class="stat-value" id="stat-connected">0</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">ğŸ“‹</div>
          <div class="stat-content">
            <div class="stat-label">Active Jobs</div>
            <div class="stat-value" id="stat-active-jobs">0</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">âœ‰ï¸</div>
          <div class="stat-content">
            <div class="stat-label">Messages Sent</div>
            <div class="stat-value" id="stat-messages-sent">0</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 class="card-title">ğŸ“Š Session Status Overview</h3>
        <div id="dashboard-sessions">Loading...</div>
      </div>
    </div>

    <!-- Sessions View -->
    <div id="view-sessions" class="view">
      <div class="page-header">
        <h2 class="page-title">Sessions</h2>
        <p class="page-subtitle">Manage your WhatsApp sessions</p>
      </div>

      <div class="card">
        <h3 class="card-title">â• Create New Session</h3>
        <div class="btn-group" style="margin-bottom: 16px;">
          <input id="newSessionId" placeholder="Enter session ID (e.g., personal, work)" style="flex: 1; max-width: 300px;">
          <button id="createSessionBtn">Create Session</button>
        </div>
        <div class="log" id="sessionCreateLog"></div>
      </div>

      <div class="card">
        <h3 class="card-title">ğŸ“± All Sessions</h3>
        <div id="sessions-list">Loading sessions...</div>
      </div>
    </div>

    <!-- Session Detail View -->
    <div id="view-session-detail" class="view">
      <div class="page-header">
        <h2 class="page-title">Session: <span id="session-detail-name">-</span></h2>
        <p class="page-subtitle">Manage this WhatsApp session</p>
      </div>

      <div class="card">
        <h3 class="card-title">ğŸ“Š Connection Status</h3>
        <div style="margin-bottom: 16px;">
          <span class="status-badge" id="session-status-badge">
            <span class="status-dot" id="session-status-dot"></span>
            <span id="session-status-text">Loading...</span>
          </span>
          <span class="status-badge" style="margin-left: 8px;" id="session-user-badge">User: -</span>
        </div>

        <div class="qr-box">
          <canvas id="qrCanvas"></canvas>
          <div id="qrPlaceholder" style="color: var(--muted);">QR code will appear here when needed</div>
        </div>

        <div class="btn-group">
          <button id="logoutBtn" class="btn-danger">Logout Session</button>
          <button id="deleteSessionBtn" class="btn-ghost">Remove Session</button>
        </div>

        <div class="log" id="sessionActionLog" style="margin-top: 16px;"></div>
      </div>
    </div>

    <!-- Send Message View -->
    <div id="view-send-message" class="view">
      <div class="page-header">
        <h2 class="page-title">Send Message</h2>
        <p class="page-subtitle">Send a message to a single WhatsApp number</p>
      </div>

      <div class="session-selector">
        <label>Active Session:</label>
        <div class="session-selector-row">
          <select id="sendSessionSelect"></select>
        </div>
      </div>

      <div class="card">
        <form id="sendForm">
          <div class="form-group">
            <label for="sendNumber">Phone Number</label>
            <input type="text" id="sendNumber" placeholder="62812xxxxxxx (include country code, digits only)" required>
            <small style="color: var(--muted); display: block; margin-top: 4px;">Format: Country code + number (e.g., 628123456789)</small>
          </div>

          <div class="form-group">
            <label for="sendMessage">Message</label>
            <textarea id="sendMessage" placeholder="Type your message here..." required></textarea>
          </div>

          <button type="submit">Send Message</button>
        </form>

        <div class="log" id="sendResult" style="margin-top: 16px;"></div>
      </div>
    </div>

    <!-- Broadcast View -->
    <div id="view-broadcast" class="view">
      <div class="page-header">
        <h2 class="page-title">Broadcast Message</h2>
        <p class="page-subtitle">Send messages to multiple numbers</p>
      </div>

      <div class="session-selector">
        <label>Active Session:</label>
        <div class="session-selector-row">
          <select id="broadcastSessionSelect"></select>
        </div>
      </div>

      <div class="card">
        <form id="broadcastForm">
          <div class="form-group">
            <label for="broadcastPreset">Speed Preset</label>
            <select id="broadcastPreset">
              <option value="moderate">ğŸŸ¡ Moderate - Broadcast 50-200 nomor</option>
              <option value="conservative">ğŸŸ¢ Conservative - Broadcast 200-1000 nomor</option>
              <option value="very-conservative">ğŸ”’ Very Conservative - Nomor penting / >1000 nomor</option>
              <option value="custom">âš™ï¸ Custom - Konfigurasi manual</option>
            </select>
            <small id="presetDescription" style="color: var(--muted); display: block; margin-top: 4px;">
              Simulasi behavior manusia natural. Speed: 3-8 detik/pesan. Cooldown setiap 30 pesan. Risiko: Medium.
            </small>
          </div>

          <div class="form-group">
            <label>Input Method</label>
            <div class="btn-group">
              <button type="button" id="methodManual" style="flex:1;">ğŸ“ Manual Input</button>
              <button type="button" id="methodCsv" style="flex:1;">ğŸ“ Upload CSV</button>
            </div>
          </div>

          <div id="manualInput">
            <div class="form-group">
              <label for="broadcastNumbers">Phone Numbers (one per line)</label>
              <textarea id="broadcastNumbers" placeholder="6281234567890&#10;6289876543210&#10;6285555555555"></textarea>
              <small style="color: var(--muted); display: block; margin-top: 4px;">Format: Country code + number, one per line</small>
            </div>
          </div>

          <div id="csvInput" style="display: none;">
            <div class="form-group">
              <label for="csvFile">Upload CSV File</label>
              <input type="file" id="csvFile" accept=".csv" style="padding: 8px;">
              <div style="display: flex; gap: 8px; margin-top: 8px;">
                <button type="button" id="downloadTemplate" class="btn-ghost" style="flex: 1;">ğŸ“¥ Download Template</button>
                <button type="button" id="previewCsv" class="btn-ghost" style="flex: 1;">ğŸ‘ï¸ Preview Data</button>
              </div>
              <small style="color: var(--muted); display: block; margin-top: 4px;">
                CSV harus punya kolom: <strong>phone</strong> (wajib), <strong>name</strong> (opsional untuk personalisasi)
              </small>
            </div>

            <div id="csvPreview" style="display: none;">
              <label>Preview Data (<span id="previewCount">0</span> contacts)</label>
              <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px; background: rgba(0,0,0,0.2);">
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                  <thead>
                    <tr style="border-bottom: 1px solid var(--border);">
                      <th style="text-align: left; padding: 8px;">#</th>
                      <th style="text-align: left; padding: 8px;">Phone</th>
                      <th style="text-align: left; padding: 8px;">Name</th>
                    </tr>
                  </thead>
                  <tbody id="previewBody"></tbody>
                </table>
              </div>
              <div id="csvStats" style="margin-top: 8px; font-size: 13px; color: var(--muted);"></div>
            </div>
          </div>

          <div class="form-group">
            <label for="broadcastMessage">Message</label>
            <textarea id="broadcastMessage" placeholder="Type your broadcast message here... Gunakan {name} untuk personalisasi." required></textarea>
            <div id="personalizationHelper" style="display: none; margin-top: 8px;">
              <small style="color: var(--accent);">
                ğŸ’¡ <strong>Personalisasi tersedia:</strong> Gunakan {name} dalam pesan untuk menyebut nama penerima.
                <br>Contoh: "Halo {name}, kami ingin menginformasikan..."
              </small>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
            <div>
              <label for="delayMin">Min Delay (ms)</label>
              <input type="number" id="delayMin" value="3000" min="0">
              <small style="color: var(--muted);">Delay minimum antar pesan</small>
            </div>
            <div>
              <label for="delayMax">Max Delay (ms)</label>
              <input type="number" id="delayMax" value="8000" min="0">
              <small style="color: var(--muted);">Delay maximum antar pesan</small>
            </div>
            <div>
              <label for="cooldownAfter">Cooldown After (messages)</label>
              <input type="number" id="cooldownAfter" value="30" min="0">
              <small style="color: var(--muted);">Jeda setiap X pesan</small>
            </div>
            <div>
              <label for="cooldownMin">Cooldown Min (ms)</label>
              <input type="number" id="cooldownMin" value="120000" min="0" disabled>
              <small style="color: var(--muted);">Durasi cooldown minimum</small>
            </div>
            <div>
              <label for="cooldownMax">Cooldown Max (ms)</label>
              <input type="number" id="cooldownMax" value="300000" min="0" disabled>
              <small style="color: var(--muted);">Durasi cooldown maximum</small>
            </div>
          </div>

          <div style="background: rgba(6, 182, 212, 0.1); border: 1px solid rgba(6, 182, 212, 0.2); border-radius: 10px; padding: 12px; margin-bottom: 16px;">
            <span id="estimatedTime" style="color: var(--accent);">Masukkan nomor untuk melihat estimasi</span>
          </div>

          <button type="submit">Start Broadcast</button>
        </form>

        <div class="log" id="broadcastResult" style="margin-top: 16px;"></div>
      </div>
    </div>

    <!-- Broadcast Jobs View -->
    <div id="view-jobs" class="view">
      <div class="page-header">
        <h2 class="page-title">Broadcast Jobs</h2>
        <p class="page-subtitle">Monitor your broadcast jobs</p>
      </div>

      <div class="card">
        <h3 class="card-title">ğŸ” Filter Jobs</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px;">
          <div>
            <label>Filter Type</label>
            <select id="jobFilterType">
              <option value="all">All Jobs (All Sessions)</option>
              <option value="session">Specific Session</option>
            </select>
          </div>
          <div id="jobSessionFilter" style="display: none;">
            <label>Session</label>
            <select id="jobsSessionSelect"></select>
          </div>
          <div>
            <label>Start Date</label>
            <input type="date" id="jobStartDate">
          </div>
          <div>
            <label>End Date</label>
            <input type="date" id="jobEndDate">
          </div>
          <div>
            <label>Limit</label>
            <select id="jobLimit">
              <option value="50">Last 50</option>
              <option value="100" selected>Last 100</option>
              <option value="500">Last 500</option>
              <option value="">All</option>
            </select>
          </div>
        </div>
        <div class="btn-group">
          <button type="button" id="applyJobFilter" class="btn-ghost" style="width: auto;">Apply Filter</button>
          <button type="button" id="resetJobFilter" class="btn-ghost" style="width: auto;">Reset</button>
          <button type="button" id="refreshJobs" class="btn-ghost" style="width: auto;">ğŸ”„ Refresh</button>
        </div>
      </div>

      <div class="card">
        <h3 class="card-title">ğŸ“‹ Jobs (<span id="jobCount">0</span>)</h3>
        <div class="job-list" id="jobList">No jobs yet.</div>
      </div>
    </div>

    <!-- Job Detail View -->
    <div id="view-job-detail" class="view">
      <div class="page-header">
        <h2 class="page-title">Job Detail: <span id="jobDetailId">-</span></h2>
        <p class="page-subtitle">
          Status: <span id="jobDetailStatus" class="status-badge">-</span> |
          Phase: <span id="jobDetailPhase">-</span>
        </p>
      </div>

      <div class="card">
        <h3 class="card-title">ğŸ“Š Job Statistics</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">âœ…</div>
            <div class="stat-content">
              <div class="stat-label">Sent</div>
              <div class="stat-value" id="jobDetailSent">0</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">â­ï¸</div>
            <div class="stat-content">
              <div class="stat-label">Skipped</div>
              <div class="stat-value" id="jobDetailSkipped">0</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">âŒ</div>
            <div class="stat-content">
              <div class="stat-label">Failed</div>
              <div class="stat-value" id="jobDetailFailed">0</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-content">
              <div class="stat-label">Total</div>
              <div class="stat-value" id="jobDetailTotal">0</div>
            </div>
          </div>
        </div>

        <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
          <button type="button" id="exportJobResults" class="btn-ghost">ğŸ“¥ Export Results (CSV)</button>
          <button type="button" id="backToJobs" class="btn-ghost">â† Back to Jobs</button>
        </div>
      </div>

      <div class="card">
        <h3 class="card-title">ğŸ“ Detailed Results</h3>
        <div style="margin-bottom: 12px;">
          <input type="text" id="jobResultsFilter" placeholder="Filter by phone number..." style="max-width: 300px;">
        </div>
        <div class="job-list" id="jobResultsList" style="max-height: 500px;">
          Loading job details...
        </div>
      </div>
    </div>

    <!-- Chat View -->
    <div id="view-chat" class="view">
      <div class="chat-container">
        <!-- Contacts Sidebar -->
        <div class="chat-contacts-sidebar">
          <div class="chat-header">
            <div class="session-selector">
              <select id="chatSessionSelect">
                <option value="">Select Session...</option>
              </select>
            </div>
            <div class="search-box">
              <input type="text" id="chatSearchInput" placeholder="Search contacts...">
            </div>
          </div>
          <div class="contacts-list" id="chatContactsList">
            <div class="loading-contacts">Loading contacts...</div>
          </div>
        </div>

        <!-- Chat Window -->
        <div class="chat-window">
          <div id="chatWelcome" class="chat-welcome">
            <div class="welcome-icon">ğŸ’¬</div>
            <h3>Welcome to Chat</h3>
            <p>Select a contact to start messaging</p>
          </div>

          <div id="chatConversation" class="chat-conversation" style="display: none;">
            <!-- Chat Header -->
            <div class="chat-window-header">
              <div class="contact-info">
                <div class="contact-avatar" id="chatContactAvatar">?</div>
                <div class="contact-details">
                  <div class="contact-name" id="chatContactName">-</div>
                  <div class="contact-phone" id="chatContactPhone">-</div>
                </div>
              </div>
              <div class="chat-actions">
                <button class="btn-icon" id="viewContactBtn" title="View Contact Details">ğŸ‘¤</button>
                <button class="btn-icon" id="refreshChatBtn" title="Sync Chat History">ğŸ”„</button>
              </div>
            </div>

            <!-- Messages Container -->
            <div class="messages-container" id="messagesContainer">
              <!-- Messages will be rendered here -->
            </div>

            <!-- Message Input -->
            <div class="message-input-area">
              <div class="crm-quick-actions" id="crmQuickActions">
                <button id="updateStatusBtn" class="btn-sm">ğŸ“Š Status</button>
                <button id="addTagBtn" class="btn-sm">ğŸ·ï¸ Tag</button>
                <button id="addNoteBtn" class="btn-sm">ğŸ“ Note</button>
              </div>
              <div class="message-input-wrapper">
                <textarea id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                <button id="sendMessageBtn" class="btn-send">â¤</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contacts/CRM View -->
    <div id="view-contacts" class="view">
      <div class="page-header">
        <h2 class="page-title">Contacts & Leads</h2>
        <p class="page-subtitle">Manage your contacts and track leads</p>
      </div>

      <div class="crm-container">
        <!-- Filters Sidebar -->
        <div class="crm-filters-sidebar">
          <div class="filter-section">
            <h3>Filters</h3>
            <div class="session-filter">
              <label>Session</label>
              <select id="crmSessionSelect">
                <option value="">Select Session...</option>
              </select>
            </div>
            <div class="search-filter">
              <label>Search</label>
              <input type="text" id="crmSearchInput" placeholder="Name, phone...">
            </div>
            <div class="status-filter">
              <label>Lead Status</label>
              <select id="crmStatusFilter">
                <option value="">All Statuses</option>
              </select>
            </div>
            <div class="tags-filter">
              <label>Tags</label>
              <div id="crmTagsFilter" class="tags-checkboxes">
                <!-- Tag checkboxes will be rendered here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Contacts Grid -->
        <div class="crm-contacts-grid">
          <div class="crm-toolbar">
            <div class="contact-count" id="crmContactCount">0 contacts</div>
            <div class="sync-buttons">
              <button id="syncWhatsAppBtn" class="btn-ghost">ğŸ“± Sync WhatsApp</button>
              <button id="syncGoogleBtn" class="btn-ghost">ğŸ“‡ Sync Google Contacts</button>
            </div>
          </div>
          <div id="googleStatus" class="google-status" style="display: none;">
            <span id="googleConnectionStatus">âœ… Connected to Google</span>
            <button id="disconnectGoogleBtn" class="btn-ghost btn-sm">Disconnect</button>
          </div>
          <div id="googleNotConnected" class="google-notice" style="display: none;">
            <span>ğŸ“‡ Google Contacts not connected</span>
            <button id="connectGoogleBtn" class="btn-sm btn-primary">Connect Google</button>
          </div>
          <div class="contacts-cards" id="crmContactsCards">
            <div style="grid-column: 1/-1; text-align: center; color: var(--muted); padding: 40px;">
              Loading contacts...
            </div>
          </div>
          <div class="pagination" id="crmPagination" style="display: none;"></div>
        </div>
      </div>
    </div>

    <!-- Contact Detail Modal -->
    <div id="contactDetailModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Contact Details</h3>
          <button class="modal-close" id="closeContactModal">âœ•</button>
        </div>
        <div class="modal-body" id="contactDetailModalBody">
          <!-- Contact details will be rendered here -->
        </div>
      </div>
    </div>
  </main>

  <!-- Load modular JavaScript files -->
  <script src="js/state.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/navigation.js"></script>
  <script src="js/sessions.js"></script>
  <script src="js/jobs.js"></script>
  <script src="js/broadcast.js"></script>
  <script src="js/chat.js"></script>
  <script src="js/crm.js"></script>
  <script src="js/ui.js"></script>
  <script src="js/app.js"></script>

  <script>
    const socket = io();
  </script>
</body>
</html>
