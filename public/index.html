<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhiskeySocket Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --panel-light: rgba(255,255,255,0.03);
      --accent: #06b6d4;
      --accent-hover: #0891b2;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --danger: #f43f5e;
      --success: #22c55e;
      --warning: #f59e0b;
      --border: rgba(255,255,255,0.06);
      --sidebar-width: 260px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Space Grotesk', system-ui, sans-serif;
      background: radial-gradient(circle at 10% 20%, #0b1225 0, #0f172a 40%, #0b1225 75%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
    }

    /* Sidebar Styles */
    .sidebar {
      width: var(--sidebar-width);
      background: linear-gradient(180deg, var(--panel) 0%, rgba(17, 24, 39, 0.95) 100%);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 100;
      transition: transform 0.3s ease;
    }

    .sidebar-header {
      padding: 24px 20px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-header h1 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.03em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-header .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--bg);
    }

    .nav-menu {
      padding: 16px 12px;
      flex: 1;
    }

    .nav-section {
      margin-bottom: 24px;
    }

    .nav-section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      padding: 8px 12px 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--muted);
      text-decoration: none;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .nav-item:hover {
      background: var(--panel-light);
      color: var(--text);
    }

    .nav-item.active {
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.15) 0%, rgba(6, 182, 212, 0.05) 100%);
      color: var(--accent);
      border: 1px solid rgba(6, 182, 212, 0.2);
    }

    .nav-item .icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 32px;
      min-height: 100vh;
      transition: margin-left 0.3s ease;
    }

    .page-header {
      margin-bottom: 32px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.03em;
      margin-bottom: 8px;
    }

    .page-subtitle {
      color: var(--muted);
      font-size: 15px;
    }

    /* Views */
    .view {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .view.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Cards */
    .card {
      background: linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.35);
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Dashboard Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .stat-icon {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: rgba(6, 182, 212, 0.1);
      color: var(--accent);
    }

    .stat-content {
      flex: 1;
    }

    .stat-label {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.03em;
    }

    /* Forms */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 14px;
      color: var(--text);
    }

    input, textarea, select, button {
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-size: 15px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.06);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    button {
      cursor: pointer;
      border: none;
      background: var(--accent);
      color: var(--bg);
      font-weight: 600;
      transition: all 0.2s ease;
    }

    button:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(6, 182, 212, 0.3);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    input:disabled, select:disabled, textarea:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: rgba(255,255,255,0.02);
    }

    button.btn-danger {
      background: var(--danger);
      color: white;
    }

    button.btn-danger:hover:not(:disabled) {
      background: #e11d48;
      box-shadow: 0 10px 25px rgba(244, 63, 94, 0.3);
    }

    button.btn-ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
    }

    button.btn-ghost:hover:not(:disabled) {
      background: var(--panel-light);
      color: var(--text);
    }

    button.btn-ghost.active {
      background: var(--accent) !important;
      color: var(--bg) !important;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* Status Indicators */
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }

    .status-dot.connected { background: var(--success); box-shadow: 0 0 10px var(--success); }
    .status-dot.qr { background: var(--accent); box-shadow: 0 0 10px var(--accent); }
    .status-dot.disconnected { background: var(--danger); }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
    }

    .status-badge.success {
      background: rgba(34, 197, 94, 0.1);
      border-color: rgba(34, 197, 94, 0.2);
      color: var(--success);
    }

    .status-badge.warning {
      background: rgba(245, 158, 11, 0.1);
      border-color: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .status-badge.error {
      background: rgba(244, 63, 94, 0.1);
      border-color: rgba(244, 63, 94, 0.2);
      color: var(--danger);
    }

    /* Session List */
    .session-item {
      background: var(--panel-light);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .session-item:hover {
      border-color: rgba(6, 182, 212, 0.3);
      background: rgba(6, 182, 212, 0.05);
    }

    .session-item.active {
      border-color: var(--accent);
      background: rgba(6, 182, 212, 0.1);
    }

    .session-item-info {
      flex: 1;
    }

    .session-item-name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .session-item-status {
      font-size: 13px;
      color: var(--muted);
    }

    /* QR Code */
    .qr-box {
      display: grid;
      place-items: center;
      background: rgba(255,255,255,0.04);
      border: 1px dashed var(--border);
      border-radius: 12px;
      min-height: 280px;
      padding: 20px;
      margin: 20px 0;
    }

    #qrCanvas {
      width: 100%;
      max-width: 280px;
    }

    /* Job List */
    .job-list {
      max-height: 500px;
      overflow-y: auto;
    }

    .job-item {
      background: var(--panel-light);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .job-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .job-item-id {
      font-family: monospace;
      font-size: 13px;
      color: var(--muted);
    }

    .job-item-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    .job-stat {
      text-align: center;
      padding: 8px;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
    }

    .job-stat-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .job-stat-value {
      font-size: 18px;
      font-weight: 600;
    }

    /* Log Output */
    .log {
      font-family: 'SF Mono', 'Consolas', monospace;
      color: var(--muted);
      font-size: 13px;
      white-space: pre-wrap;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    /* Mobile Menu Toggle */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 1000;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      width: 44px;
      height: 44px;
      cursor: pointer;
      color: var(--bg);
      font-size: 20px;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
        padding: 80px 16px 24px;
      }

      .mobile-menu-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Session selector in main content */
    .session-selector {
      background: var(--panel-light);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
    }

    .session-selector-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    /* ============================================
       CHAT LAYOUT STYLES
       ============================================ */

    /* Chat Container - 2-column layout */
    .chat-container {
      display: grid;
      grid-template-columns: 320px 1fr;
      gap: 1px;
      background: var(--border);
      height: calc(100vh - 64px);
      border-radius: 16px;
      overflow: hidden;
    }

    /* Contacts Sidebar */
    .chat-contacts-sidebar {
      background: var(--panel);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      gap: 12px;
    }

    .chat-header select,
    .chat-header input {
      width: 100%;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
    }

    .contacts-list {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .loading-contacts {
      padding: 20px;
      text-align: center;
      color: var(--muted);
    }

    /* Contact Item */
    .contact-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 4px;
    }

    .contact-item:hover {
      background: var(--panel-light);
    }

    .contact-item.active {
      background: rgba(6, 182, 212, 0.1);
      border: 1px solid rgba(6, 182, 212, 0.2);
    }

    .contact-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 18px;
      flex-shrink: 0;
      color: var(--bg);
    }

    .contact-item-info {
      flex: 1;
      min-width: 0;
    }

    .contact-item-name {
      font-weight: 600;
      margin-bottom: 4px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .contact-item-preview {
      font-size: 13px;
      color: var(--muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .contact-item-meta {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 4px;
      font-size: 12px;
      color: var(--muted);
    }

    .unread-badge {
      background: var(--accent);
      color: var(--bg);
      padding: 2px 8px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 11px;
    }

    /* Chat Window */
    .chat-window {
      background: var(--bg);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .chat-welcome {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: var(--muted);
    }

    .welcome-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .chat-conversation {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .chat-window-header {
      padding: 16px 20px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .chat-window-header .contact-info {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .chat-window-header .contact-details {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .chat-window-header .contact-name {
      font-weight: 600;
      font-size: 16px;
    }

    .chat-window-header .contact-phone {
      font-size: 13px;
      color: var(--muted);
    }

    .chat-actions {
      display: flex;
      gap: 8px;
    }

    .btn-icon {
      width: 36px;
      height: 36px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      background: var(--panel-light);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-icon:hover {
      background: var(--border);
      transform: translateY(-1px);
    }

    /* Messages */
    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .message {
      display: flex;
      gap: 8px;
      max-width: 70%;
      animation: slideIn 0.2s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.outgoing {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message-bubble {
      padding: 12px 16px;
      border-radius: 16px;
      word-wrap: break-word;
    }

    .message.incoming .message-bubble {
      background: var(--panel);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    .message.outgoing .message-bubble {
      background: var(--accent);
      color: var(--bg);
      border-bottom-right-radius: 4px;
    }

    .message-time {
      font-size: 11px;
      color: var(--muted);
      margin-top: 4px;
      text-align: right;
    }

    .message.outgoing .message-time {
      color: rgba(0,0,0,0.6);
    }

    .message-status {
      font-size: 10px;
      margin-left: 4px;
    }

    /* Message Input */
    .message-input-area {
      padding: 16px 20px;
      background: var(--panel);
      border-top: 1px solid var(--border);
    }

    .crm-quick-actions {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 13px;
      background: var(--panel-light);
      border: 1px solid var(--border);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-sm:hover {
      background: var(--border);
    }

    .message-input-wrapper {
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    #messageInput {
      flex: 1;
      resize: none;
      min-height: 44px;
      max-height: 120px;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
    }

    #messageInput:focus {
      outline: none;
      border-color: var(--accent);
    }

    .btn-send {
      width: 44px;
      height: 44px;
      padding: 0;
      font-size: 18px;
      background: var(--accent);
      color: var(--bg);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-send:hover {
      transform: scale(1.05);
    }

    /* ============================================
       CRM LAYOUT STYLES
       ============================================ */

    /* CRM Container */
    .crm-container {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 20px;
    }

    /* Filters Sidebar */
    .crm-filters-sidebar {
      background: var(--panel);
      border-radius: 12px;
      padding: 20px;
      height: fit-content;
    }

    .filter-section {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .filter-section label {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 6px;
      display: block;
    }

    .filter-section select,
    .filter-section input {
      width: 100%;
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
    }

    .tags-checkboxes {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .tag-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    /* Contacts Grid */
    .crm-contacts-grid {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .crm-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .contact-count {
      font-size: 14px;
      color: var(--muted);
    }

    .sync-buttons {
      display: flex;
      gap: 8px;
    }

    .google-status,
    .google-notice {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: var(--panel-light);
      border-radius: 8px;
      font-size: 14px;
    }

    .contacts-cards {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 16px;
    }

    /* Contact Card */
    .contact-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .contact-card:hover {
      border-color: var(--accent);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .contact-card-header {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
    }

    .contact-card-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: var(--accent);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      color: var(--bg);
    }

    .contact-card-info {
      flex: 1;
    }

    .contact-card-name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .contact-card-phone {
      font-size: 13px;
      color: var(--muted);
    }

    .contact-card-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }

    .tag-badge {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }

    .lead-status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .contact-card-meta {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--muted);
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      margin-top: 24px;
      flex-wrap: wrap;
    }

    .pagination-btn {
      min-width: 40px;
      height: 40px;
      padding: 8px 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .pagination-btn:hover:not(:disabled):not(.active) {
      background: var(--panel-light);
      border-color: var(--primary);
    }

    .pagination-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .pagination-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .pagination-ellipsis {
      color: var(--muted);
      padding: 0 8px;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .modal.active {
      display: flex;
    }

    .modal-content {
      background: var(--panel);
      border-radius: 16px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h3 {
      margin: 0;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      padding: 0;
      font-size: 18px;
      background: var(--panel-light);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
    }

    .modal-body {
      padding: 20px;
    }

    .contact-detail-header {
      text-align: center;
      margin-bottom: 24px;
    }

    .contact-detail-header .contact-avatar {
      width: 80px;
      height: 80px;
      font-size: 32px;
      margin: 0 auto 16px;
    }

    .contact-detail-section {
      margin-bottom: 24px;
    }

    .contact-detail-section h4 {
      margin-bottom: 12px;
    }

    .contact-tags-list {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }

    .tag-badge button {
      background: none;
      border: none;
      margin-left: 4px;
      cursor: pointer;
      opacity: 0.7;
    }

    .tag-badge button:hover {
      opacity: 1;
    }

    .note-item {
      background: var(--panel-light);
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .modal-actions {
      margin-top: 24px;
      text-align: right;
    }

    /* Button Styles */
    .btn-ghost {
      background: var(--panel-light);
      border: 1px solid var(--border);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .btn-ghost:hover {
      background: var(--border);
    }

    .btn-primary {
      background: var(--accent);
      color: var(--bg);
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
    }

    .btn-primary:hover {
      opacity: 0.9;
    }

    /* Responsive Design */
    @media (max-width: 1024px) {
      .crm-container {
        grid-template-columns: 1fr;
      }

      .crm-filters-sidebar {
        display: none;
      }
    }

    @media (max-width: 768px) {
      .chat-container {
        grid-template-columns: 1fr;
      }

      .chat-contacts-sidebar {
        display: flex;
      }

      .chat-contacts-sidebar.hidden {
        display: none;
      }

      .contacts-cards {
        grid-template-columns: 1fr;
      }

      .crm-toolbar {
        flex-direction: column;
        align-items: stretch;
      }

      .sync-buttons {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    ‚ò∞
  </button>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h1>
        <div class="logo-icon">W</div>
        WhiskeySocket
      </h1>
    </div>

    <nav class="nav-menu">
      <div class="nav-section">
        <div class="nav-section-title">Main</div>
        <a href="#dashboard" class="nav-item active" data-view="dashboard">
          <span class="icon">üìä</span>
          <span>Dashboard</span>
        </a>
        <a href="#sessions" class="nav-item" data-view="sessions">
          <span class="icon">üì±</span>
          <span>Sessions</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Messaging</div>
        <a href="#chat" class="nav-item" data-view="chat">
          <span class="icon">üí¨</span>
          <span>Chat</span>
        </a>
        <a href="#send-message" class="nav-item" data-view="send-message">
          <span class="icon">üì§</span>
          <span>Send Message</span>
        </a>
        <a href="#broadcast" class="nav-item" data-view="broadcast">
          <span class="icon">üì¢</span>
          <span>Broadcast</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">CRM</div>
        <a href="#contacts" class="nav-item" data-view="contacts">
          <span class="icon">üë•</span>
          <span>Contacts</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Monitoring</div>
        <a href="#jobs" class="nav-item" data-view="jobs">
          <span class="icon">üìã</span>
          <span>Broadcast Jobs</span>
        </a>
      </div>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Dashboard View -->
    <div id="view-dashboard" class="view active">
      <div class="page-header">
        <h2 class="page-title">Dashboard</h2>
        <p class="page-subtitle">Overview of your WhatsApp sessions and activities</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üì±</div>
          <div class="stat-content">
            <div class="stat-label">Total Sessions</div>
            <div class="stat-value" id="stat-total-sessions">0</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-content">
            <div class="stat-label">Connected</div>
            <div class="stat-value" id="stat-connected">0</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üìã</div>
          <div class="stat-content">
            <div class="stat-label">Active Jobs</div>
            <div class="stat-value" id="stat-active-jobs">0</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">‚úâÔ∏è</div>
          <div class="stat-content">
            <div class="stat-label">Messages Sent</div>
            <div class="stat-value" id="stat-messages-sent">0</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 class="card-title">üìä Session Status Overview</h3>
        <div id="dashboard-sessions">Loading...</div>
      </div>
    </div>

    <!-- Sessions View -->
    <div id="view-sessions" class="view">
      <div class="page-header">
        <h2 class="page-title">Sessions</h2>
        <p class="page-subtitle">Manage your WhatsApp sessions</p>
      </div>

      <div class="card">
        <h3 class="card-title">‚ûï Create New Session</h3>
        <div class="btn-group" style="margin-bottom: 16px;">
          <input id="newSessionId" placeholder="Enter session ID (e.g., personal, work)" style="flex: 1; max-width: 300px;">
          <button id="createSessionBtn">Create Session</button>
        </div>
        <div class="log" id="sessionCreateLog"></div>
      </div>

      <div class="card">
        <h3 class="card-title">üì± All Sessions</h3>
        <div id="sessions-list">Loading sessions...</div>
      </div>
    </div>

    <!-- Session Detail View -->
    <div id="view-session-detail" class="view">
      <div class="page-header">
        <h2 class="page-title">Session: <span id="session-detail-name">-</span></h2>
        <p class="page-subtitle">Manage this WhatsApp session</p>
      </div>

      <div class="card">
        <h3 class="card-title">üìä Connection Status</h3>
        <div style="margin-bottom: 16px;">
          <span class="status-badge" id="session-status-badge">
            <span class="status-dot" id="session-status-dot"></span>
            <span id="session-status-text">Loading...</span>
          </span>
          <span class="status-badge" style="margin-left: 8px;" id="session-user-badge">User: -</span>
        </div>

        <div class="qr-box">
          <canvas id="qrCanvas"></canvas>
          <div id="qrPlaceholder" style="color: var(--muted);">QR code will appear here when needed</div>
        </div>

        <div class="btn-group">
          <button id="logoutBtn" class="btn-danger">Logout Session</button>
          <button id="deleteSessionBtn" class="btn-ghost">Remove Session</button>
        </div>

        <div class="log" id="sessionActionLog" style="margin-top: 16px;"></div>
      </div>
    </div>

    <!-- Send Message View -->
    <div id="view-send-message" class="view">
      <div class="page-header">
        <h2 class="page-title">Send Message</h2>
        <p class="page-subtitle">Send a message to a single WhatsApp number</p>
      </div>

      <div class="session-selector">
        <label>Active Session:</label>
        <div class="session-selector-row">
          <select id="sendSessionSelect"></select>
        </div>
      </div>

      <div class="card">
        <form id="sendForm">
          <div class="form-group">
            <label for="sendNumber">Phone Number</label>
            <input type="text" id="sendNumber" placeholder="62812xxxxxxx (include country code, digits only)" required>
            <small style="color: var(--muted); display: block; margin-top: 4px;">Format: Country code + number (e.g., 628123456789)</small>
          </div>

          <div class="form-group">
            <label for="sendMessage">Message</label>
            <textarea id="sendMessage" placeholder="Type your message here..." required></textarea>
          </div>

          <button type="submit">Send Message</button>
        </form>

        <div class="log" id="sendResult" style="margin-top: 16px;"></div>
      </div>
    </div>

    <!-- Broadcast View -->
    <div id="view-broadcast" class="view">
      <div class="page-header">
        <h2 class="page-title">Broadcast Message</h2>
        <p class="page-subtitle">Send messages to multiple numbers</p>
      </div>

      <div class="session-selector">
        <label>Active Session:</label>
        <div class="session-selector-row">
          <select id="broadcastSessionSelect"></select>
        </div>
      </div>

      <div class="card">
        <form id="broadcastForm">
          <div class="form-group">
            <label for="broadcastPreset">Speed Preset</label>
            <select id="broadcastPreset">
              <option value="moderate">üü° Moderate - Broadcast 50-200 nomor</option>
              <option value="conservative">üü¢ Conservative - Broadcast 200-1000 nomor</option>
              <option value="very-conservative">üîí Very Conservative - Nomor penting / >1000 nomor</option>
              <option value="custom">‚öôÔ∏è Custom - Konfigurasi manual</option>
            </select>
            <small id="presetDescription" style="color: var(--muted); display: block; margin-top: 4px;">
              Simulasi behavior manusia natural. Speed: 3-8 detik/pesan. Cooldown setiap 30 pesan. Risiko: Medium.
            </small>
          </div>

          <div class="form-group">
            <label>Input Method</label>
            <div class="btn-group">
              <button type="button" id="methodManual" style="flex:1;">üìù Manual Input</button>
              <button type="button" id="methodCsv" style="flex:1;">üìÅ Upload CSV</button>
            </div>
          </div>

          <div id="manualInput">
            <div class="form-group">
              <label for="broadcastNumbers">Phone Numbers (one per line)</label>
              <textarea id="broadcastNumbers" placeholder="6281234567890&#10;6289876543210&#10;6285555555555"></textarea>
              <small style="color: var(--muted); display: block; margin-top: 4px;">Format: Country code + number, one per line</small>
            </div>
          </div>

          <div id="csvInput" style="display: none;">
            <div class="form-group">
              <label for="csvFile">Upload CSV File</label>
              <input type="file" id="csvFile" accept=".csv" style="padding: 8px;">
              <div style="display: flex; gap: 8px; margin-top: 8px;">
                <button type="button" id="downloadTemplate" class="btn-ghost" style="flex: 1;">üì• Download Template</button>
                <button type="button" id="previewCsv" class="btn-ghost" style="flex: 1;">üëÅÔ∏è Preview Data</button>
              </div>
              <small style="color: var(--muted); display: block; margin-top: 4px;">
                CSV harus punya kolom: <strong>phone</strong> (wajib), <strong>name</strong> (opsional untuk personalisasi)
              </small>
            </div>

            <div id="csvPreview" style="display: none;">
              <label>Preview Data (<span id="previewCount">0</span> contacts)</label>
              <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px; background: rgba(0,0,0,0.2);">
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                  <thead>
                    <tr style="border-bottom: 1px solid var(--border);">
                      <th style="text-align: left; padding: 8px;">#</th>
                      <th style="text-align: left; padding: 8px;">Phone</th>
                      <th style="text-align: left; padding: 8px;">Name</th>
                    </tr>
                  </thead>
                  <tbody id="previewBody"></tbody>
                </table>
              </div>
              <div id="csvStats" style="margin-top: 8px; font-size: 13px; color: var(--muted);"></div>
            </div>
          </div>

          <div class="form-group">
            <label for="broadcastMessage">Message</label>
            <textarea id="broadcastMessage" placeholder="Type your broadcast message here... Gunakan {name} untuk personalisasi." required></textarea>
            <div id="personalizationHelper" style="display: none; margin-top: 8px;">
              <small style="color: var(--accent);">
                üí° <strong>Personalisasi tersedia:</strong> Gunakan {name} dalam pesan untuk menyebut nama penerima.
                <br>Contoh: "Halo {name}, kami ingin menginformasikan..."
              </small>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
            <div>
              <label for="delayMin">Min Delay (ms)</label>
              <input type="number" id="delayMin" value="3000" min="0">
              <small style="color: var(--muted);">Delay minimum antar pesan</small>
            </div>
            <div>
              <label for="delayMax">Max Delay (ms)</label>
              <input type="number" id="delayMax" value="8000" min="0">
              <small style="color: var(--muted);">Delay maximum antar pesan</small>
            </div>
            <div>
              <label for="cooldownAfter">Cooldown After (messages)</label>
              <input type="number" id="cooldownAfter" value="30" min="0">
              <small style="color: var(--muted);">Jeda setiap X pesan</small>
            </div>
            <div>
              <label for="cooldownMin">Cooldown Min (ms)</label>
              <input type="number" id="cooldownMin" value="120000" min="0" disabled>
              <small style="color: var(--muted);">Durasi cooldown minimum</small>
            </div>
            <div>
              <label for="cooldownMax">Cooldown Max (ms)</label>
              <input type="number" id="cooldownMax" value="300000" min="0" disabled>
              <small style="color: var(--muted);">Durasi cooldown maximum</small>
            </div>
          </div>

          <div style="background: rgba(6, 182, 212, 0.1); border: 1px solid rgba(6, 182, 212, 0.2); border-radius: 10px; padding: 12px; margin-bottom: 16px;">
            <span id="estimatedTime" style="color: var(--accent);">Masukkan nomor untuk melihat estimasi</span>
          </div>

          <button type="submit">Start Broadcast</button>
        </form>

        <div class="log" id="broadcastResult" style="margin-top: 16px;"></div>
      </div>
    </div>

    <!-- Broadcast Jobs View -->
    <div id="view-jobs" class="view">
      <div class="page-header">
        <h2 class="page-title">Broadcast Jobs</h2>
        <p class="page-subtitle">Monitor your broadcast jobs</p>
      </div>

      <div class="card">
        <h3 class="card-title">üîç Filter Jobs</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px;">
          <div>
            <label>Filter Type</label>
            <select id="jobFilterType">
              <option value="all">All Jobs (All Sessions)</option>
              <option value="session">Specific Session</option>
            </select>
          </div>
          <div id="jobSessionFilter" style="display: none;">
            <label>Session</label>
            <select id="jobsSessionSelect"></select>
          </div>
          <div>
            <label>Start Date</label>
            <input type="date" id="jobStartDate">
          </div>
          <div>
            <label>End Date</label>
            <input type="date" id="jobEndDate">
          </div>
          <div>
            <label>Limit</label>
            <select id="jobLimit">
              <option value="50">Last 50</option>
              <option value="100" selected>Last 100</option>
              <option value="500">Last 500</option>
              <option value="">All</option>
            </select>
          </div>
        </div>
        <div class="btn-group">
          <button type="button" id="applyJobFilter" class="btn-ghost" style="width: auto;">Apply Filter</button>
          <button type="button" id="resetJobFilter" class="btn-ghost" style="width: auto;">Reset</button>
          <button type="button" id="refreshJobs" class="btn-ghost" style="width: auto;">üîÑ Refresh</button>
        </div>
      </div>

      <div class="card">
        <h3 class="card-title">üìã Jobs (<span id="jobCount">0</span>)</h3>
        <div class="job-list" id="jobList">No jobs yet.</div>
      </div>
    </div>

    <!-- Job Detail View -->
    <div id="view-job-detail" class="view">
      <div class="page-header">
        <h2 class="page-title">Job Detail: <span id="jobDetailId">-</span></h2>
        <p class="page-subtitle">
          Status: <span id="jobDetailStatus" class="status-badge">-</span> |
          Phase: <span id="jobDetailPhase">-</span>
        </p>
      </div>

      <div class="card">
        <h3 class="card-title">üìä Job Statistics</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-content">
              <div class="stat-label">Sent</div>
              <div class="stat-value" id="jobDetailSent">0</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚è≠Ô∏è</div>
            <div class="stat-content">
              <div class="stat-label">Skipped</div>
              <div class="stat-value" id="jobDetailSkipped">0</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚ùå</div>
            <div class="stat-content">
              <div class="stat-label">Failed</div>
              <div class="stat-value" id="jobDetailFailed">0</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-content">
              <div class="stat-label">Total</div>
              <div class="stat-value" id="jobDetailTotal">0</div>
            </div>
          </div>
        </div>

        <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
          <button type="button" id="exportJobResults" class="btn-ghost">üì• Export Results (CSV)</button>
          <button type="button" id="backToJobs" class="btn-ghost">‚Üê Back to Jobs</button>
        </div>
      </div>

      <div class="card">
        <h3 class="card-title">üìù Detailed Results</h3>
        <div style="margin-bottom: 12px;">
          <input type="text" id="jobResultsFilter" placeholder="Filter by phone number..." style="max-width: 300px;">
        </div>
        <div class="job-list" id="jobResultsList" style="max-height: 500px;">
          Loading job details...
        </div>
      </div>
    </div>

    <!-- Chat View -->
    <div id="view-chat" class="view">
      <div class="chat-container">
        <!-- Contacts Sidebar -->
        <div class="chat-contacts-sidebar">
          <div class="chat-header">
            <div class="session-selector">
              <select id="chatSessionSelect">
                <option value="">Select Session...</option>
              </select>
            </div>
            <div class="search-box">
              <input type="text" id="chatSearchInput" placeholder="Search contacts...">
            </div>
          </div>
          <div class="contacts-list" id="chatContactsList">
            <div class="loading-contacts">Loading contacts...</div>
          </div>
        </div>

        <!-- Chat Window -->
        <div class="chat-window">
          <div id="chatWelcome" class="chat-welcome">
            <div class="welcome-icon">üí¨</div>
            <h3>Welcome to Chat</h3>
            <p>Select a contact to start messaging</p>
          </div>

          <div id="chatConversation" class="chat-conversation" style="display: none;">
            <!-- Chat Header -->
            <div class="chat-window-header">
              <div class="contact-info">
                <div class="contact-avatar" id="chatContactAvatar">?</div>
                <div class="contact-details">
                  <div class="contact-name" id="chatContactName">-</div>
                  <div class="contact-phone" id="chatContactPhone">-</div>
                </div>
              </div>
              <div class="chat-actions">
                <button class="btn-icon" id="viewContactBtn" title="View Contact Details">üë§</button>
                <button class="btn-icon" id="refreshChatBtn" title="Sync Chat History">üîÑ</button>
              </div>
            </div>

            <!-- Messages Container -->
            <div class="messages-container" id="messagesContainer">
              <!-- Messages will be rendered here -->
            </div>

            <!-- Message Input -->
            <div class="message-input-area">
              <div class="crm-quick-actions" id="crmQuickActions">
                <button id="updateStatusBtn" class="btn-sm">üìä Status</button>
                <button id="addTagBtn" class="btn-sm">üè∑Ô∏è Tag</button>
                <button id="addNoteBtn" class="btn-sm">üìù Note</button>
              </div>
              <div class="message-input-wrapper">
                <textarea id="messageInput" placeholder="Type a message..." rows="1"></textarea>
                <button id="sendMessageBtn" class="btn-send">‚û§</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Contacts/CRM View -->
    <div id="view-contacts" class="view">
      <div class="page-header">
        <h2 class="page-title">Contacts & Leads</h2>
        <p class="page-subtitle">Manage your contacts and track leads</p>
      </div>

      <div class="crm-container">
        <!-- Filters Sidebar -->
        <div class="crm-filters-sidebar">
          <div class="filter-section">
            <h3>Filters</h3>
            <div class="session-filter">
              <label>Session</label>
              <select id="crmSessionSelect">
                <option value="">Select Session...</option>
              </select>
            </div>
            <div class="search-filter">
              <label>Search</label>
              <input type="text" id="crmSearchInput" placeholder="Name, phone...">
            </div>
            <div class="status-filter">
              <label>Lead Status</label>
              <select id="crmStatusFilter">
                <option value="">All Statuses</option>
              </select>
            </div>
            <div class="tags-filter">
              <label>Tags</label>
              <div id="crmTagsFilter" class="tags-checkboxes">
                <!-- Tag checkboxes will be rendered here -->
              </div>
            </div>
          </div>
        </div>

        <!-- Contacts Grid -->
        <div class="crm-contacts-grid">
          <div class="crm-toolbar">
            <div class="contact-count" id="crmContactCount">0 contacts</div>
            <div class="sync-buttons">
              <button id="syncWhatsAppBtn" class="btn-ghost">üì± Sync WhatsApp</button>
              <button id="syncGoogleBtn" class="btn-ghost">üìá Sync Google Contacts</button>
            </div>
          </div>
          <div id="googleStatus" class="google-status" style="display: none;">
            <span id="googleConnectionStatus">‚úÖ Connected to Google</span>
            <button id="disconnectGoogleBtn" class="btn-ghost btn-sm">Disconnect</button>
          </div>
          <div id="googleNotConnected" class="google-notice" style="display: none;">
            <span>üìá Google Contacts not connected</span>
            <button id="connectGoogleBtn" class="btn-sm btn-primary">Connect Google</button>
          </div>
          <div class="contacts-cards" id="crmContactsCards">
            <div style="grid-column: 1/-1; text-align: center; color: var(--muted); padding: 40px;">
              Loading contacts...
            </div>
          </div>
          <div class="pagination" id="crmPagination" style="display: none;"></div>
        </div>
      </div>
    </div>

    <!-- Contact Detail Modal -->
    <div id="contactDetailModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>Contact Details</h3>
          <button class="modal-close" id="closeContactModal">‚úï</button>
        </div>
        <div class="modal-body" id="contactDetailModalBody">
          <!-- Contact details will be rendered here -->
        </div>
      </div>
    </div>
  </main>

  <script>
    const socket = io();

    // State management
    const state = {
      sessions: {},
      qrMap: {},
      activeSession: null,
      jobs: {},
      currentJobId: null,
      currentView: 'dashboard'
    };

    // Navigation
    function navigateTo(viewId, sessionId = null) {
      // Hide all views
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

      // Update nav items (only for main nav items)
      if (['dashboard', 'sessions', 'send-message', 'broadcast', 'jobs', 'chat', 'contacts'].includes(viewId)) {
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
          if (item.dataset.view === viewId) {
            item.classList.add('active');
          }
        });
      }

      // Show target view
      let targetView = document.getElementById(`view-${viewId}`);
      if (viewId === 'session-detail' && sessionId) {
        state.activeSession = sessionId;
        updateSessionDetailView();
        targetView = document.getElementById('view-session-detail');
      } else if (viewId === 'job-detail') {
        // Job detail view is already populated by viewJobDetail function
        targetView = document.getElementById('view-job-detail');
      }

      if (targetView) {
        targetView.classList.add('active');
        state.currentView = viewId;
      }

      // Close mobile menu
      document.getElementById('sidebar').classList.remove('open');

      // Update session selects
      updateAllSessionSelects();

      // Load jobs if needed
      if (viewId === 'jobs') {
        // Load all jobs by default with current filter
        applyCurrentJobFilter();
      }
    }

    // Hash-based routing
    function handleHashChange() {
      const hash = window.location.hash.slice(1) || 'dashboard';

      // Handle session-detail route with parameter
      if (hash.startsWith('session-detail/')) {
        const sessionId = hash.split('/')[1];
        navigateTo('session-detail', sessionId);
      } else {
        navigateTo(hash);
      }
    }

    window.addEventListener('hashchange', handleHashChange);

    // Mobile menu toggle
    document.getElementById('mobileMenuToggle').addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('open');
    });

    // Initialize navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const view = item.dataset.view;
        window.location.hash = view;
      });
    });

    // API helper
    async function postJson(url, body) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Request failed');
      return data;
    }

    // Update session select elements
    function updateAllSessionSelects() {
      const selects = ['sendSessionSelect', 'broadcastSessionSelect', 'jobsSessionSelect'];
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;

        const currentValue = select.value;
        select.innerHTML = '';

        Object.keys(state.sessions).forEach(sessionId => {
          const opt = document.createElement('option');
          opt.value = sessionId;
          opt.textContent = sessionId;
          select.appendChild(opt);
        });

        if (currentValue && Object.keys(state.sessions).includes(currentValue)) {
          select.value = currentValue;
        } else if (Object.keys(state.sessions).length > 0 && !state.activeSession) {
          state.activeSession = Object.keys(state.sessions)[0];
          select.value = state.activeSession;
        } else if (state.activeSession) {
          select.value = state.activeSession;
        }
      });
    }

    // Dashboard stats update
    function updateDashboardStats() {
      const sessions = Object.values(state.sessions);
      const connected = sessions.filter(s => s.state === 'open').length;
      const jobs = Object.values(state.jobs).filter(j => j.status === 'running' || j.status === 'queued').length;

      document.getElementById('stat-total-sessions').textContent = sessions.length;
      document.getElementById('stat-connected').textContent = connected;
      document.getElementById('stat-active-jobs').textContent = jobs;

      // Calculate total messages sent
      let totalSent = 0;
      Object.values(state.jobs).forEach(job => {
        totalSent += job.totals?.sent || 0;
      });
      document.getElementById('stat-messages-sent').textContent = totalSent;

      // Update session overview
      const overviewDiv = document.getElementById('dashboard-sessions');
      if (sessions.length === 0) {
        overviewDiv.innerHTML = '<p style="color: var(--muted);">No sessions yet. Create one to get started.</p>';
      } else {
        overviewDiv.innerHTML = sessions.map(s => `
          <div class="session-item ${s.state === 'open' ? 'active' : ''}" onclick="window.location.hash='session-detail/${s.id}'">
            <div class="session-item-info">
              <div class="session-item-name">${s.id}</div>
              <div class="session-item-status">
                <span class="status-dot ${s.state === 'open' ? 'connected' : s.state === 'qr' ? 'qr' : 'disconnected'}"></span>
                ${s.state === 'open' ? 'Connected' : s.state === 'qr' ? 'QR Available' : 'Disconnected'} ${s.user?.id ? `- ${s.user.id}` : ''}
              </div>
            </div>
            <span style="font-size: 20px;">‚Üí</span>
          </div>
        `).join('');
      }
    }

    // Update session detail view
    function updateSessionDetailView() {
      const session = state.sessions[state.activeSession];
      if (!session) return;

      document.getElementById('session-detail-name').textContent = state.activeSession;

      const statusDot = document.getElementById('session-status-dot');
      const statusText = document.getElementById('session-status-text');
      const userBadge = document.getElementById('session-user-badge');

      const statusMap = {
        open: { class: 'connected', text: 'Connected' },
        qr: { class: 'qr', text: 'QR Available' },
        close: { class: 'disconnected', text: 'Disconnected' },
        connecting: { class: 'qr', text: 'Connecting...' },
        starting: { class: 'qr', text: 'Starting...' },
      };

      const statusInfo = statusMap[session.state] || { class: 'disconnected', text: session.state || 'Unknown' };
      statusDot.className = `status-dot ${statusInfo.class}`;
      statusText.textContent = statusInfo.text;
      userBadge.textContent = `User: ${session.user?.id || '-'}`;

      // Handle QR
      const qr = state.qrMap[state.activeSession];
      if (session.hasQR && qr) {
        document.getElementById('qrPlaceholder').style.display = 'none';
        document.getElementById('qrCanvas').style.display = 'block';
        QRCode.toCanvas(document.getElementById('qrCanvas'), qr, { width: 280 }, (err) => {
          if (err) console.error(err);
        });
      } else {
        document.getElementById('qrPlaceholder').style.display = 'block';
        document.getElementById('qrCanvas').style.display = 'none';
      }
    }

    // Update sessions list view
    function updateSessionsListView() {
      const listDiv = document.getElementById('sessions-list');
      const sessions = Object.values(state.sessions);

      if (sessions.length === 0) {
        listDiv.innerHTML = '<p style="color: var(--muted);">No sessions yet.</p>';
        return;
      }

      listDiv.innerHTML = sessions.map(s => `
        <div class="session-item ${state.activeSession === s.id ? 'active' : ''}" onclick="state.activeSession = '${s.id}'; window.location.hash='session-detail/${s.id}'">
          <div class="session-item-info">
            <div class="session-item-name">${s.id}</div>
            <div class="session-item-status">
              <span class="status-dot ${s.state === 'open' ? 'connected' : s.state === 'qr' ? 'qr' : 'disconnected'}"></span>
              ${s.state === 'open' ? 'Connected' : s.state === 'qr' ? 'QR Available' : 'Disconnected'} ${s.user?.id ? `- ${s.user.id}` : ''}
            </div>
          </div>
          <span style="font-size: 20px;">‚Üí</span>
        </div>
      `).join('');
    }

    // Socket event handlers
    socket.on('qr', ({ sessionId, qr }) => {
      state.qrMap[sessionId] = qr;
      state.sessions[sessionId] = { ...(state.sessions[sessionId] || {}), id: sessionId, hasQR: true };
      if (!state.activeSession) state.activeSession = sessionId;

      if (state.currentView === 'session-detail' && state.activeSession === sessionId) {
        updateSessionDetailView();
      }

      updateDashboardStats();
      updateSessionsListView();
    });

    socket.on('status', (data) => {
      const { sessionId, ...rest } = data;
      state.sessions[sessionId] = { ...(state.sessions[sessionId] || {}), id: sessionId, ...rest };

      if (state.currentView === 'session-detail' && state.activeSession === sessionId) {
        updateSessionDetailView();
      }

      updateDashboardStats();
      updateSessionsListView();
    });

    // Create session
    document.getElementById('createSessionBtn').addEventListener('click', async () => {
      const val = document.getElementById('newSessionId').value.trim();
      const log = document.getElementById('sessionCreateLog');
      if (!val) {
        log.textContent = 'Session ID required';
        return;
      }
      log.textContent = 'Creating session...';
      try {
        await postJson('/sessions', { id: val });
        log.textContent = `Session "${val}" created! Redirecting...`;
        setTimeout(() => {
          state.activeSession = val;
          window.location.hash = `session-detail/${val}`;
        }, 1000);
      } catch (err) {
        log.textContent = `Error: ${err.message}`;
      }
    });

    // Logout session
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      const log = document.getElementById('sessionActionLog');
      try {
        await postJson(`/sessions/${state.activeSession}/logout`, {});
        state.qrMap[state.activeSession] = null;
        log.textContent = 'Logged out. Please scan the new QR code.';
      } catch (err) {
        log.textContent = `Error: ${err.message}`;
      }
    });

    // Delete session
    document.getElementById('deleteSessionBtn').addEventListener('click', async () => {
      if (!confirm('Are you sure you want to remove this session?')) return;
      const log = document.getElementById('sessionActionLog');
      try {
        await fetch(`/sessions/${state.activeSession}`, { method: 'DELETE' }).then(r => r.json());
        delete state.sessions[state.activeSession];
        delete state.qrMap[state.activeSession];
        log.textContent = 'Session removed. Redirecting...';
        setTimeout(() => {
          window.location.hash = 'sessions';
        }, 1000);
      } catch (err) {
        log.textContent = `Error: ${err.message || 'Failed to remove session'}`;
      }
    });

    // Send single message
    document.getElementById('sendForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sessionId = document.getElementById('sendSessionSelect').value;
      if (!sessionId) {
        document.getElementById('sendResult').textContent = 'Please select a session first';
        return;
      }

      const number = document.getElementById('sendNumber').value.trim();
      const message = document.getElementById('sendMessage').value.trim();
      const log = document.getElementById('sendResult');
      log.textContent = 'Sending...';

      try {
        const res = await postJson(`/sessions/${sessionId}/send`, { number, message });
        log.textContent = `‚úì Message sent successfully!\n${JSON.stringify(res, null, 2)}`;

        // Update stats
        let totalSent = parseInt(document.getElementById('stat-messages-sent').textContent) || 0;
        document.getElementById('stat-messages-sent').textContent = totalSent + 1;
      } catch (err) {
        log.textContent = `‚úó Error: ${err.message}`;
      }
    });

    // Broadcast message
    document.getElementById('broadcastForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sessionId = document.getElementById('broadcastSessionSelect').value;
      if (!sessionId) {
        document.getElementById('broadcastResult').textContent = 'Please select a session first';
        return;
      }

      let numbers = [];
      let messageTemplate = document.getElementById('broadcastMessage').value.trim();
      const delayMin = parseInt(document.getElementById('delayMin').value) || 3000;
      const delayMax = parseInt(document.getElementById('delayMax').value) || 8000;
      const cooldownAfter = parseInt(document.getElementById('cooldownAfter').value) || 30;
      const cooldownMin = parseInt(document.getElementById('cooldownMin').value) || 120000;
      const cooldownMax = parseInt(document.getElementById('cooldownMax').value) || 300000;

      const log = document.getElementById('broadcastResult');

      // Get numbers based on input method
      if (inputMethod === 'csv') {
        if (csvData.length === 0) {
          log.textContent = '‚úó Upload CSV file dulu!';
          return;
        }

        // Check if message has personalization
        const hasPersonalization = messageTemplate.includes('{name}') && csvData.some(d => d.name);

        if (hasPersonalization) {
          // Use new personalized broadcast endpoint
          log.textContent = '‚ö†Ô∏è Memulai personalized broadcast...\nMohon tunggu...';

          try {
            const res = await postJson(`/sessions/${sessionId}/broadcast-personalized`, {
              csvData: csvData,
              messageTemplate: messageTemplate,
              delayMinMs: delayMin,
              delayMaxMs: delayMax,
              cooldownAfter: cooldownAfter,
              cooldownMinMs: cooldownMin,
              cooldownMaxMs: cooldownMax,
            });
            log.textContent = `‚úì Personalized broadcast job queued!\nJob ID: ${res.jobId}\nTotal: ${res.totals.total}`;
            state.currentJobId = res.jobId;
            pollJob(res.jobId, sessionId, log);
          } catch (err) {
            log.textContent = `‚úó Error: ${err.message}`;
          }
          return;
        } else {
          // No personalization, just send to all numbers
          numbers = csvData.map(d => d.phone);
        }
      } else {
        // Manual input
        const numbersRaw = document.getElementById('broadcastNumbers').value.trim();
        numbers = numbersRaw.split(/\r?\n/).map(n => n.trim()).filter(Boolean);
      }

      if (numbers.length === 0) {
        log.textContent = '‚úó Masukkan nomor tujuan!';
        return;
      }

      log.textContent = 'Queuing broadcast job...';

      try {
        const res = await postJson(`/sessions/${sessionId}/broadcast`, {
          numbers,
          message: messageTemplate,
          delayMinMs: delayMin,
          delayMaxMs: delayMax,
          cooldownAfter,
          cooldownMinMs: cooldownMin,
          cooldownMaxMs: cooldownMax,
        });
        log.textContent = `‚úì Broadcast job queued!\nJob ID: ${res.jobId}\nTotal numbers: ${res.totals.total}`;
        state.currentJobId = res.jobId;
        pollJob(res.jobId, sessionId, log);
      } catch (err) {
        log.textContent = `‚úó Error: ${err.message}`;
      }
    });

    // Poll job status
    async function pollJob(jobId, sessionId, logEl) {
      const poll = async () => {
        try {
          const res = await fetch(`/sessions/${sessionId}/broadcast/${jobId}`).then(r => r.json());
          const job = res.job;
          state.jobs[job.id] = job;
          renderJobList();

          const jobSummary = `Status: ${job.status}\nSent: ${job.totals.sent}/${job.totals.total}\nSkipped: ${job.totals.skipped}\nFailed: ${job.totals.failed}`;
          logEl.textContent = jobSummary;

          if (job.status === 'completed' || job.status === 'failed' || job.status === 'cancelled') {
            updateDashboardStats();
            return;
          }
          setTimeout(poll, 1000);
        } catch (err) {
          logEl.textContent = `Error polling job: ${err.message}`;
        }
      };
      poll();
    }

    // Fetch jobs for session
    async function fetchJobsForSession(sessionId) {
      try {
        const data = await fetch(`/sessions/${sessionId}/broadcast`).then(r => r.json());
        (data.jobs || []).forEach(j => { state.jobs[j.id] = j; });
        renderJobList();
      } catch (err) {
        console.error('Failed to fetch jobs', err);
      }
    }

    // Fetch all jobs with filters
    async function fetchAllJobs(filters = {}) {
      try {
        const params = new URLSearchParams();
        if (filters.startDate) params.append('startDate', filters.startDate);
        if (filters.endDate) params.append('endDate', filters.endDate);
        if (filters.limit) params.append('limit', filters.limit);

        const url = `/jobs${params.toString() ? '?' + params.toString() : ''}`;
        const data = await fetch(url).then(r => r.json());

        // Update state with jobs
        (data.jobs || []).forEach(j => { state.jobs[j.id] = j; });

        // If filtering by session, also filter the rendered list
        let jobsToRender = data.jobs || [];
        if (filters.sessionId) {
          jobsToRender = jobsToRender.filter(j => j.sessionId === filters.sessionId);
        }

        renderJobList(jobsToRender);
      } catch (err) {
        console.error('Failed to fetch jobs', err);
      }
    }

    // Render job list
    function renderJobList(jobListParam = null) {
      const target = document.getElementById('jobList');

      // Use provided list or default to state
      const list = jobListParam || Object.values(state.jobs).sort((a, b) =>
        (b.startedAt || b.requestedAt || 0) - (a.startedAt || a.requestedAt || 0)
      );

      // Update job count
      document.getElementById('jobCount').textContent = list.length;

      if (!list.length) {
        target.innerHTML = '<p style="color: var(--muted);">No jobs yet.</p>';
        return;
      }

      target.innerHTML = list.map(j => {
        const totals = j.totals || { sent: 0, skipped: 0, failed: 0, total: 0 };
        const phase = j.phase || j.status;
        const statusClass = j.status === 'completed' ? 'success' : j.status === 'failed' ? 'error' : 'warning';
        const next = j.nextResumeAt ? `<br><small style="color: var(--muted);">Cooldown until ${new Date(j.nextResumeAt).toLocaleTimeString()}</small>` : '';

        // Format date
        const date = new Date(j.completedAt || j.startedAt || j.requestedAt);
        const dateStr = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });

        return `
          <div class="job-item" style="cursor: pointer;" onclick="viewJobDetail('${j.id}', '${j.sessionId}')">
            <div class="job-item-header">
              <span class="job-item-id">${j.id.substring(0, 8)}...</span>
              <span class="status-badge ${statusClass}">${j.status} (${phase})</span>
              <span style="font-size: 12px; color: var(--muted); margin-left: auto;">${dateStr}</span>
            </div>
            <div class="job-item-stats">
              <div class="job-stat">
                <div class="job-stat-label">Sent</div>
                <div class="job-stat-value">${totals.sent}</div>
              </div>
              <div class="job-stat">
                <div class="job-stat-label">Skipped</div>
                <div class="job-stat-value">${totals.skipped}</div>
              </div>
              <div class="job-stat">
                <div class="job-stat-label">Failed</div>
                <div class="job-stat-value">${totals.failed}</div>
              </div>
              <div class="job-stat">
                <div class="job-stat-label">Total</div>
                <div class="job-stat-value">${totals.total}</div>
              </div>
            </div>
            ${next}
            <div style="margin-top: 8px; font-size: 12px; color: var(--muted);">Session: ${j.sessionId} | Click to view details ‚Üí</div>
          </div>
        `;
      }).join('');
    }

    // View job detail
    let currentJob = null;

    window.viewJobDetail = async function(jobId, sessionId) {
      try {
        const res = await fetch(`/sessions/${sessionId}/broadcast/${jobId}`).then(r => r.json());
        currentJob = res.job;
        state.jobs[jobId] = currentJob;

        // Update UI
        document.getElementById('jobDetailId').textContent = jobId.substring(0, 8) + '...';
        document.getElementById('jobDetailStatus').textContent = currentJob.status;
        document.getElementById('jobDetailPhase').textContent = currentJob.phase || currentJob.status;

        const statusClass = currentJob.status === 'completed' ? 'success' :
                          currentJob.status === 'failed' ? 'error' : 'warning';
        document.getElementById('jobDetailStatus').className = `status-badge ${statusClass}`;

        const totals = currentJob.totals || { sent: 0, skipped: 0, failed: 0, total: 0 };
        document.getElementById('jobDetailSent').textContent = totals.sent;
        document.getElementById('jobDetailSkipped').textContent = totals.skipped;
        document.getElementById('jobDetailFailed').textContent = totals.failed;
        document.getElementById('jobDetailTotal').textContent = totals.total;

        renderJobResults(currentJob.results || []);

        // Show job detail view
        navigateTo('job-detail');
      } catch (err) {
        console.error('Failed to load job details:', err);
        alert('Failed to load job details');
      }
    };

    // Render job results
    function renderJobResults(results, filter = '') {
      const target = document.getElementById('jobResultsList');

      if (!results || results.length === 0) {
        target.innerHTML = '<p style="color: var(--muted);">No results yet.</p>';
        return;
      }

      // Filter results
      let filteredResults = results;
      if (filter) {
        filteredResults = results.filter(r =>
          r.number && r.number.includes(filter)
        );
      }

      target.innerHTML = `
        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
          <thead>
            <tr style="border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.02);">
              <th style="text-align: left; padding: 10px; position: sticky; top: 0; background: #0f172a;">#</th>
              <th style="text-align: left; padding: 10px; position: sticky; top: 0; background: #0f172a;">Phone</th>
              <th style="text-align: left; padding: 10px; position: sticky; top: 0; background: #0f172a;">Status</th>
              <th style="text-align: left; padding: 10px; position: sticky; top: 0; background: #0f172a;">Info</th>
            </tr>
          </thead>
          <tbody>
            ${filteredResults.map((r, i) => {
              const statusClass = r.status === 'sent' ? 'success' :
                                r.status === 'failed' ? 'error' : 'warning';
              const statusIcon = r.status === 'sent' ? '‚úÖ' :
                               r.status === 'failed' ? '‚ùå' : '‚è≠Ô∏è';
              return `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                  <td style="padding: 10px;">${i + 1}</td>
                  <td style="padding: 10px; font-family: monospace;">${r.number || '-'}</td>
                  <td style="padding: 10px;">
                    <span class="status-badge ${statusClass}">${statusIcon} ${r.status}</span>
                  </td>
                  <td style="padding: 10px; color: var(--muted); max-width: 300px; word-wrap: break-word;">
                    ${r.reason || r.error || '-'}
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
        <div style="margin-top: 12px; color: var(--muted); font-size: 13px;">
          Showing ${filteredResults.length} of ${results.length} results
        </div>
      `;
    }

    // Setup job detail view handlers
    function setupJobDetailHandlers() {
      // Back to jobs button
      document.getElementById('backToJobs')?.addEventListener('click', () => {
        window.location.hash = 'jobs';
      });

      // Filter type change
      document.getElementById('jobFilterType')?.addEventListener('change', (e) => {
        const sessionFilter = document.getElementById('jobSessionFilter');
        if (e.target.value === 'session') {
          sessionFilter.style.display = 'block';
        } else {
          sessionFilter.style.display = 'none';
        }
      });

      // Apply filter button
      document.getElementById('applyJobFilter')?.addEventListener('click', async () => {
        const filterType = document.getElementById('jobFilterType').value;
        const sessionId = document.getElementById('jobsSessionSelect').value;
        const startDate = document.getElementById('jobStartDate').value;
        const endDate = document.getElementById('jobEndDate').value;
        const limit = document.getElementById('jobLimit').value;

        const filters = {};
        if (startDate) filters.startDate = startDate;
        if (endDate) filters.endDate = endDate;
        if (limit) filters.limit = limit;
        if (filterType === 'session') filters.sessionId = sessionId;

        await fetchAllJobs(filters);
      });

      // Reset filter button
      document.getElementById('resetJobFilter')?.addEventListener('click', async () => {
        document.getElementById('jobFilterType').value = 'all';
        document.getElementById('jobSessionFilter').style.display = 'none';
        document.getElementById('jobStartDate').value = '';
        document.getElementById('jobEndDate').value = '';
        document.getElementById('jobLimit').value = '100';

        await fetchAllJobs({ limit: 100 });
      });

      // Refresh jobs button
      document.getElementById('refreshJobs')?.addEventListener('click', async () => {
        await applyCurrentJobFilter();
      });

      // Export job results
      document.getElementById('exportJobResults')?.addEventListener('click', () => {
        if (!currentJob || !currentJob.results) {
          alert('No results to export');
          return;
        }

        const results = currentJob.results;
        const csv = 'phone,status,reason,error\n' +
          results.map(r =>
            `${r.number || ''},${r.status || ''},"${r.reason || ''}","${r.error || ''}"`
          ).join('\n');

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `broadcast_results_${currentJob.id.substring(0, 8)}_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      });

      // Filter job results
      document.getElementById('jobResultsFilter')?.addEventListener('input', (e) => {
        const filter = e.target.value.trim();
        if (currentJob && currentJob.results) {
          renderJobResults(currentJob.results, filter);
        }
      });
    }

    // Helper to apply current filter
    async function applyCurrentJobFilter() {
      const filterType = document.getElementById('jobFilterType').value;
      const sessionId = document.getElementById('jobsSessionSelect').value;
      const startDate = document.getElementById('jobStartDate').value;
      const endDate = document.getElementById('jobEndDate').value;
      const limit = document.getElementById('jobLimit').value;

      const filters = {};
      if (startDate) filters.startDate = startDate;
      if (endDate) filters.endDate = endDate;
      if (limit) filters.limit = limit;
      if (filterType === 'session') filters.sessionId = sessionId;

      await fetchAllJobs(filters);
    }

    // Broadcast job updates
    socket.on('broadcastUpdate', ({ sessionId, job }) => {
      state.jobs[job.id] = job;
      if (state.currentView === 'jobs') {
        renderJobList();
      }
      updateDashboardStats();
    });

    // Session removed
    socket.on('sessionRemoved', ({ sessionId }) => {
      delete state.sessions[sessionId];
      delete state.qrMap[sessionId];
      if (state.activeSession === sessionId) {
        state.activeSession = Object.keys(state.sessions)[0] || null;
      }
      updateDashboardStats();
      updateSessionsListView();
      updateAllSessionSelects();
    });

    // Session select change handlers
    document.getElementById('jobsSessionSelect')?.addEventListener('change', (e) => {
      // Filter will be applied when user clicks "Apply Filter"
      // or automatically if in session filter mode
      const filterType = document.getElementById('jobFilterType')?.value;
      if (filterType === 'session') {
        applyCurrentJobFilter();
      }
    });

    document.getElementById('sendSessionSelect')?.addEventListener('change', (e) => {
      state.activeSession = e.target.value;
    });

    document.getElementById('broadcastSessionSelect')?.addEventListener('change', (e) => {
      state.activeSession = e.target.value;
    });

    // Broadcast preset configuration
    const PRESETS = {
      moderate: {
        delayMin: 3000,
        delayMax: 8000,
        cooldownAfter: 30,
        cooldownMin: 120000,
        cooldownMax: 300000,
        description: 'Simulasi behavior manusia natural. Speed: 3-8 detik/pesan. Cooldown setiap 30 pesan (2-5 menit). Risiko: Medium. Cocok untuk broadcast 50-200 nomor.'
      },
      conservative: {
        delayMin: 5000,
        delayMax: 15000,
        cooldownAfter: 20,
        cooldownMin: 180000,
        cooldownMax: 600000,
        description: 'Konfigurasi aman untuk broadcast besar. Speed: 5-15 detik/pesan. Cooldown setiap 20 pesan (3-10 menit). Risiko: Low. Cocok untuk broadcast 200-1000 nomor.'
      },
      'very-conservative': {
        delayMin: 10000,
        delayMax: 30000,
        cooldownAfter: 15,
        cooldownMin: 300000,
        cooldownMax: 900000,
        description: 'Sangat konservatif untuk nomor berharga. Speed: 10-30 detik/pesan. Cooldown setiap 15 pesan (5-15 menit). Risiko: Very Low. Cocok untuk >1000 nomor atau nomor business penting.'
      },
      custom: {
        delayMin: 3000,
        delayMax: 8000,
        cooldownAfter: 30,
        cooldownMin: 120000,
        cooldownMax: 300000,
        description: 'Konfigurasi manual sesuai kebutuhan. Bebas mengatur semua parameter. Pastikan understand risiko sebelum mengubah.'
      }
    };

    // Handle preset change
    const broadcastPreset = document.getElementById('broadcastPreset');
    const presetDescription = document.getElementById('presetDescription');
    const delayMinInput = document.getElementById('delayMin');
    const delayMaxInput = document.getElementById('delayMax');
    const cooldownAfterInput = document.getElementById('cooldownAfter');
    const cooldownMinInput = document.getElementById('cooldownMin');
    const cooldownMaxInput = document.getElementById('cooldownMax');

    function applyPreset(preset) {
      const config = PRESETS[preset];
      if (!config) return;

      delayMinInput.value = config.delayMin;
      delayMaxInput.value = config.delayMax;
      cooldownAfterInput.value = config.cooldownAfter;
      cooldownMinInput.value = config.cooldownMin;
      cooldownMaxInput.value = config.cooldownMax;
      presetDescription.textContent = config.description;

      // Enable/disable cooldown inputs based on preset
      const isCustom = preset === 'custom';
      cooldownMinInput.disabled = !isCustom;
      cooldownMaxInput.disabled = !isCustom;

      // Update estimated time
      updateEstimatedTime();
    }

    // Calculate and display estimated broadcast time
    function updateEstimatedTime() {
      let numbersCount = 0;

      if (inputMethod === 'csv') {
        numbersCount = csvData.length;
      } else {
        const numbersRaw = document.getElementById('broadcastNumbers').value.trim();
        numbersCount = numbersRaw ? numbersRaw.split(/\r?\n/).filter(Boolean).length : 0;
      }

      if (numbersCount === 0) {
        document.getElementById('estimatedTime').textContent = 'Masukkan nomor untuk melihat estimasi';
        return;
      }

      const delayMin = parseInt(delayMinInput.value) || 3000;
      const delayMax = parseInt(delayMaxInput.value) || 8000;
      const cooldownAfter = parseInt(cooldownAfterInput.value) || 30;
      const cooldownMin = parseInt(cooldownMinInput.value) || 120000;
      const cooldownMax = parseInt(cooldownMaxInput.value) || 300000;

      // Calculate estimated time
      const avgDelay = (delayMin + delayMax) / 2;
      const avgCooldown = (cooldownMin + cooldownMax) / 2;
      const cooldownCount = Math.floor(numbersCount / cooldownAfter);
      const totalDelayMs = (numbersCount * avgDelay) + (cooldownCount * avgCooldown);

      const hours = Math.floor(totalDelayMs / 3600000);
      const minutes = Math.floor((totalDelayMs % 3600000) / 60000);
      const seconds = Math.floor((totalDelayMs % 60000) / 1000);

      let timeString = '';
      if (hours > 0) timeString += `${hours} jam `;
      if (minutes > 0) timeString += `${minutes} menit `;
      if (seconds > 0 || timeString === '') timeString += `${seconds} detik`;

      document.getElementById('estimatedTime').innerHTML =
        `<strong>Estimasi waktu:</strong> ${timeString} untuk ${numbersCount} nomor`;
    }

    // Add event listeners for real-time estimation
    document.getElementById('broadcastNumbers')?.addEventListener('input', updateEstimatedTime);
    delayMinInput?.addEventListener('input', updateEstimatedTime);
    delayMaxInput?.addEventListener('input', updateEstimatedTime);
    cooldownAfterInput?.addEventListener('input', updateEstimatedTime);
    cooldownMinInput?.addEventListener('input', updateEstimatedTime);
    cooldownMaxInput?.addEventListener('input', updateEstimatedTime);

    broadcastPreset?.addEventListener('change', (e) => {
      applyPreset(e.target.value);
    });

    // CSV Broadcast handling
    let csvData = [];
    let inputMethod = 'manual';

    // Method switching
    function setupMethodButtons() {
      const methodManualBtn = document.getElementById('methodManual');
      const methodCsvBtn = document.getElementById('methodCsv');

      if (!methodManualBtn || !methodCsvBtn) {
        console.log('Method buttons not found yet');
        return;
      }

      methodManualBtn.addEventListener('click', () => {
        inputMethod = 'manual';
        document.getElementById('manualInput').style.display = 'block';
        document.getElementById('csvInput').style.display = 'none';
        methodManualBtn.style.background = 'var(--accent)';
        methodManualBtn.style.color = 'var(--bg)';
        methodCsvBtn.style.background = 'transparent';
        methodCsvBtn.style.color = 'var(--muted)';
        document.getElementById('personalizationHelper').style.display = 'none';
        updateEstimatedTime();
      });

      methodCsvBtn.addEventListener('click', () => {
        inputMethod = 'csv';
        document.getElementById('manualInput').style.display = 'none';
        document.getElementById('csvInput').style.display = 'block';
        methodCsvBtn.style.background = 'var(--accent)';
        methodCsvBtn.style.color = 'var(--bg)';
        methodManualBtn.style.background = 'transparent';
        methodManualBtn.style.color = 'var(--muted)';
      });

      // Initialize manual button state
      methodManualBtn.click();
    }

    // Download CSV Template
    function setupDownloadTemplate() {
      const downloadBtn = document.getElementById('downloadTemplate');
      if (!downloadBtn) return;

      downloadBtn.addEventListener('click', () => {
        const template = 'phone,name\n6281234567890,Budi Santoso\n6289876543210,Siti Wijaya\n6285555555555,Ahmad Rahman\n\n# Notes:\n# - Kolom "phone" WAJIB (format: country code + nomor)\n# - Kolom "name" OPSIONAL (untuk personalisasi pesan)\n# - Gunakan {name} dalam pesan untuk personalisasi';
        const blob = new Blob([template], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'broadcast_template.csv';
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    // CSV File Upload Handler
    function setupCsvUpload() {
      const csvFileInput = document.getElementById('csvFile');
      if (!csvFileInput) return;

      csvFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          const text = event.target.result;
          parseCSV(text);
        };
        reader.readAsText(file);
      });
    }

    // Preview CSV Handler
    function setupPreviewCsv() {
      const previewBtn = document.getElementById('previewCsv');
      if (!previewBtn) return;

      previewBtn.addEventListener('click', () => {
        if (csvData.length === 0) {
          alert('Upload CSV file dulu!');
          return;
        }

        const previewBody = document.getElementById('previewBody');
        const previewDiv = document.getElementById('csvPreview');

        // Show first 10 rows
        const preview = csvData.slice(0, 10);
        previewBody.innerHTML = preview.map((row, i) => `
          <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
            <td style="padding: 8px;">${i + 1}</td>
            <td style="padding: 8px;">${row.phone}</td>
            <td style="padding: 8px;">${row.name || '-'}</td>
          </tr>
        `).join('');

        document.getElementById('previewCount').textContent = csvData.length;
        previewDiv.style.display = 'block';

        // Show personalization helper if has names
        if (csvData.some(d => d.name)) {
          document.getElementById('personalizationHelper').style.display = 'block';
        }
      });
    }

    // Parse CSV
    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim() && !line.startsWith('#'));
      if (lines.length < 2) {
        alert('CSV tidak valid. Minimal harus ada header + 1 data.');
        return;
      }

      // Parse header
      const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
      const phoneIndex = headers.findIndex(h => h === 'phone' || h === 'nomor' || h === 'number' || h === 'whatsapp');
      const nameIndex = headers.findIndex(h => h === 'name' || h === 'nama' || h === 'nama');

      if (phoneIndex === -1) {
        alert('CSV harus punya kolom "phone"!');
        return;
      }

      // Parse data
      csvData = [];
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        const phone = values[phoneIndex]?.replace(/\D/g, '');
        const name = nameIndex !== -1 ? values[nameIndex] : '';

        if (phone && phone.length >= 8) {
          csvData.push({ phone, name });
        }
      }

      // Show stats
      const validCount = csvData.length;
      const withName = csvData.filter(d => d.name).length;

      document.getElementById('csvStats').innerHTML =
        `‚úÖ Valid: ${validCount} contacts | üè∑Ô∏è Dengan nama: ${withName}`;

      updateEstimatedTime();
    }

    // Initialize with moderate preset
    applyPreset('moderate');

    // Initialize
    async function init() {
      // Load initial sessions
      try {
        const data = await fetch('/sessions').then(r => r.json());
        (data.sessions || []).forEach(s => {
          state.sessions[s.id] = { id: s.id, state: s.state, hasQR: s.hasQR, user: s.user };
        });

        if (data.sessions?.length) {
          state.activeSession = data.sessions[0].id;
        }

        updateAllSessionSelects();
        updateDashboardStats();
        updateSessionsListView();

        // Handle initial hash
        handleHashChange();

        // Setup CSV functionality after DOM is ready
        setupMethodButtons();
        setupDownloadTemplate();
        setupCsvUpload();
        setupPreviewCsv();
        setupJobDetailHandlers();
      } catch (err) {
        console.error('Failed to load sessions', err);
      }
    }

    init();

    // ============================================
    // CHAT & CRM FUNCTIONALITY
    // ============================================

    // Chat State
    const chatState = {
      currentSession: null,
      currentContact: null,
      contacts: {},
      messages: {},
      tags: {},
      leadStatuses: {}
    };

    // Load Chat Contacts
    async function loadChatContacts(sessionId, search = '') {
      if (!sessionId) return;

      try {
        const params = new URLSearchParams({
          sessionId,
          search,
          limit: '50'
        });

        const res = await fetch(`/api/contacts?${params}`);
        const data = await res.json();

        if (!res.ok) throw new Error(data.error);

        chatState.contacts = {};
        data.contacts.forEach(contact => {
          chatState.contacts[contact.id] = contact;
        });

        renderChatContactsList();
      } catch (err) {
        console.error('Failed to load contacts:', err);
      }
    }

    // Render Chat Contacts List
    function renderChatContactsList() {
      const listDiv = document.getElementById('chatContactsList');
      const contacts = Object.values(chatState.contacts).sort((a, b) => {
        // Sort by last interaction (most recent first)
        const aTime = a.lastInteraction ? new Date(a.lastInteraction).getTime() : 0;
        const bTime = b.lastInteraction ? new Date(b.lastInteraction).getTime() : 0;
        return bTime - aTime; // Descending order (newest first)
      });

      if (contacts.length === 0) {
        listDiv.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--muted);">No contacts found</div>';
        return;
      }

      listDiv.innerHTML = contacts.map(contact => {
        const isActive = chatState.currentContact?.id === contact.id;
        const lastMsg = contact.lastMessage;
        const time = lastMsg ? formatMessageTime(lastMsg.timestamp) : '';

        return `
          <div class="contact-item ${isActive ? 'active' : ''}" data-contact-id="${contact.id}">
            <div class="contact-avatar">${contact.name ? contact.name[0] : '?'}</div>
            <div class="contact-item-info">
              <div class="contact-item-name">${contact.name || contact.phone}</div>
              <div class="contact-item-preview">${lastMsg ? lastMsg.content : 'No messages yet'}</div>
            </div>
            <div class="contact-item-meta">
              <div>${time}</div>
            </div>
          </div>
        `;
      }).join('');

      // Add click handlers
      listDiv.querySelectorAll('.contact-item').forEach(item => {
        item.addEventListener('click', () => {
          const contactId = parseInt(item.dataset.contactId);
          openChatContact(contactId);
        });
      });
    }

    // Open Chat with Contact
    async function openChatContact(contactId) {
      const contact = chatState.contacts[contactId];
      if (!contact) return;

      chatState.currentContact = contact;

      // Update UI
      document.getElementById('chatWelcome').style.display = 'none';
      document.getElementById('chatConversation').style.display = 'flex';

      document.getElementById('chatContactName').textContent = contact.name || contact.phone;
      document.getElementById('chatContactPhone').textContent = contact.phone;
      document.getElementById('chatContactAvatar').textContent = contact.name ? contact.name[0] : '?';

      // Load messages
      await loadContactMessages(contact.id);

      // Re-render contacts list to update active state
      renderChatContactsList();

      // Scroll to bottom
      scrollToMessageBottom();
    }

    // Load Messages for Contact
    async function loadContactMessages(contactId) {
      try {
        const sessionId = chatState.currentSession;
        const res = await fetch(`/api/contacts/${contactId}/messages?sessionId=${sessionId}&limit=100`);
        const data = await res.json();

        if (!res.ok) throw new Error(data.error);

        chatState.messages[contactId] = data.messages;
        renderMessages();
      } catch (err) {
        console.error('Failed to load messages:', err);
      }
    }

    // Render Messages
    function renderMessages() {
      const container = document.getElementById('messagesContainer');
      const messages = chatState.messages[chatState.currentContact.id] || [];

      if (messages.length === 0) {
        container.innerHTML = '<div style="text-align: center; color: var(--muted); padding: 40px;">No messages yet. Start the conversation!</div>';
        return;
      }

      container.innerHTML = messages.map(msg => {
        const isOutgoing = msg.direction === 'outgoing';
        const isDeleted = msg.isDeleted || msg.content === '[This message was deleted]';
        const time = formatMessageTime(msg.timestamp);

        // Render media content based on message type
        let mediaContent = '';
        if (msg.type === 'image' && msg.mediaUrl) {
          // Check if it's a local file (filename) or API URL
          const mediaSrc = msg.mediaUrl.startsWith('http') ? `/api/messages/${msg.id}/media?sessionId=${chatState.currentSession}` : `/media/${msg.mediaUrl}`;
          mediaContent = `
            <div class="message-media">
              <img src="${mediaSrc}"
                   alt="${escapeHtml(msg.content)}"
                   style="max-width: 100%; max-height: 300px; border-radius: 8px; cursor: pointer;"
                   onclick="window.open(this.src, '_blank')"
                   onerror="this.parentElement.innerHTML='<span style=\\'color: var(--muted)\\'>Failed to load image</span>'" />
            </div>
          `;
        } else if (msg.type === 'video' && msg.mediaUrl) {
          const mediaSrc = msg.mediaUrl.startsWith('http') ? `/api/messages/${msg.id}/media?sessionId=${chatState.currentSession}` : `/media/${msg.mediaUrl}`;
          mediaContent = `
            <div class="message-media">
              <video controls
                     style="max-width: 100%; max-height: 300px; border-radius: 8px;">
                <source src="${mediaSrc}" type="video/mp4">
                Your browser does not support the video tag.
              </video>
            </div>
          `;
        } else if (msg.type === 'audio' && msg.mediaUrl) {
          const mediaSrc = msg.mediaUrl.startsWith('http') ? `/api/messages/${msg.id}/media?sessionId=${chatState.currentSession}` : `/media/${msg.mediaUrl}`;
          mediaContent = `
            <div class="message-media">
              <audio controls style="width: 100%; max-width: 300px;">
                <source src="${mediaSrc}" type="audio/mpeg">
                Your browser does not support the audio tag.
              </audio>
            </div>
          `;
        } else if (msg.type === 'document' && msg.mediaUrl) {
          const mediaSrc = msg.mediaUrl.startsWith('http') ? `/api/messages/${msg.id}/media?sessionId=${chatState.currentSession}` : `/media/${msg.mediaUrl}`;
          mediaContent = `
            <div class="message-media">
              <a href="${mediaSrc}"
                 target="_blank"
                 download
                 style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; background: rgba(0,0,0,0.1); border-radius: 6px; text-decoration: none; color: inherit;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
                <span>${escapeHtml(msg.content)}</span>
              </a>
            </div>
          `;
        } else if (msg.type === 'location') {
          mediaContent = `
            <div class="message-media">
              <span style="color: var(--muted); font-style: italic;">üìç ${escapeHtml(msg.content)}</span>
            </div>
          `;
        } else if (msg.type === 'contact') {
          mediaContent = `
            <div class="message-media">
              <span style="color: var(--muted); font-style: italic;">üë§ ${escapeHtml(msg.content)}</span>
            </div>
          `;
        }

        // For text messages or messages without media, show the content
        let textContent = '';
        if (isDeleted) {
          // Show deleted message style
          textContent = `<span style="color: var(--muted); font-style: italic;">üóëÔ∏è ${escapeHtml(msg.content)}</span>`;
        } else if (msg.type === 'text' || (!msg.mediaUrl && !mediaContent)) {
          textContent = escapeHtml(msg.content);
        } else if (msg.content && msg.content !== '[Image]' && msg.content !== '[Video]' && msg.content !== '[Audio]' && msg.content !== '[Document]') {
          // Show caption for media messages
          textContent = `<div style="margin-top: 8px;">${escapeHtml(msg.content)}</div>`;
        }

        return `
          <div class="message ${isOutgoing ? 'outgoing' : 'incoming'} ${isDeleted ? 'deleted' : ''}">
            <div class="message-bubble" style="${isDeleted ? 'background: rgba(0,0,0,0.03); opacity: 0.7;' : ''}">
              ${!isDeleted ? mediaContent : ''}
              ${textContent}
              <div class="message-time">
                ${time}
                ${isOutgoing && !isDeleted ? `<span class="message-status">${getMessageStatusIcon(msg.status)}</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Send Message
    async function sendMessage() {
      const input = document.getElementById('messageInput');
      const content = input.value.trim();

      if (!content || !chatState.currentContact || !chatState.currentSession) {
        alert('Please select a session and contact first');
        return;
      }

      try {
        const data = await postJson('/api/chat/send', {
          sessionId: chatState.currentSession,
          phone: chatState.currentContact.phone,
          content,
          type: 'text'
        });

        // postJson throws error if not ok, so if we get here, it succeeded
        input.value = '';
        input.style.height = 'auto'; // Reset height

        // Add message to local state
        const newMessage = {
          id: data.message.id,
          direction: 'outgoing',
          content,
          timestamp: new Date().toISOString(),
          status: 'sent'
        };

        if (!chatState.messages[chatState.currentContact.id]) {
          chatState.messages[chatState.currentContact.id] = [];
        }
        chatState.messages[chatState.currentContact.id].push(newMessage);

        renderMessages();
        scrollToMessageBottom();
      } catch (err) {
        console.error('Failed to send message:', err);
        alert('Failed to send message: ' + err.message);
      }
    }

    // Format Message Time
    function formatMessageTime(timestamp) {
      const date = new Date(timestamp);
      const now = new Date();
      const isToday = date.toDateString() === now.toDateString();

      if (isToday) {
        return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: false });
      } else {
        return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
      }
    }

    // Get Message Status Icon
    function getMessageStatusIcon(status) {
      const icons = {
        sent: '‚úì',
        delivered: '‚úì‚úì',
        read: '‚úì‚úì',
        failed: '‚úó'
      };
      return icons[status] || '?';
    }

    // Scroll to Bottom
    function scrollToMessageBottom() {
      const container = document.getElementById('messagesContainer');
      container.scrollTop = container.scrollHeight;
    }

    // Escape HTML
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Socket.io Event Handlers for Chat
    socket.on('chat.newMessage', (data) => {
      const { sessionId, message, contact } = data;

      // Update contacts if in same session
      if (sessionId === chatState.currentSession) {
        // Add/update contact
        chatState.contacts[contact.id] = contact;

        // Add message
        if (!chatState.messages[contact.id]) {
          chatState.messages[contact.id] = [];
        }
        chatState.messages[contact.id].push(message);

        // If this is the current chat, render
        if (chatState.currentContact?.id === contact.id) {
          renderMessages();
          scrollToMessageBottom();
        }

        // Update contacts list
        renderChatContactsList();
      }
    });

    // Handle message deletion
    socket.on('chat.messageDeleted', (data) => {
      console.log('üóëÔ∏è Received message deleted event:', data);
      const { sessionId, messageId, contactId } = data;

      // Update messages if in same session
      if (sessionId === chatState.currentSession && chatState.messages[contactId]) {
        // Find and update the deleted message (try both id and messageId fields)
        const messageIndex = chatState.messages[contactId].findIndex(msg =>
          (msg.messageId === messageId || msg.id === messageId || msg.messageId === messageId)
        );

        console.log(`  Looking for message ID: ${messageId}, found index: ${messageIndex}`);
        console.log(`  Current contact ID: ${chatState.currentContact?.id}, event contact ID: ${contactId}`);

        if (messageIndex !== -1) {
          console.log(`  ‚úì Updating message at index ${messageIndex}`);
          chatState.messages[contactId][messageIndex].content = '[This message was deleted]';
          chatState.messages[contactId][messageIndex].isDeleted = true;

          // If this is the current chat, render
          if (chatState.currentContact?.id === contactId) {
            console.log('  ‚úì Rendering messages');
            renderMessages();
          } else {
            console.log(`  ‚úó Not current chat, skipping render`);
          }
        } else {
          console.log(`  ‚úó Message not found in local state`);
        }
      } else {
        console.log(`  ‚úó Wrong session or no messages for contact ${contactId}`);
      }
    });

    // Handle history sync completion
    socket.on('chat.historySync', async (data) => {
      const { sessionId, updatedContactIds, stats } = data;

      console.log('üìö History sync completed:', stats);

      // Update contacts list if in same session
      if (sessionId === chatState.currentSession) {
        // Reload all contacts to get updated data
        await loadChatContacts(sessionId);

        // If current chat was updated, reload messages
        if (chatState.currentContact && updatedContactIds.includes(chatState.currentContact.id)) {
          await loadContactMessages(chatState.currentContact.id);
          renderMessages();
          scrollToMessageBottom();
        }
      }
    });

    // Chat Event Listeners
    document.getElementById('chatSessionSelect')?.addEventListener('change', (e) => {
      chatState.currentSession = e.target.value;
      loadChatContacts(chatState.currentSession);
    });

    let searchTimeout;
    document.getElementById('chatSearchInput')?.addEventListener('input', (e) => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        loadChatContacts(chatState.currentSession, e.target.value);
      }, 300);
    });

    document.getElementById('sendMessageBtn')?.addEventListener('click', sendMessage);

    document.getElementById('messageInput')?.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Auto-resize textarea
    document.getElementById('messageInput')?.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = this.scrollHeight + 'px';
    });

    // View Contact Details
    document.getElementById('viewContactBtn')?.addEventListener('click', () => {
      if (chatState.currentContact) {
        showContactDetailModal(chatState.currentContact.id);
      }
    });

    // Sync Chat History
    document.getElementById('refreshChatBtn')?.addEventListener('click', async () => {
      if (!chatState.currentContact || !chatState.currentSession) {
        alert('Please select a contact first');
        return;
      }

      const btn = document.getElementById('refreshChatBtn');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = '‚è≥';
      btn.title = 'Syncing...';

      try {
        const data = await postJson('/api/contacts/' + chatState.currentContact.id + '/sync-history', {
          sessionId: chatState.currentSession
        });

        if (data.success) {
          // Reload messages for this contact
          await loadContactMessages(chatState.currentContact.id);

          // Show result
          alert(`‚úì Sync complete!\n\n${data.synced} new messages synced\n${data.skipped} duplicates skipped`);
        }
      } catch (err) {
        console.error('Failed to sync history:', err);
        alert('Failed to sync chat history: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
        btn.title = 'Refresh';
      }
    });

    // CRM Quick Actions - Update Status
    document.getElementById('updateStatusBtn')?.addEventListener('click', () => {
      if (chatState.currentContact) {
        showContactDetailModal(chatState.currentContact.id);
        // Focus on status dropdown in modal after it opens
        setTimeout(() => {
          const statusSelect = document.getElementById('modalLeadStatusSelect');
          if (statusSelect) statusSelect.focus();
        }, 300);
      }
    });

    // CRM Quick Actions - Add Tag
    document.getElementById('addTagBtn')?.addEventListener('click', () => {
      if (chatState.currentContact) {
        showContactDetailModal(chatState.currentContact.id);
        // Focus on tag input in modal after it opens
        setTimeout(() => {
          const tagInput = document.getElementById('modalTagInput');
          if (tagInput) tagInput.focus();
        }, 300);
      }
    });

    // CRM Quick Actions - Add Note
    document.getElementById('addNoteBtn')?.addEventListener('click', () => {
      if (chatState.currentContact) {
        showContactDetailModal(chatState.currentContact.id);
        // Focus on note input in modal after it opens
        setTimeout(() => {
          const noteInput = document.getElementById('modalNoteInput');
          if (noteInput) noteInput.focus();
        }, 300);
      }
    });

    // ============================================
    // CRM FUNCTIONS
    // ============================================

    const crmState = {
      currentSession: null,
      filters: {
        search: '',
        statusId: '',
        tagIds: []
      },
      pagination: {
        page: 1,
        limit: 50,
        total: 0,
        totalPages: 0
      }
    };

    // Load CRM Data
    async function loadCRMData(sessionId) {
      if (!sessionId) return;

      crmState.currentSession = sessionId;
      await Promise.all([
        loadCRMContacts(sessionId),
        loadCRMTags(sessionId),
        loadCRMLeadStatuses(sessionId)
      ]);

      // Check Google connection
      checkGoogleConnection();
    }

    // Load CRM Contacts
    async function loadCRMContacts(sessionId) {
      try {
        const params = new URLSearchParams({
          sessionId,
          page: crmState.pagination.page,
          limit: crmState.pagination.limit,
          ...crmState.filters
        });

        const res = await fetch(`/api/contacts?${params}`);
        const data = await res.json();

        if (res.ok) {
          // Update pagination state
          if (data.pagination) {
            crmState.pagination = {
              page: data.pagination.page,
              limit: data.pagination.limit,
              total: data.pagination.total,
              totalPages: data.pagination.totalPages
            };
          }
          renderCRMContacts(data.contacts);
          renderPagination();
        }
      } catch (err) {
        console.error('Failed to load CRM contacts:', err);
      }
    }

    // Load CRM Tags
    async function loadCRMTags(sessionId) {
      try {
        const res = await fetch(`/api/tags?sessionId=${sessionId}`);
        const data = await res.json();

        if (res.ok) {
          chatState.tags = {};
          data.tags.forEach(tag => {
            chatState.tags[tag.id] = tag;
          });

          renderCRMTagFilters();
        }
      } catch (err) {
        console.error('Failed to load tags:', err);
      }
    }

    // Load CRM Lead Statuses
    async function loadCRMLeadStatuses(sessionId) {
      try {
        const res = await fetch(`/api/lead-statuses?sessionId=${sessionId}`);
        const data = await res.json();

        if (res.ok) {
          chatState.leadStatuses = {};
          data.statuses.forEach(status => {
            chatState.leadStatuses[status.id] = status;
          });

          renderCRMStatusFilters();
        }
      } catch (err) {
        console.error('Failed to load lead statuses:', err);
      }
    }

    // Render CRM Contacts
    function renderCRMContacts(contacts) {
      const gridDiv = document.getElementById('crmContactsCards');
      const { page, limit, total, totalPages } = crmState.pagination;

      // Show range and total
      const start = total === 0 ? 0 : (page - 1) * limit + 1;
      const end = Math.min(page * limit, total);
      document.getElementById('crmContactCount').textContent = `Showing ${start}-${end} of ${total} contacts`;

      if (contacts.length === 0) {
        gridDiv.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--muted); padding: 40px;">No contacts found</div>';
        return;
      }

      gridDiv.innerHTML = contacts.map(contact => {
        const status = chatState.leadStatuses[contact.leadStatusId];
        const tags = (contact.tagIds || []).map(tagId => chatState.tags[tagId]).filter(Boolean);

        return `
          <div class="contact-card" data-contact-id="${contact.id}">
            <div class="contact-card-header">
              <div class="contact-card-avatar">${contact.name ? contact.name[0] : '?'}</div>
              <div class="contact-card-info">
                <div class="contact-card-name">${contact.name || contact.phone}</div>
                <div class="contact-card-phone">${contact.phone}</div>
              </div>
            </div>
            <div class="contact-card-tags">
              ${status ? `<span class="lead-status-badge" style="background: ${status.color}20; color: ${status.color}">${status.name}</span>` : ''}
              ${tags.map(tag => `<span class="tag-badge" style="background: ${tag.color}20; color: ${tag.color}">${tag.name}</span>`).join('')}
            </div>
            <div class="contact-card-meta">
              <span>Last interaction: ${contact.lastInteraction ? formatDate(contact.lastInteraction) : 'Never'}</span>
              <span>${contact.messageCount || 0} messages</span>
            </div>
          </div>
        `;
      }).join('');

      // Add click handlers
      gridDiv.querySelectorAll('.contact-card').forEach(card => {
        card.addEventListener('click', () => {
          const contactId = parseInt(card.dataset.contactId);
          showContactDetailModal(contactId);
        });
      });
    }

    // Render Pagination
    function renderPagination() {
      const { page, limit, total, totalPages } = crmState.pagination;
      const container = document.getElementById('crmPagination');

      if (!container) return;

      // Hide pagination if only 1 page or no contacts
      if (totalPages <= 1) {
        container.style.display = 'none';
        return;
      }

      container.style.display = 'flex';

      // Build page numbers (show max 5 page numbers)
      let pageNumbers = [];
      const maxVisible = 5;
      let startPage = Math.max(1, page - Math.floor(maxVisible / 2));
      let endPage = Math.min(totalPages, startPage + maxVisible - 1);

      if (endPage - startPage < maxVisible - 1) {
        startPage = Math.max(1, endPage - maxVisible + 1);
      }

      for (let i = startPage; i <= endPage; i++) {
        pageNumbers.push(i);
      }

      container.innerHTML = `
        <button class="pagination-btn" ${page === 1 ? 'disabled' : ''} data-page="${page - 1}">
          ‚Äπ Previous
        </button>
        ${startPage > 1 ? '<span class="pagination-ellipsis">...</span>' : ''}
        ${pageNumbers.map(p => `
          <button class="pagination-btn ${p === page ? 'active' : ''}" data-page="${p}">
            ${p}
          </button>
        `).join('')}
        ${endPage < totalPages ? '<span class="pagination-ellipsis">...</span>' : ''}
        <button class="pagination-btn" ${page === totalPages ? 'disabled' : ''} data-page="${page + 1}">
          Next ‚Ä∫
        </button>
      `;

      // Add click handlers
      container.querySelectorAll('.pagination-btn').forEach(btn => {
        if (!btn.disabled) {
          btn.addEventListener('click', () => {
            const newPage = parseInt(btn.dataset.page);
            crmState.pagination.page = newPage;
            loadCRMContacts(crmState.currentSession);
          });
        }
      });
    }

    // Go to specific page
    function goToPage(pageNum) {
      const { totalPages } = crmState.pagination;
      if (pageNum < 1 || pageNum > totalPages) return;
      crmState.pagination.page = pageNum;
      loadCRMContacts(crmState.currentSession);
    }

    // Reset to first page (called when filters change)
    function resetPagination() {
      crmState.pagination.page = 1;
    }

    // Render Tag Filters
    function renderCRMTagFilters() {
      const container = document.getElementById('crmTagsFilter');
      const tags = Object.values(chatState.tags);

      if (tags.length === 0) {
        container.innerHTML = '<div style="color: var(--muted); font-size: 13px;">No tags</div>';
        return;
      }

      container.innerHTML = tags.map(tag => `
        <label class="tag-checkbox">
          <input type="checkbox" value="${tag.id}" data-tag-name="${tag.name}">
          <span style="color: ${tag.color}">${tag.name}</span>
        </label>
      `).join('');

      // Add change handlers
      container.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
          crmState.filters.tagIds = Array.from(container.querySelectorAll('input:checked')).map(cb => parseInt(cb.value));
          resetPagination();
          loadCRMContacts(crmState.currentSession);
        });
      });
    }

    // Render Status Filters
    function renderCRMStatusFilters() {
      const select = document.getElementById('crmStatusFilter');
      const statuses = Object.values(chatState.leadStatuses);

      select.innerHTML = '<option value="">All Statuses</option>' +
        statuses.map(s => `<option value="${s.id}">${s.name}</option>`).join('');

      select.addEventListener('change', (e) => {
        crmState.filters.statusId = e.target.value;
        resetPagination();
        loadCRMContacts(crmState.currentSession);
      });
    }

    // Contact Detail Modal
    async function showContactDetailModal(contactId) {
      const modal = document.getElementById('contactDetailModal');
      modal.classList.add('active');

      try {
        const res = await fetch(`/api/contacts/${contactId}?sessionId=${crmState.currentSession}`);
        const data = await res.json();

        if (res.ok) {
          renderContactDetailModal(data.contact);
        }
      } catch (err) {
        console.error('Failed to load contact details:', err);
      }
    }

    // Render Contact Detail Modal
    function renderContactDetailModal(contact) {
      const modalBody = document.getElementById('contactDetailModalBody');

      const status = chatState.leadStatuses[contact.leadStatusId];
      const tags = contact.tags || [];

      modalBody.innerHTML = `
        <div class="contact-detail-header">
          <div class="contact-avatar">${contact.name ? contact.name[0] : '?'}</div>
          <h3>${contact.name || 'Unknown'}</h3>
          <p style="color: var(--muted);">${contact.phone}</p>
        </div>

        <div class="contact-detail-section">
          <h4>Lead Status</h4>
          <select id="contactStatusSelect">
            ${Object.values(chatState.leadStatuses).map(s =>
              `<option value="${s.id}" ${s.id === contact.leadStatusId ? 'selected' : ''}>${s.name}</option>`
            ).join('')}
          </select>
        </div>

        <div class="contact-detail-section">
          <h4>Tags</h4>
          <div class="contact-tags-list">
            ${tags.map(tag =>
              `<span class="tag-badge" style="background: ${tag.color}20; color: ${tag.color}; padding: 6px 12px;">
                ${tag.name}
              </span>`
            ).join('')}
          </div>
          <button id="addTagToContact" class="btn-sm">+ Add Tag</button>
        </div>

        <div class="contact-detail-section">
          <h4>Notes</h4>
          <div id="contactNotesList">
            ${(contact.notes || []).map(note =>
              `<div class="note-item">
                <div style="font-size: 12px; color: var(--muted); margin-bottom: 4px;">${formatDateTime(note.createdAt)}</div>
                <div>${escapeHtml(note.content)}</div>
              </div>`
            ).join('')}
          </div>
          <textarea id="newNoteContent" placeholder="Add a note..." rows="2" style="margin-bottom: 8px;"></textarea>
          <button id="addNoteToContact" class="btn-sm">Add Note</button>
        </div>

        <div class="modal-actions">
          <button id="openChatFromModal" class="btn-primary">Open Chat</button>
        </div>
      `;

      // Add event listeners
      document.getElementById('contactStatusSelect')?.addEventListener('change', async (e) => {
        await updateContactStatus(contact.id, e.target.value);
      });

      document.getElementById('addNoteToContact')?.addEventListener('click', async () => {
        const content = document.getElementById('newNoteContent').value.trim();
        if (content) {
          await addNoteToContact(contact.id, content);
        }
      });

      document.getElementById('openChatFromModal')?.addEventListener('click', async () => {
        // First, ensure the contact is in chatState.contacts
        if (!chatState.contacts[contact.id]) {
          chatState.contacts[contact.id] = contact;
        }

        // Ensure we have the correct session set
        if (!chatState.currentSession) {
          chatState.currentSession = contact.sessionId;
        }

        // Close modal and navigate to chat
        const modal = document.getElementById('contactDetailModal');
        modal.classList.remove('active');
        window.location.hash = 'chat';

        // Wait for view to switch, then open chat
        setTimeout(() => {
          openChatContact(contact.id);
        }, 200);
      });
    }

    // Update Contact Status
    async function updateContactStatus(contactId, statusId) {
      try {
        const res = await fetch(`/api/contacts/${contactId}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId: crmState.currentSession, statusId })
        });

        if (res.ok) {
          alert('Status updated!');
          loadCRMContacts(crmState.currentSession);
        }
      } catch (err) {
        console.error('Failed to update status:', err);
        alert('Failed to update status');
      }
    }

    // Add Note to Contact
    async function addNoteToContact(contactId, content) {
      try {
        const res = await fetch(`/api/contacts/${contactId}/notes`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId: crmState.currentSession, content })
        });

        if (res.ok) {
          document.getElementById('newNoteContent').value = '';
          showContactDetailModal(contactId); // Reload modal
        }
      } catch (err) {
        console.error('Failed to add note:', err);
        alert('Failed to add note');
      }
    }

    // Format Date
    function formatDate(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
    }

    // Format DateTime
    function formatDateTime(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // ============================================
    // GOOGLE CONTACTS INTEGRATION
    // ============================================

    // Check Google Connection Status
    async function checkGoogleConnection() {
      if (!crmState.currentSession) return;

      try {
        const res = await fetch(`/api/google/sync-status?sessionId=${crmState.currentSession}`);
        const data = await res.json();

        if (data.connected) {
          document.getElementById('googleStatus').style.display = 'flex';
          document.getElementById('googleNotConnected').style.display = 'none';
        } else {
          document.getElementById('googleStatus').style.display = 'none';
          document.getElementById('googleNotConnected').style.display = 'flex';
        }
      } catch (err) {
        console.error('Failed to check Google connection:', err);
      }
    }

    // Connect to Google
    document.getElementById('connectGoogleBtn')?.addEventListener('click', () => {
      window.location.href = '/auth/google';
    });

    // Disconnect Google
    document.getElementById('disconnectGoogleBtn')?.addEventListener('click', async () => {
      if (!crmState.currentSession) return;

      try {
        const res = await fetch('/api/google/disconnect', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId: crmState.currentSession })
        });

        if (res.ok) {
          checkGoogleConnection();
        }
      } catch (err) {
        console.error('Failed to disconnect Google:', err);
      }
    });

    // Sync Google Contacts
    document.getElementById('syncGoogleBtn')?.addEventListener('click', async () => {
      if (!crmState.currentSession) {
        alert('Please select a session first');
        return;
      }

      const btn = document.getElementById('syncGoogleBtn');
      btn.disabled = true;
      btn.textContent = 'üîÑ Syncing...';

      try {
        const res = await fetch('/api/google/sync-contacts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId: crmState.currentSession })
        });

        const data = await res.json();

        if (data.success) {
          alert(`Successfully synced ${data.synced} new contacts, ${data.merged} merged!`);
          await loadCRMContacts(crmState.currentSession);
        } else {
          alert('Failed to sync: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        console.error('Failed to sync Google contacts:', err);
        alert('Failed to sync Google contacts: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üìá Sync Google Contacts';
      }
    });

    // Sync WhatsApp Contacts
    document.getElementById('syncWhatsAppBtn')?.addEventListener('click', async () => {
      if (!crmState.currentSession) {
        alert('Please select a session first');
        return;
      }

      const btn = document.getElementById('syncWhatsAppBtn');
      btn.disabled = true;
      btn.textContent = 'üì± Syncing...';

      try {
        const res = await fetch('/api/whatsapp/sync-contacts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId: crmState.currentSession })
        });

        const data = await res.json();

        if (data.success) {
          alert(`Successfully synced ${data.synced || 0} new contacts, ${data.updated || 0} updated!`);
          await loadCRMContacts(crmState.currentSession);
        } else {
          alert('Failed to sync: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        console.error('Failed to sync WhatsApp contacts:', err);
        alert('Failed to sync WhatsApp contacts: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'üì± Sync WhatsApp';
      }
    });

    // Socket.io event for Google sync completion
    socket.on('google.contactsSynced', (data) => {
      console.log(`Synced ${data.count} contacts from Google`);
      if (data.sessionId === crmState.currentSession) {
        loadCRMContacts(data.sessionId);
      }
    });

    // CRM Session Select
    document.getElementById('crmSessionSelect')?.addEventListener('change', (e) => {
      loadCRMData(e.target.value);
    });

    // CRM Search
    let crmSearchTimeout;
    document.getElementById('crmSearchInput')?.addEventListener('input', (e) => {
      clearTimeout(crmSearchTimeout);
      crmSearchTimeout = setTimeout(() => {
        crmState.filters.search = e.target.value;
        resetPagination();
        loadCRMContacts(crmState.currentSession);
      }, 300);
    });

    // Close Modal
    document.getElementById('closeContactModal')?.addEventListener('click', () => {
      document.getElementById('contactDetailModal').classList.remove('active');
    });

    document.getElementById('contactDetailModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'contactDetailModal') {
        e.target.classList.remove('active');
      }
    });

    // Update existing updateAllSessionSelects function to include new selectors
    const originalUpdateAllSessionSelects = window.updateAllSessionSelects;
    if (typeof originalUpdateAllSessionSelects === 'function') {
      window.updateAllSessionSelects = function() {
        originalUpdateAllSessionSelects();

        // Update chat and CRM session selectors
        const newSelects = ['chatSessionSelect', 'crmSessionSelect'];
        newSelects.forEach(selectId => {
          const select = document.getElementById(selectId);
          if (select) {
            select.innerHTML = '<option value="">Select Session...</option>';
            Object.values(state.sessions).forEach(s => {
              const option = document.createElement('option');
              option.value = s.id;
              option.textContent = s.id + (s.user?.name ? ` (${s.user.name})` : '');
              select.appendChild(option);
            });

            // Set default value if active session exists
            if (state.activeSession) {
              select.value = state.activeSession;
            }
          }
        });

        // Initialize chat and CRM with active session
        if (state.activeSession) {
          chatState.currentSession = state.activeSession;
          crmState.currentSession = state.activeSession;
          loadChatContacts(state.activeSession);
          loadCRMData(state.activeSession);
        }
      };
    }

    // Enhance existing navigation to handle chat and contacts views
    const originalNavigateTo = window.navigateTo;
    if (typeof originalNavigateTo === 'function') {
      window.navigateTo = function(viewId) {
        originalNavigateTo(viewId);

        // Load data when navigating to chat or contacts
        if (viewId === 'chat' && chatState.currentSession) {
          loadChatContacts(chatState.currentSession);
        } else if (viewId === 'contacts' && crmState.currentSession) {
          loadCRMData(crmState.currentSession);
        }
      };
    }
  </script>
</body>
</html>
