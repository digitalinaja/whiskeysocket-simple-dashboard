<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhiskeySocket Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --panel-light: rgba(255,255,255,0.03);
      --accent: #06b6d4;
      --accent-hover: #0891b2;
      --text: #e5e7eb;
      --muted: #94a3b8;
      --danger: #f43f5e;
      --success: #22c55e;
      --warning: #f59e0b;
      --border: rgba(255,255,255,0.06);
      --sidebar-width: 260px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Space Grotesk', system-ui, sans-serif;
      background: radial-gradient(circle at 10% 20%, #0b1225 0, #0f172a 40%, #0b1225 75%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
    }

    /* Sidebar Styles */
    .sidebar {
      width: var(--sidebar-width);
      background: linear-gradient(180deg, var(--panel) 0%, rgba(17, 24, 39, 0.95) 100%);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      z-index: 100;
      transition: transform 0.3s ease;
    }

    .sidebar-header {
      padding: 24px 20px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-header h1 {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: -0.03em;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-header .logo-icon {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-hover) 100%);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      color: var(--bg);
    }

    .nav-menu {
      padding: 16px 12px;
      flex: 1;
    }

    .nav-section {
      margin-bottom: 24px;
    }

    .nav-section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--muted);
      padding: 8px 12px 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--muted);
      text-decoration: none;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .nav-item:hover {
      background: var(--panel-light);
      color: var(--text);
    }

    .nav-item.active {
      background: linear-gradient(135deg, rgba(6, 182, 212, 0.15) 0%, rgba(6, 182, 212, 0.05) 100%);
      color: var(--accent);
      border: 1px solid rgba(6, 182, 212, 0.2);
    }

    .nav-item .icon {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 32px;
      min-height: 100vh;
      transition: margin-left 0.3s ease;
    }

    .page-header {
      margin-bottom: 32px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.03em;
      margin-bottom: 8px;
    }

    .page-subtitle {
      color: var(--muted);
      font-size: 15px;
    }

    /* Views */
    .view {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .view.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Cards */
    .card {
      background: linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.35);
      margin-bottom: 20px;
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* Dashboard Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .stat-icon {
      width: 56px;
      height: 56px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: rgba(6, 182, 212, 0.1);
      color: var(--accent);
    }

    .stat-content {
      flex: 1;
    }

    .stat-label {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      letter-spacing: -0.03em;
    }

    /* Forms */
    .form-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 14px;
      color: var(--text);
    }

    input, textarea, select, button {
      width: 100%;
      padding: 12px 16px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.04);
      color: var(--text);
      font-size: 15px;
      font-family: inherit;
      transition: all 0.2s ease;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(255,255,255,0.06);
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    button {
      cursor: pointer;
      border: none;
      background: var(--accent);
      color: var(--bg);
      font-weight: 600;
      transition: all 0.2s ease;
    }

    button:hover:not(:disabled) {
      background: var(--accent-hover);
      transform: translateY(-1px);
      box-shadow: 0 10px 25px rgba(6, 182, 212, 0.3);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    input:disabled, select:disabled, textarea:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: rgba(255,255,255,0.02);
    }

    button.btn-danger {
      background: var(--danger);
      color: white;
    }

    button.btn-danger:hover:not(:disabled) {
      background: #e11d48;
      box-shadow: 0 10px 25px rgba(244, 63, 94, 0.3);
    }

    button.btn-ghost {
      background: transparent;
      color: var(--muted);
      border: 1px solid var(--border);
    }

    button.btn-ghost:hover:not(:disabled) {
      background: var(--panel-light);
      color: var(--text);
    }

    button.btn-ghost.active {
      background: var(--accent) !important;
      color: var(--bg) !important;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    /* Status Indicators */
    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 8px;
    }

    .status-dot.connected { background: var(--success); box-shadow: 0 0 10px var(--success); }
    .status-dot.qr { background: var(--accent); box-shadow: 0 0 10px var(--accent); }
    .status-dot.disconnected { background: var(--danger); }

    .status-badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border);
    }

    .status-badge.success {
      background: rgba(34, 197, 94, 0.1);
      border-color: rgba(34, 197, 94, 0.2);
      color: var(--success);
    }

    .status-badge.warning {
      background: rgba(245, 158, 11, 0.1);
      border-color: rgba(245, 158, 11, 0.2);
      color: var(--warning);
    }

    .status-badge.error {
      background: rgba(244, 63, 94, 0.1);
      border-color: rgba(244, 63, 94, 0.2);
      color: var(--danger);
    }

    /* Session List */
    .session-item {
      background: var(--panel-light);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .session-item:hover {
      border-color: rgba(6, 182, 212, 0.3);
      background: rgba(6, 182, 212, 0.05);
    }

    .session-item.active {
      border-color: var(--accent);
      background: rgba(6, 182, 212, 0.1);
    }

    .session-item-info {
      flex: 1;
    }

    .session-item-name {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .session-item-status {
      font-size: 13px;
      color: var(--muted);
    }

    /* QR Code */
    .qr-box {
      display: grid;
      place-items: center;
      background: rgba(255,255,255,0.04);
      border: 1px dashed var(--border);
      border-radius: 12px;
      min-height: 280px;
      padding: 20px;
      margin: 20px 0;
    }

    #qrCanvas {
      width: 100%;
      max-width: 280px;
    }

    /* Job List */
    .job-list {
      max-height: 500px;
      overflow-y: auto;
    }

    .job-item {
      background: var(--panel-light);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
    }

    .job-item-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .job-item-id {
      font-family: monospace;
      font-size: 13px;
      color: var(--muted);
    }

    .job-item-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    .job-stat {
      text-align: center;
      padding: 8px;
      background: rgba(255,255,255,0.02);
      border-radius: 8px;
    }

    .job-stat-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .job-stat-value {
      font-size: 18px;
      font-weight: 600;
    }

    /* Log Output */
    .log {
      font-family: 'SF Mono', 'Consolas', monospace;
      color: var(--muted);
      font-size: 13px;
      white-space: pre-wrap;
      background: rgba(0,0,0,0.3);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 12px;
      max-height: 200px;
      overflow-y: auto;
    }

    /* Mobile Menu Toggle */
    .mobile-menu-toggle {
      display: none;
      position: fixed;
      top: 16px;
      right: 16px;
      z-index: 1000;
      background: var(--accent);
      border: none;
      border-radius: 8px;
      width: 44px;
      height: 44px;
      cursor: pointer;
      color: var(--bg);
      font-size: 20px;
    }

    /* Mobile Responsive */
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .sidebar.open {
        transform: translateX(0);
      }

      .main-content {
        margin-left: 0;
        padding: 80px 16px 24px;
      }

      .mobile-menu-toggle {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }
    }

    /* Session selector in main content */
    .session-selector {
      background: var(--panel-light);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 24px;
    }

    .session-selector-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }
  </style>
</head>
<body>
  <!-- Mobile Menu Toggle -->
  <button class="mobile-menu-toggle" id="mobileMenuToggle">
    ‚ò∞
  </button>

  <!-- Sidebar -->
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <h1>
        <div class="logo-icon">W</div>
        WhiskeySocket
      </h1>
    </div>

    <nav class="nav-menu">
      <div class="nav-section">
        <div class="nav-section-title">Main</div>
        <a href="#dashboard" class="nav-item active" data-view="dashboard">
          <span class="icon">üìä</span>
          <span>Dashboard</span>
        </a>
        <a href="#sessions" class="nav-item" data-view="sessions">
          <span class="icon">üì±</span>
          <span>Sessions</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Messaging</div>
        <a href="#send-message" class="nav-item" data-view="send-message">
          <span class="icon">üí¨</span>
          <span>Send Message</span>
        </a>
        <a href="#broadcast" class="nav-item" data-view="broadcast">
          <span class="icon">üì¢</span>
          <span>Broadcast</span>
        </a>
      </div>

      <div class="nav-section">
        <div class="nav-section-title">Monitoring</div>
        <a href="#jobs" class="nav-item" data-view="jobs">
          <span class="icon">üìã</span>
          <span>Broadcast Jobs</span>
        </a>
      </div>
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Dashboard View -->
    <div id="view-dashboard" class="view active">
      <div class="page-header">
        <h2 class="page-title">Dashboard</h2>
        <p class="page-subtitle">Overview of your WhatsApp sessions and activities</p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üì±</div>
          <div class="stat-content">
            <div class="stat-label">Total Sessions</div>
            <div class="stat-value" id="stat-total-sessions">0</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-content">
            <div class="stat-label">Connected</div>
            <div class="stat-value" id="stat-connected">0</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üìã</div>
          <div class="stat-content">
            <div class="stat-label">Active Jobs</div>
            <div class="stat-value" id="stat-active-jobs">0</div>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">‚úâÔ∏è</div>
          <div class="stat-content">
            <div class="stat-label">Messages Sent</div>
            <div class="stat-value" id="stat-messages-sent">0</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h3 class="card-title">üìä Session Status Overview</h3>
        <div id="dashboard-sessions">Loading...</div>
      </div>
    </div>

    <!-- Sessions View -->
    <div id="view-sessions" class="view">
      <div class="page-header">
        <h2 class="page-title">Sessions</h2>
        <p class="page-subtitle">Manage your WhatsApp sessions</p>
      </div>

      <div class="card">
        <h3 class="card-title">‚ûï Create New Session</h3>
        <div class="btn-group" style="margin-bottom: 16px;">
          <input id="newSessionId" placeholder="Enter session ID (e.g., personal, work)" style="flex: 1; max-width: 300px;">
          <button id="createSessionBtn">Create Session</button>
        </div>
        <div class="log" id="sessionCreateLog"></div>
      </div>

      <div class="card">
        <h3 class="card-title">üì± All Sessions</h3>
        <div id="sessions-list">Loading sessions...</div>
      </div>
    </div>

    <!-- Session Detail View -->
    <div id="view-session-detail" class="view">
      <div class="page-header">
        <h2 class="page-title">Session: <span id="session-detail-name">-</span></h2>
        <p class="page-subtitle">Manage this WhatsApp session</p>
      </div>

      <div class="card">
        <h3 class="card-title">üìä Connection Status</h3>
        <div style="margin-bottom: 16px;">
          <span class="status-badge" id="session-status-badge">
            <span class="status-dot" id="session-status-dot"></span>
            <span id="session-status-text">Loading...</span>
          </span>
          <span class="status-badge" style="margin-left: 8px;" id="session-user-badge">User: -</span>
        </div>

        <div class="qr-box">
          <canvas id="qrCanvas"></canvas>
          <div id="qrPlaceholder" style="color: var(--muted);">QR code will appear here when needed</div>
        </div>

        <div class="btn-group">
          <button id="logoutBtn" class="btn-danger">Logout Session</button>
          <button id="deleteSessionBtn" class="btn-ghost">Remove Session</button>
        </div>

        <div class="log" id="sessionActionLog" style="margin-top: 16px;"></div>
      </div>
    </div>

    <!-- Send Message View -->
    <div id="view-send-message" class="view">
      <div class="page-header">
        <h2 class="page-title">Send Message</h2>
        <p class="page-subtitle">Send a message to a single WhatsApp number</p>
      </div>

      <div class="session-selector">
        <label>Active Session:</label>
        <div class="session-selector-row">
          <select id="sendSessionSelect"></select>
        </div>
      </div>

      <div class="card">
        <form id="sendForm">
          <div class="form-group">
            <label for="sendNumber">Phone Number</label>
            <input type="text" id="sendNumber" placeholder="62812xxxxxxx (include country code, digits only)" required>
            <small style="color: var(--muted); display: block; margin-top: 4px;">Format: Country code + number (e.g., 628123456789)</small>
          </div>

          <div class="form-group">
            <label for="sendMessage">Message</label>
            <textarea id="sendMessage" placeholder="Type your message here..." required></textarea>
          </div>

          <button type="submit">Send Message</button>
        </form>

        <div class="log" id="sendResult" style="margin-top: 16px;"></div>
      </div>
    </div>

    <!-- Broadcast View -->
    <div id="view-broadcast" class="view">
      <div class="page-header">
        <h2 class="page-title">Broadcast Message</h2>
        <p class="page-subtitle">Send messages to multiple numbers</p>
      </div>

      <div class="session-selector">
        <label>Active Session:</label>
        <div class="session-selector-row">
          <select id="broadcastSessionSelect"></select>
        </div>
      </div>

      <div class="card">
        <form id="broadcastForm">
          <div class="form-group">
            <label for="broadcastPreset">Speed Preset</label>
            <select id="broadcastPreset">
              <option value="moderate">üü° Moderate - Broadcast 50-200 nomor</option>
              <option value="conservative">üü¢ Conservative - Broadcast 200-1000 nomor</option>
              <option value="very-conservative">üîí Very Conservative - Nomor penting / >1000 nomor</option>
              <option value="custom">‚öôÔ∏è Custom - Konfigurasi manual</option>
            </select>
            <small id="presetDescription" style="color: var(--muted); display: block; margin-top: 4px;">
              Simulasi behavior manusia natural. Speed: 3-8 detik/pesan. Cooldown setiap 30 pesan. Risiko: Medium.
            </small>
          </div>

          <div class="form-group">
            <label>Input Method</label>
            <div class="btn-group">
              <button type="button" id="methodManual" style="flex:1;">üìù Manual Input</button>
              <button type="button" id="methodCsv" style="flex:1;">üìÅ Upload CSV</button>
            </div>
          </div>

          <div id="manualInput">
            <div class="form-group">
              <label for="broadcastNumbers">Phone Numbers (one per line)</label>
              <textarea id="broadcastNumbers" placeholder="6281234567890&#10;6289876543210&#10;6285555555555"></textarea>
              <small style="color: var(--muted); display: block; margin-top: 4px;">Format: Country code + number, one per line</small>
            </div>
          </div>

          <div id="csvInput" style="display: none;">
            <div class="form-group">
              <label for="csvFile">Upload CSV File</label>
              <input type="file" id="csvFile" accept=".csv" style="padding: 8px;">
              <div style="display: flex; gap: 8px; margin-top: 8px;">
                <button type="button" id="downloadTemplate" class="btn-ghost" style="flex: 1;">üì• Download Template</button>
                <button type="button" id="previewCsv" class="btn-ghost" style="flex: 1;">üëÅÔ∏è Preview Data</button>
              </div>
              <small style="color: var(--muted); display: block; margin-top: 4px;">
                CSV harus punya kolom: <strong>phone</strong> (wajib), <strong>name</strong> (opsional untuk personalisasi)
              </small>
            </div>

            <div id="csvPreview" style="display: none;">
              <label>Preview Data (<span id="previewCount">0</span> contacts)</label>
              <div style="max-height: 200px; overflow-y: auto; border: 1px solid var(--border); border-radius: 8px; padding: 12px; background: rgba(0,0,0,0.2);">
                <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                  <thead>
                    <tr style="border-bottom: 1px solid var(--border);">
                      <th style="text-align: left; padding: 8px;">#</th>
                      <th style="text-align: left; padding: 8px;">Phone</th>
                      <th style="text-align: left; padding: 8px;">Name</th>
                    </tr>
                  </thead>
                  <tbody id="previewBody"></tbody>
                </table>
              </div>
              <div id="csvStats" style="margin-top: 8px; font-size: 13px; color: var(--muted);"></div>
            </div>
          </div>

          <div class="form-group">
            <label for="broadcastMessage">Message</label>
            <textarea id="broadcastMessage" placeholder="Type your broadcast message here... Gunakan {name} untuk personalisasi." required></textarea>
            <div id="personalizationHelper" style="display: none; margin-top: 8px;">
              <small style="color: var(--accent);">
                üí° <strong>Personalisasi tersedia:</strong> Gunakan {name} dalam pesan untuk menyebut nama penerima.
                <br>Contoh: "Halo {name}, kami ingin menginformasikan..."
              </small>
            </div>
          </div>

          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 16px;">
            <div>
              <label for="delayMin">Min Delay (ms)</label>
              <input type="number" id="delayMin" value="3000" min="0">
              <small style="color: var(--muted);">Delay minimum antar pesan</small>
            </div>
            <div>
              <label for="delayMax">Max Delay (ms)</label>
              <input type="number" id="delayMax" value="8000" min="0">
              <small style="color: var(--muted);">Delay maximum antar pesan</small>
            </div>
            <div>
              <label for="cooldownAfter">Cooldown After (messages)</label>
              <input type="number" id="cooldownAfter" value="30" min="0">
              <small style="color: var(--muted);">Jeda setiap X pesan</small>
            </div>
            <div>
              <label for="cooldownMin">Cooldown Min (ms)</label>
              <input type="number" id="cooldownMin" value="120000" min="0" disabled>
              <small style="color: var(--muted);">Durasi cooldown minimum</small>
            </div>
            <div>
              <label for="cooldownMax">Cooldown Max (ms)</label>
              <input type="number" id="cooldownMax" value="300000" min="0" disabled>
              <small style="color: var(--muted);">Durasi cooldown maximum</small>
            </div>
          </div>

          <div style="background: rgba(6, 182, 212, 0.1); border: 1px solid rgba(6, 182, 212, 0.2); border-radius: 10px; padding: 12px; margin-bottom: 16px;">
            <span id="estimatedTime" style="color: var(--accent);">Masukkan nomor untuk melihat estimasi</span>
          </div>

          <button type="submit">Start Broadcast</button>
        </form>

        <div class="log" id="broadcastResult" style="margin-top: 16px;"></div>
      </div>
    </div>

    <!-- Broadcast Jobs View -->
    <div id="view-jobs" class="view">
      <div class="page-header">
        <h2 class="page-title">Broadcast Jobs</h2>
        <p class="page-subtitle">Monitor your broadcast jobs</p>
      </div>

      <div class="card">
        <h3 class="card-title">üîç Filter Jobs</h3>
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 12px;">
          <div>
            <label>Filter Type</label>
            <select id="jobFilterType">
              <option value="all">All Jobs (All Sessions)</option>
              <option value="session">Specific Session</option>
            </select>
          </div>
          <div id="jobSessionFilter" style="display: none;">
            <label>Session</label>
            <select id="jobsSessionSelect"></select>
          </div>
          <div>
            <label>Start Date</label>
            <input type="date" id="jobStartDate">
          </div>
          <div>
            <label>End Date</label>
            <input type="date" id="jobEndDate">
          </div>
          <div>
            <label>Limit</label>
            <select id="jobLimit">
              <option value="50">Last 50</option>
              <option value="100" selected>Last 100</option>
              <option value="500">Last 500</option>
              <option value="">All</option>
            </select>
          </div>
        </div>
        <div class="btn-group">
          <button type="button" id="applyJobFilter" class="btn-ghost" style="width: auto;">Apply Filter</button>
          <button type="button" id="resetJobFilter" class="btn-ghost" style="width: auto;">Reset</button>
          <button type="button" id="refreshJobs" class="btn-ghost" style="width: auto;">üîÑ Refresh</button>
        </div>
      </div>

      <div class="card">
        <h3 class="card-title">üìã Jobs (<span id="jobCount">0</span>)</h3>
        <div class="job-list" id="jobList">No jobs yet.</div>
      </div>
    </div>

    <!-- Job Detail View -->
    <div id="view-job-detail" class="view">
      <div class="page-header">
        <h2 class="page-title">Job Detail: <span id="jobDetailId">-</span></h2>
        <p class="page-subtitle">
          Status: <span id="jobDetailStatus" class="status-badge">-</span> |
          Phase: <span id="jobDetailPhase">-</span>
        </p>
      </div>

      <div class="card">
        <h3 class="card-title">üìä Job Statistics</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-content">
              <div class="stat-label">Sent</div>
              <div class="stat-value" id="jobDetailSent">0</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚è≠Ô∏è</div>
            <div class="stat-content">
              <div class="stat-label">Skipped</div>
              <div class="stat-value" id="jobDetailSkipped">0</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">‚ùå</div>
            <div class="stat-content">
              <div class="stat-label">Failed</div>
              <div class="stat-value" id="jobDetailFailed">0</div>
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">üìä</div>
            <div class="stat-content">
              <div class="stat-label">Total</div>
              <div class="stat-value" id="jobDetailTotal">0</div>
            </div>
          </div>
        </div>

        <div style="margin-top: 16px; display: flex; gap: 8px; flex-wrap: wrap;">
          <button type="button" id="exportJobResults" class="btn-ghost">üì• Export Results (CSV)</button>
          <button type="button" id="backToJobs" class="btn-ghost">‚Üê Back to Jobs</button>
        </div>
      </div>

      <div class="card">
        <h3 class="card-title">üìù Detailed Results</h3>
        <div style="margin-bottom: 12px;">
          <input type="text" id="jobResultsFilter" placeholder="Filter by phone number..." style="max-width: 300px;">
        </div>
        <div class="job-list" id="jobResultsList" style="max-height: 500px;">
          Loading job details...
        </div>
      </div>
    </div>
  </main>

  <script>
    const socket = io();

    // State management
    const state = {
      sessions: {},
      qrMap: {},
      activeSession: null,
      jobs: {},
      currentJobId: null,
      currentView: 'dashboard'
    };

    // Navigation
    function navigateTo(viewId, sessionId = null) {
      // Hide all views
      document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));

      // Update nav items (only for main nav items)
      if (['dashboard', 'sessions', 'send-message', 'broadcast', 'jobs'].includes(viewId)) {
        document.querySelectorAll('.nav-item').forEach(item => {
          item.classList.remove('active');
          if (item.dataset.view === viewId) {
            item.classList.add('active');
          }
        });
      }

      // Show target view
      let targetView = document.getElementById(`view-${viewId}`);
      if (viewId === 'session-detail' && sessionId) {
        state.activeSession = sessionId;
        updateSessionDetailView();
        targetView = document.getElementById('view-session-detail');
      } else if (viewId === 'job-detail') {
        // Job detail view is already populated by viewJobDetail function
        targetView = document.getElementById('view-job-detail');
      }

      if (targetView) {
        targetView.classList.add('active');
        state.currentView = viewId;
      }

      // Close mobile menu
      document.getElementById('sidebar').classList.remove('open');

      // Update session selects
      updateAllSessionSelects();

      // Load jobs if needed
      if (viewId === 'jobs') {
        // Load all jobs by default with current filter
        applyCurrentJobFilter();
      }
    }

    // Hash-based routing
    function handleHashChange() {
      const hash = window.location.hash.slice(1) || 'dashboard';

      // Handle session-detail route with parameter
      if (hash.startsWith('session-detail/')) {
        const sessionId = hash.split('/')[1];
        navigateTo('session-detail', sessionId);
      } else {
        navigateTo(hash);
      }
    }

    window.addEventListener('hashchange', handleHashChange);

    // Mobile menu toggle
    document.getElementById('mobileMenuToggle').addEventListener('click', () => {
      document.getElementById('sidebar').classList.toggle('open');
    });

    // Initialize navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        e.preventDefault();
        const view = item.dataset.view;
        window.location.hash = view;
      });
    });

    // API helper
    async function postJson(url, body) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body),
      });
      const data = await res.json();
      if (!res.ok) throw new Error(data.error || 'Request failed');
      return data;
    }

    // Update session select elements
    function updateAllSessionSelects() {
      const selects = ['sendSessionSelect', 'broadcastSessionSelect', 'jobsSessionSelect'];
      selects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (!select) return;

        const currentValue = select.value;
        select.innerHTML = '';

        Object.keys(state.sessions).forEach(sessionId => {
          const opt = document.createElement('option');
          opt.value = sessionId;
          opt.textContent = sessionId;
          select.appendChild(opt);
        });

        if (currentValue && Object.keys(state.sessions).includes(currentValue)) {
          select.value = currentValue;
        } else if (Object.keys(state.sessions).length > 0 && !state.activeSession) {
          state.activeSession = Object.keys(state.sessions)[0];
          select.value = state.activeSession;
        } else if (state.activeSession) {
          select.value = state.activeSession;
        }
      });
    }

    // Dashboard stats update
    function updateDashboardStats() {
      const sessions = Object.values(state.sessions);
      const connected = sessions.filter(s => s.state === 'open').length;
      const jobs = Object.values(state.jobs).filter(j => j.status === 'running' || j.status === 'queued').length;

      document.getElementById('stat-total-sessions').textContent = sessions.length;
      document.getElementById('stat-connected').textContent = connected;
      document.getElementById('stat-active-jobs').textContent = jobs;

      // Calculate total messages sent
      let totalSent = 0;
      Object.values(state.jobs).forEach(job => {
        totalSent += job.totals?.sent || 0;
      });
      document.getElementById('stat-messages-sent').textContent = totalSent;

      // Update session overview
      const overviewDiv = document.getElementById('dashboard-sessions');
      if (sessions.length === 0) {
        overviewDiv.innerHTML = '<p style="color: var(--muted);">No sessions yet. Create one to get started.</p>';
      } else {
        overviewDiv.innerHTML = sessions.map(s => `
          <div class="session-item ${s.state === 'open' ? 'active' : ''}" onclick="window.location.hash='session-detail/${s.id}'">
            <div class="session-item-info">
              <div class="session-item-name">${s.id}</div>
              <div class="session-item-status">
                <span class="status-dot ${s.state === 'open' ? 'connected' : s.state === 'qr' ? 'qr' : 'disconnected'}"></span>
                ${s.state === 'open' ? 'Connected' : s.state === 'qr' ? 'QR Available' : 'Disconnected'} ${s.user?.id ? `- ${s.user.id}` : ''}
              </div>
            </div>
            <span style="font-size: 20px;">‚Üí</span>
          </div>
        `).join('');
      }
    }

    // Update session detail view
    function updateSessionDetailView() {
      const session = state.sessions[state.activeSession];
      if (!session) return;

      document.getElementById('session-detail-name').textContent = state.activeSession;

      const statusDot = document.getElementById('session-status-dot');
      const statusText = document.getElementById('session-status-text');
      const userBadge = document.getElementById('session-user-badge');

      const statusMap = {
        open: { class: 'connected', text: 'Connected' },
        qr: { class: 'qr', text: 'QR Available' },
        close: { class: 'disconnected', text: 'Disconnected' },
        connecting: { class: 'qr', text: 'Connecting...' },
        starting: { class: 'qr', text: 'Starting...' },
      };

      const statusInfo = statusMap[session.state] || { class: 'disconnected', text: session.state || 'Unknown' };
      statusDot.className = `status-dot ${statusInfo.class}`;
      statusText.textContent = statusInfo.text;
      userBadge.textContent = `User: ${session.user?.id || '-'}`;

      // Handle QR
      const qr = state.qrMap[state.activeSession];
      if (session.hasQR && qr) {
        document.getElementById('qrPlaceholder').style.display = 'none';
        document.getElementById('qrCanvas').style.display = 'block';
        QRCode.toCanvas(document.getElementById('qrCanvas'), qr, { width: 280 }, (err) => {
          if (err) console.error(err);
        });
      } else {
        document.getElementById('qrPlaceholder').style.display = 'block';
        document.getElementById('qrCanvas').style.display = 'none';
      }
    }

    // Update sessions list view
    function updateSessionsListView() {
      const listDiv = document.getElementById('sessions-list');
      const sessions = Object.values(state.sessions);

      if (sessions.length === 0) {
        listDiv.innerHTML = '<p style="color: var(--muted);">No sessions yet.</p>';
        return;
      }

      listDiv.innerHTML = sessions.map(s => `
        <div class="session-item ${state.activeSession === s.id ? 'active' : ''}" onclick="state.activeSession = '${s.id}'; window.location.hash='session-detail/${s.id}'">
          <div class="session-item-info">
            <div class="session-item-name">${s.id}</div>
            <div class="session-item-status">
              <span class="status-dot ${s.state === 'open' ? 'connected' : s.state === 'qr' ? 'qr' : 'disconnected'}"></span>
              ${s.state === 'open' ? 'Connected' : s.state === 'qr' ? 'QR Available' : 'Disconnected'} ${s.user?.id ? `- ${s.user.id}` : ''}
            </div>
          </div>
          <span style="font-size: 20px;">‚Üí</span>
        </div>
      `).join('');
    }

    // Socket event handlers
    socket.on('qr', ({ sessionId, qr }) => {
      state.qrMap[sessionId] = qr;
      state.sessions[sessionId] = { ...(state.sessions[sessionId] || {}), id: sessionId, hasQR: true };
      if (!state.activeSession) state.activeSession = sessionId;

      if (state.currentView === 'session-detail' && state.activeSession === sessionId) {
        updateSessionDetailView();
      }

      updateDashboardStats();
      updateSessionsListView();
    });

    socket.on('status', (data) => {
      const { sessionId, ...rest } = data;
      state.sessions[sessionId] = { ...(state.sessions[sessionId] || {}), id: sessionId, ...rest };

      if (state.currentView === 'session-detail' && state.activeSession === sessionId) {
        updateSessionDetailView();
      }

      updateDashboardStats();
      updateSessionsListView();
    });

    // Create session
    document.getElementById('createSessionBtn').addEventListener('click', async () => {
      const val = document.getElementById('newSessionId').value.trim();
      const log = document.getElementById('sessionCreateLog');
      if (!val) {
        log.textContent = 'Session ID required';
        return;
      }
      log.textContent = 'Creating session...';
      try {
        await postJson('/sessions', { id: val });
        log.textContent = `Session "${val}" created! Redirecting...`;
        setTimeout(() => {
          state.activeSession = val;
          window.location.hash = `session-detail/${val}`;
        }, 1000);
      } catch (err) {
        log.textContent = `Error: ${err.message}`;
      }
    });

    // Logout session
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      const log = document.getElementById('sessionActionLog');
      try {
        await postJson(`/sessions/${state.activeSession}/logout`, {});
        state.qrMap[state.activeSession] = null;
        log.textContent = 'Logged out. Please scan the new QR code.';
      } catch (err) {
        log.textContent = `Error: ${err.message}`;
      }
    });

    // Delete session
    document.getElementById('deleteSessionBtn').addEventListener('click', async () => {
      if (!confirm('Are you sure you want to remove this session?')) return;
      const log = document.getElementById('sessionActionLog');
      try {
        await fetch(`/sessions/${state.activeSession}`, { method: 'DELETE' }).then(r => r.json());
        delete state.sessions[state.activeSession];
        delete state.qrMap[state.activeSession];
        log.textContent = 'Session removed. Redirecting...';
        setTimeout(() => {
          window.location.hash = 'sessions';
        }, 1000);
      } catch (err) {
        log.textContent = `Error: ${err.message || 'Failed to remove session'}`;
      }
    });

    // Send single message
    document.getElementById('sendForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sessionId = document.getElementById('sendSessionSelect').value;
      if (!sessionId) {
        document.getElementById('sendResult').textContent = 'Please select a session first';
        return;
      }

      const number = document.getElementById('sendNumber').value.trim();
      const message = document.getElementById('sendMessage').value.trim();
      const log = document.getElementById('sendResult');
      log.textContent = 'Sending...';

      try {
        const res = await postJson(`/sessions/${sessionId}/send`, { number, message });
        log.textContent = `‚úì Message sent successfully!\n${JSON.stringify(res, null, 2)}`;

        // Update stats
        let totalSent = parseInt(document.getElementById('stat-messages-sent').textContent) || 0;
        document.getElementById('stat-messages-sent').textContent = totalSent + 1;
      } catch (err) {
        log.textContent = `‚úó Error: ${err.message}`;
      }
    });

    // Broadcast message
    document.getElementById('broadcastForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const sessionId = document.getElementById('broadcastSessionSelect').value;
      if (!sessionId) {
        document.getElementById('broadcastResult').textContent = 'Please select a session first';
        return;
      }

      let numbers = [];
      let messageTemplate = document.getElementById('broadcastMessage').value.trim();
      const delayMin = parseInt(document.getElementById('delayMin').value) || 3000;
      const delayMax = parseInt(document.getElementById('delayMax').value) || 8000;
      const cooldownAfter = parseInt(document.getElementById('cooldownAfter').value) || 30;
      const cooldownMin = parseInt(document.getElementById('cooldownMin').value) || 120000;
      const cooldownMax = parseInt(document.getElementById('cooldownMax').value) || 300000;

      const log = document.getElementById('broadcastResult');

      // Get numbers based on input method
      if (inputMethod === 'csv') {
        if (csvData.length === 0) {
          log.textContent = '‚úó Upload CSV file dulu!';
          return;
        }

        // Check if message has personalization
        const hasPersonalization = messageTemplate.includes('{name}') && csvData.some(d => d.name);

        if (hasPersonalization) {
          // Use new personalized broadcast endpoint
          log.textContent = '‚ö†Ô∏è Memulai personalized broadcast...\nMohon tunggu...';

          try {
            const res = await postJson(`/sessions/${sessionId}/broadcast-personalized`, {
              csvData: csvData,
              messageTemplate: messageTemplate,
              delayMinMs: delayMin,
              delayMaxMs: delayMax,
              cooldownAfter: cooldownAfter,
              cooldownMinMs: cooldownMin,
              cooldownMaxMs: cooldownMax,
            });
            log.textContent = `‚úì Personalized broadcast job queued!\nJob ID: ${res.jobId}\nTotal: ${res.totals.total}`;
            state.currentJobId = res.jobId;
            pollJob(res.jobId, sessionId, log);
          } catch (err) {
            log.textContent = `‚úó Error: ${err.message}`;
          }
          return;
        } else {
          // No personalization, just send to all numbers
          numbers = csvData.map(d => d.phone);
        }
      } else {
        // Manual input
        const numbersRaw = document.getElementById('broadcastNumbers').value.trim();
        numbers = numbersRaw.split(/\r?\n/).map(n => n.trim()).filter(Boolean);
      }

      if (numbers.length === 0) {
        log.textContent = '‚úó Masukkan nomor tujuan!';
        return;
      }

      log.textContent = 'Queuing broadcast job...';

      try {
        const res = await postJson(`/sessions/${sessionId}/broadcast`, {
          numbers,
          message: messageTemplate,
          delayMinMs: delayMin,
          delayMaxMs: delayMax,
          cooldownAfter,
          cooldownMinMs: cooldownMin,
          cooldownMaxMs: cooldownMax,
        });
        log.textContent = `‚úì Broadcast job queued!\nJob ID: ${res.jobId}\nTotal numbers: ${res.totals.total}`;
        state.currentJobId = res.jobId;
        pollJob(res.jobId, sessionId, log);
      } catch (err) {
        log.textContent = `‚úó Error: ${err.message}`;
      }
    });

    // Poll job status
    async function pollJob(jobId, sessionId, logEl) {
      const poll = async () => {
        try {
          const res = await fetch(`/sessions/${sessionId}/broadcast/${jobId}`).then(r => r.json());
          const job = res.job;
          state.jobs[job.id] = job;
          renderJobList();

          const jobSummary = `Status: ${job.status}\nSent: ${job.totals.sent}/${job.totals.total}\nSkipped: ${job.totals.skipped}\nFailed: ${job.totals.failed}`;
          logEl.textContent = jobSummary;

          if (job.status === 'completed' || job.status === 'failed' || job.status === 'cancelled') {
            updateDashboardStats();
            return;
          }
          setTimeout(poll, 1000);
        } catch (err) {
          logEl.textContent = `Error polling job: ${err.message}`;
        }
      };
      poll();
    }

    // Fetch jobs for session
    async function fetchJobsForSession(sessionId) {
      try {
        const data = await fetch(`/sessions/${sessionId}/broadcast`).then(r => r.json());
        (data.jobs || []).forEach(j => { state.jobs[j.id] = j; });
        renderJobList();
      } catch (err) {
        console.error('Failed to fetch jobs', err);
      }
    }

    // Fetch all jobs with filters
    async function fetchAllJobs(filters = {}) {
      try {
        const params = new URLSearchParams();
        if (filters.startDate) params.append('startDate', filters.startDate);
        if (filters.endDate) params.append('endDate', filters.endDate);
        if (filters.limit) params.append('limit', filters.limit);

        const url = `/jobs${params.toString() ? '?' + params.toString() : ''}`;
        const data = await fetch(url).then(r => r.json());

        // Update state with jobs
        (data.jobs || []).forEach(j => { state.jobs[j.id] = j; });

        // If filtering by session, also filter the rendered list
        let jobsToRender = data.jobs || [];
        if (filters.sessionId) {
          jobsToRender = jobsToRender.filter(j => j.sessionId === filters.sessionId);
        }

        renderJobList(jobsToRender);
      } catch (err) {
        console.error('Failed to fetch jobs', err);
      }
    }

    // Render job list
    function renderJobList(jobListParam = null) {
      const target = document.getElementById('jobList');

      // Use provided list or default to state
      const list = jobListParam || Object.values(state.jobs).sort((a, b) =>
        (b.startedAt || b.requestedAt || 0) - (a.startedAt || a.requestedAt || 0)
      );

      // Update job count
      document.getElementById('jobCount').textContent = list.length;

      if (!list.length) {
        target.innerHTML = '<p style="color: var(--muted);">No jobs yet.</p>';
        return;
      }

      target.innerHTML = list.map(j => {
        const totals = j.totals || { sent: 0, skipped: 0, failed: 0, total: 0 };
        const phase = j.phase || j.status;
        const statusClass = j.status === 'completed' ? 'success' : j.status === 'failed' ? 'error' : 'warning';
        const next = j.nextResumeAt ? `<br><small style="color: var(--muted);">Cooldown until ${new Date(j.nextResumeAt).toLocaleTimeString()}</small>` : '';

        // Format date
        const date = new Date(j.completedAt || j.startedAt || j.requestedAt);
        const dateStr = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' });

        return `
          <div class="job-item" style="cursor: pointer;" onclick="viewJobDetail('${j.id}', '${j.sessionId}')">
            <div class="job-item-header">
              <span class="job-item-id">${j.id.substring(0, 8)}...</span>
              <span class="status-badge ${statusClass}">${j.status} (${phase})</span>
              <span style="font-size: 12px; color: var(--muted); margin-left: auto;">${dateStr}</span>
            </div>
            <div class="job-item-stats">
              <div class="job-stat">
                <div class="job-stat-label">Sent</div>
                <div class="job-stat-value">${totals.sent}</div>
              </div>
              <div class="job-stat">
                <div class="job-stat-label">Skipped</div>
                <div class="job-stat-value">${totals.skipped}</div>
              </div>
              <div class="job-stat">
                <div class="job-stat-label">Failed</div>
                <div class="job-stat-value">${totals.failed}</div>
              </div>
              <div class="job-stat">
                <div class="job-stat-label">Total</div>
                <div class="job-stat-value">${totals.total}</div>
              </div>
            </div>
            ${next}
            <div style="margin-top: 8px; font-size: 12px; color: var(--muted);">Session: ${j.sessionId} | Click to view details ‚Üí</div>
          </div>
        `;
      }).join('');
    }

    // View job detail
    let currentJob = null;

    window.viewJobDetail = async function(jobId, sessionId) {
      try {
        const res = await fetch(`/sessions/${sessionId}/broadcast/${jobId}`).then(r => r.json());
        currentJob = res.job;
        state.jobs[jobId] = currentJob;

        // Update UI
        document.getElementById('jobDetailId').textContent = jobId.substring(0, 8) + '...';
        document.getElementById('jobDetailStatus').textContent = currentJob.status;
        document.getElementById('jobDetailPhase').textContent = currentJob.phase || currentJob.status;

        const statusClass = currentJob.status === 'completed' ? 'success' :
                          currentJob.status === 'failed' ? 'error' : 'warning';
        document.getElementById('jobDetailStatus').className = `status-badge ${statusClass}`;

        const totals = currentJob.totals || { sent: 0, skipped: 0, failed: 0, total: 0 };
        document.getElementById('jobDetailSent').textContent = totals.sent;
        document.getElementById('jobDetailSkipped').textContent = totals.skipped;
        document.getElementById('jobDetailFailed').textContent = totals.failed;
        document.getElementById('jobDetailTotal').textContent = totals.total;

        renderJobResults(currentJob.results || []);

        // Show job detail view
        navigateTo('job-detail');
      } catch (err) {
        console.error('Failed to load job details:', err);
        alert('Failed to load job details');
      }
    };

    // Render job results
    function renderJobResults(results, filter = '') {
      const target = document.getElementById('jobResultsList');

      if (!results || results.length === 0) {
        target.innerHTML = '<p style="color: var(--muted);">No results yet.</p>';
        return;
      }

      // Filter results
      let filteredResults = results;
      if (filter) {
        filteredResults = results.filter(r =>
          r.number && r.number.includes(filter)
        );
      }

      target.innerHTML = `
        <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
          <thead>
            <tr style="border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.02);">
              <th style="text-align: left; padding: 10px; position: sticky; top: 0; background: #0f172a;">#</th>
              <th style="text-align: left; padding: 10px; position: sticky; top: 0; background: #0f172a;">Phone</th>
              <th style="text-align: left; padding: 10px; position: sticky; top: 0; background: #0f172a;">Status</th>
              <th style="text-align: left; padding: 10px; position: sticky; top: 0; background: #0f172a;">Info</th>
            </tr>
          </thead>
          <tbody>
            ${filteredResults.map((r, i) => {
              const statusClass = r.status === 'sent' ? 'success' :
                                r.status === 'failed' ? 'error' : 'warning';
              const statusIcon = r.status === 'sent' ? '‚úÖ' :
                               r.status === 'failed' ? '‚ùå' : '‚è≠Ô∏è';
              return `
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                  <td style="padding: 10px;">${i + 1}</td>
                  <td style="padding: 10px; font-family: monospace;">${r.number || '-'}</td>
                  <td style="padding: 10px;">
                    <span class="status-badge ${statusClass}">${statusIcon} ${r.status}</span>
                  </td>
                  <td style="padding: 10px; color: var(--muted); max-width: 300px; word-wrap: break-word;">
                    ${r.reason || r.error || '-'}
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
        <div style="margin-top: 12px; color: var(--muted); font-size: 13px;">
          Showing ${filteredResults.length} of ${results.length} results
        </div>
      `;
    }

    // Setup job detail view handlers
    function setupJobDetailHandlers() {
      // Back to jobs button
      document.getElementById('backToJobs')?.addEventListener('click', () => {
        window.location.hash = 'jobs';
      });

      // Filter type change
      document.getElementById('jobFilterType')?.addEventListener('change', (e) => {
        const sessionFilter = document.getElementById('jobSessionFilter');
        if (e.target.value === 'session') {
          sessionFilter.style.display = 'block';
        } else {
          sessionFilter.style.display = 'none';
        }
      });

      // Apply filter button
      document.getElementById('applyJobFilter')?.addEventListener('click', async () => {
        const filterType = document.getElementById('jobFilterType').value;
        const sessionId = document.getElementById('jobsSessionSelect').value;
        const startDate = document.getElementById('jobStartDate').value;
        const endDate = document.getElementById('jobEndDate').value;
        const limit = document.getElementById('jobLimit').value;

        const filters = {};
        if (startDate) filters.startDate = startDate;
        if (endDate) filters.endDate = endDate;
        if (limit) filters.limit = limit;
        if (filterType === 'session') filters.sessionId = sessionId;

        await fetchAllJobs(filters);
      });

      // Reset filter button
      document.getElementById('resetJobFilter')?.addEventListener('click', async () => {
        document.getElementById('jobFilterType').value = 'all';
        document.getElementById('jobSessionFilter').style.display = 'none';
        document.getElementById('jobStartDate').value = '';
        document.getElementById('jobEndDate').value = '';
        document.getElementById('jobLimit').value = '100';

        await fetchAllJobs({ limit: 100 });
      });

      // Refresh jobs button
      document.getElementById('refreshJobs')?.addEventListener('click', async () => {
        await applyCurrentJobFilter();
      });

      // Export job results
      document.getElementById('exportJobResults')?.addEventListener('click', () => {
        if (!currentJob || !currentJob.results) {
          alert('No results to export');
          return;
        }

        const results = currentJob.results;
        const csv = 'phone,status,reason,error\n' +
          results.map(r =>
            `${r.number || ''},${r.status || ''},"${r.reason || ''}","${r.error || ''}"`
          ).join('\n');

        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `broadcast_results_${currentJob.id.substring(0, 8)}_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        URL.revokeObjectURL(url);
      });

      // Filter job results
      document.getElementById('jobResultsFilter')?.addEventListener('input', (e) => {
        const filter = e.target.value.trim();
        if (currentJob && currentJob.results) {
          renderJobResults(currentJob.results, filter);
        }
      });
    }

    // Helper to apply current filter
    async function applyCurrentJobFilter() {
      const filterType = document.getElementById('jobFilterType').value;
      const sessionId = document.getElementById('jobsSessionSelect').value;
      const startDate = document.getElementById('jobStartDate').value;
      const endDate = document.getElementById('jobEndDate').value;
      const limit = document.getElementById('jobLimit').value;

      const filters = {};
      if (startDate) filters.startDate = startDate;
      if (endDate) filters.endDate = endDate;
      if (limit) filters.limit = limit;
      if (filterType === 'session') filters.sessionId = sessionId;

      await fetchAllJobs(filters);
    }

    // Broadcast job updates
    socket.on('broadcastUpdate', ({ sessionId, job }) => {
      state.jobs[job.id] = job;
      if (state.currentView === 'jobs') {
        renderJobList();
      }
      updateDashboardStats();
    });

    // Session removed
    socket.on('sessionRemoved', ({ sessionId }) => {
      delete state.sessions[sessionId];
      delete state.qrMap[sessionId];
      if (state.activeSession === sessionId) {
        state.activeSession = Object.keys(state.sessions)[0] || null;
      }
      updateDashboardStats();
      updateSessionsListView();
      updateAllSessionSelects();
    });

    // Session select change handlers
    document.getElementById('jobsSessionSelect')?.addEventListener('change', (e) => {
      // Filter will be applied when user clicks "Apply Filter"
      // or automatically if in session filter mode
      const filterType = document.getElementById('jobFilterType')?.value;
      if (filterType === 'session') {
        applyCurrentJobFilter();
      }
    });

    document.getElementById('sendSessionSelect')?.addEventListener('change', (e) => {
      state.activeSession = e.target.value;
    });

    document.getElementById('broadcastSessionSelect')?.addEventListener('change', (e) => {
      state.activeSession = e.target.value;
    });

    // Broadcast preset configuration
    const PRESETS = {
      moderate: {
        delayMin: 3000,
        delayMax: 8000,
        cooldownAfter: 30,
        cooldownMin: 120000,
        cooldownMax: 300000,
        description: 'Simulasi behavior manusia natural. Speed: 3-8 detik/pesan. Cooldown setiap 30 pesan (2-5 menit). Risiko: Medium. Cocok untuk broadcast 50-200 nomor.'
      },
      conservative: {
        delayMin: 5000,
        delayMax: 15000,
        cooldownAfter: 20,
        cooldownMin: 180000,
        cooldownMax: 600000,
        description: 'Konfigurasi aman untuk broadcast besar. Speed: 5-15 detik/pesan. Cooldown setiap 20 pesan (3-10 menit). Risiko: Low. Cocok untuk broadcast 200-1000 nomor.'
      },
      'very-conservative': {
        delayMin: 10000,
        delayMax: 30000,
        cooldownAfter: 15,
        cooldownMin: 300000,
        cooldownMax: 900000,
        description: 'Sangat konservatif untuk nomor berharga. Speed: 10-30 detik/pesan. Cooldown setiap 15 pesan (5-15 menit). Risiko: Very Low. Cocok untuk >1000 nomor atau nomor business penting.'
      },
      custom: {
        delayMin: 3000,
        delayMax: 8000,
        cooldownAfter: 30,
        cooldownMin: 120000,
        cooldownMax: 300000,
        description: 'Konfigurasi manual sesuai kebutuhan. Bebas mengatur semua parameter. Pastikan understand risiko sebelum mengubah.'
      }
    };

    // Handle preset change
    const broadcastPreset = document.getElementById('broadcastPreset');
    const presetDescription = document.getElementById('presetDescription');
    const delayMinInput = document.getElementById('delayMin');
    const delayMaxInput = document.getElementById('delayMax');
    const cooldownAfterInput = document.getElementById('cooldownAfter');
    const cooldownMinInput = document.getElementById('cooldownMin');
    const cooldownMaxInput = document.getElementById('cooldownMax');

    function applyPreset(preset) {
      const config = PRESETS[preset];
      if (!config) return;

      delayMinInput.value = config.delayMin;
      delayMaxInput.value = config.delayMax;
      cooldownAfterInput.value = config.cooldownAfter;
      cooldownMinInput.value = config.cooldownMin;
      cooldownMaxInput.value = config.cooldownMax;
      presetDescription.textContent = config.description;

      // Enable/disable cooldown inputs based on preset
      const isCustom = preset === 'custom';
      cooldownMinInput.disabled = !isCustom;
      cooldownMaxInput.disabled = !isCustom;

      // Update estimated time
      updateEstimatedTime();
    }

    // Calculate and display estimated broadcast time
    function updateEstimatedTime() {
      let numbersCount = 0;

      if (inputMethod === 'csv') {
        numbersCount = csvData.length;
      } else {
        const numbersRaw = document.getElementById('broadcastNumbers').value.trim();
        numbersCount = numbersRaw ? numbersRaw.split(/\r?\n/).filter(Boolean).length : 0;
      }

      if (numbersCount === 0) {
        document.getElementById('estimatedTime').textContent = 'Masukkan nomor untuk melihat estimasi';
        return;
      }

      const delayMin = parseInt(delayMinInput.value) || 3000;
      const delayMax = parseInt(delayMaxInput.value) || 8000;
      const cooldownAfter = parseInt(cooldownAfterInput.value) || 30;
      const cooldownMin = parseInt(cooldownMinInput.value) || 120000;
      const cooldownMax = parseInt(cooldownMaxInput.value) || 300000;

      // Calculate estimated time
      const avgDelay = (delayMin + delayMax) / 2;
      const avgCooldown = (cooldownMin + cooldownMax) / 2;
      const cooldownCount = Math.floor(numbersCount / cooldownAfter);
      const totalDelayMs = (numbersCount * avgDelay) + (cooldownCount * avgCooldown);

      const hours = Math.floor(totalDelayMs / 3600000);
      const minutes = Math.floor((totalDelayMs % 3600000) / 60000);
      const seconds = Math.floor((totalDelayMs % 60000) / 1000);

      let timeString = '';
      if (hours > 0) timeString += `${hours} jam `;
      if (minutes > 0) timeString += `${minutes} menit `;
      if (seconds > 0 || timeString === '') timeString += `${seconds} detik`;

      document.getElementById('estimatedTime').innerHTML =
        `<strong>Estimasi waktu:</strong> ${timeString} untuk ${numbersCount} nomor`;
    }

    // Add event listeners for real-time estimation
    document.getElementById('broadcastNumbers')?.addEventListener('input', updateEstimatedTime);
    delayMinInput?.addEventListener('input', updateEstimatedTime);
    delayMaxInput?.addEventListener('input', updateEstimatedTime);
    cooldownAfterInput?.addEventListener('input', updateEstimatedTime);
    cooldownMinInput?.addEventListener('input', updateEstimatedTime);
    cooldownMaxInput?.addEventListener('input', updateEstimatedTime);

    broadcastPreset?.addEventListener('change', (e) => {
      applyPreset(e.target.value);
    });

    // CSV Broadcast handling
    let csvData = [];
    let inputMethod = 'manual';

    // Method switching
    function setupMethodButtons() {
      const methodManualBtn = document.getElementById('methodManual');
      const methodCsvBtn = document.getElementById('methodCsv');

      if (!methodManualBtn || !methodCsvBtn) {
        console.log('Method buttons not found yet');
        return;
      }

      methodManualBtn.addEventListener('click', () => {
        inputMethod = 'manual';
        document.getElementById('manualInput').style.display = 'block';
        document.getElementById('csvInput').style.display = 'none';
        methodManualBtn.style.background = 'var(--accent)';
        methodManualBtn.style.color = 'var(--bg)';
        methodCsvBtn.style.background = 'transparent';
        methodCsvBtn.style.color = 'var(--muted)';
        document.getElementById('personalizationHelper').style.display = 'none';
        updateEstimatedTime();
      });

      methodCsvBtn.addEventListener('click', () => {
        inputMethod = 'csv';
        document.getElementById('manualInput').style.display = 'none';
        document.getElementById('csvInput').style.display = 'block';
        methodCsvBtn.style.background = 'var(--accent)';
        methodCsvBtn.style.color = 'var(--bg)';
        methodManualBtn.style.background = 'transparent';
        methodManualBtn.style.color = 'var(--muted)';
      });

      // Initialize manual button state
      methodManualBtn.click();
    }

    // Download CSV Template
    function setupDownloadTemplate() {
      const downloadBtn = document.getElementById('downloadTemplate');
      if (!downloadBtn) return;

      downloadBtn.addEventListener('click', () => {
        const template = 'phone,name\n6281234567890,Budi Santoso\n6289876543210,Siti Wijaya\n6285555555555,Ahmad Rahman\n\n# Notes:\n# - Kolom "phone" WAJIB (format: country code + nomor)\n# - Kolom "name" OPSIONAL (untuk personalisasi pesan)\n# - Gunakan {name} dalam pesan untuk personalisasi';
        const blob = new Blob([template], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'broadcast_template.csv';
        a.click();
        URL.revokeObjectURL(url);
      });
    }

    // CSV File Upload Handler
    function setupCsvUpload() {
      const csvFileInput = document.getElementById('csvFile');
      if (!csvFileInput) return;

      csvFileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          const text = event.target.result;
          parseCSV(text);
        };
        reader.readAsText(file);
      });
    }

    // Preview CSV Handler
    function setupPreviewCsv() {
      const previewBtn = document.getElementById('previewCsv');
      if (!previewBtn) return;

      previewBtn.addEventListener('click', () => {
        if (csvData.length === 0) {
          alert('Upload CSV file dulu!');
          return;
        }

        const previewBody = document.getElementById('previewBody');
        const previewDiv = document.getElementById('csvPreview');

        // Show first 10 rows
        const preview = csvData.slice(0, 10);
        previewBody.innerHTML = preview.map((row, i) => `
          <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
            <td style="padding: 8px;">${i + 1}</td>
            <td style="padding: 8px;">${row.phone}</td>
            <td style="padding: 8px;">${row.name || '-'}</td>
          </tr>
        `).join('');

        document.getElementById('previewCount').textContent = csvData.length;
        previewDiv.style.display = 'block';

        // Show personalization helper if has names
        if (csvData.some(d => d.name)) {
          document.getElementById('personalizationHelper').style.display = 'block';
        }
      });
    }

    // Parse CSV
    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim() && !line.startsWith('#'));
      if (lines.length < 2) {
        alert('CSV tidak valid. Minimal harus ada header + 1 data.');
        return;
      }

      // Parse header
      const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
      const phoneIndex = headers.findIndex(h => h === 'phone' || h === 'nomor' || h === 'number' || h === 'whatsapp');
      const nameIndex = headers.findIndex(h => h === 'name' || h === 'nama' || h === 'nama');

      if (phoneIndex === -1) {
        alert('CSV harus punya kolom "phone"!');
        return;
      }

      // Parse data
      csvData = [];
      for (let i = 1; i < lines.length; i++) {
        const values = lines[i].split(',').map(v => v.trim());
        const phone = values[phoneIndex]?.replace(/\D/g, '');
        const name = nameIndex !== -1 ? values[nameIndex] : '';

        if (phone && phone.length >= 8) {
          csvData.push({ phone, name });
        }
      }

      // Show stats
      const validCount = csvData.length;
      const withName = csvData.filter(d => d.name).length;

      document.getElementById('csvStats').innerHTML =
        `‚úÖ Valid: ${validCount} contacts | üè∑Ô∏è Dengan nama: ${withName}`;

      updateEstimatedTime();
    }

    // Initialize with moderate preset
    applyPreset('moderate');

    // Initialize
    async function init() {
      // Load initial sessions
      try {
        const data = await fetch('/sessions').then(r => r.json());
        (data.sessions || []).forEach(s => {
          state.sessions[s.id] = { id: s.id, state: s.state, hasQR: s.hasQR, user: s.user };
        });

        if (data.sessions?.length) {
          state.activeSession = data.sessions[0].id;
        }

        updateAllSessionSelects();
        updateDashboardStats();
        updateSessionsListView();

        // Handle initial hash
        handleHashChange();

        // Setup CSV functionality after DOM is ready
        setupMethodButtons();
        setupDownloadTemplate();
        setupCsvUpload();
        setupPreviewCsv();
        setupJobDetailHandlers();
      } catch (err) {
        console.error('Failed to load sessions', err);
      }
    }

    init();
  </script>
</body>
</html>
